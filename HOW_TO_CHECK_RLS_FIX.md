# å¦‚ä½•æª¢æŸ¥ RLS ä¿®å¾©æ˜¯å¦ç”Ÿæ•ˆ

## ğŸ“‹ æª¢æŸ¥æ­¥é©Ÿ

### 1. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼

åœ¨çµ‚ç«¯æ©Ÿä¸­åŸ·è¡Œï¼š
```bash
npm run dev
```

### 2. ç™»å…¥æ‡‰ç”¨ç¨‹å¼

1. é–‹å•Ÿç€è¦½å™¨ï¼Œå‰å¾€ `http://localhost:3000`
2. ä½¿ç”¨æ‚¨çš„å¸³è™Ÿç™»å…¥ï¼ˆä¾‹å¦‚ï¼š`siriue0@gmail.com`ï¼‰

### 3. æŸ¥çœ‹çµ‚ç«¯æ©Ÿæ—¥èªŒ

åœ¨åŸ·è¡Œ `npm run dev` çš„çµ‚ç«¯æ©Ÿè¦–çª—ä¸­ï¼Œæ‚¨æœƒçœ‹åˆ°é¡ä¼¼ä»¥ä¸‹çš„æ—¥èªŒï¼š

#### âœ… å¦‚æœä¿®å¾©æˆåŠŸï¼Œæ‚¨æœƒçœ‹åˆ°ï¼š

```
ğŸ” æŸ¥è©¢ä½¿ç”¨è€…è³‡æ–™: {
  userId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  authUserId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  sessionUserId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  email: 'siriue0@gmail.com',
  hasAccessToken: true
}

ğŸ” RLS æŸ¥è©¢è¨ºæ–·: {
  userId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  returnedCount: 1,        // âœ… é€™æ˜¯ 1ï¼Œè¡¨ç¤ºæŸ¥è©¢æˆåŠŸ
  totalCount: 1,
  hasError: false,
  errorCode: undefined,
  errorMessage: undefined,
  diagnosis: 'âœ… æŸ¥è©¢æˆåŠŸ'  // âœ… é€™è¡¨ç¤ºå•é¡Œå·²è§£æ±º
}
```

**é—œéµæŒ‡æ¨™ï¼š**
- âœ… `returnedCount: 1` â†’ æŸ¥è©¢æˆåŠŸï¼Œè¿”å› 1 ç­†è¨˜éŒ„
- âœ… `diagnosis: 'âœ… æŸ¥è©¢æˆåŠŸ'` â†’ å•é¡Œå·²è§£æ±º
- âœ… **ä¸æœƒçœ‹åˆ°** "ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ RLS é™åˆ¶ï¼‰"
- âœ… **ä¸æœƒçœ‹åˆ°** "å˜—è©¦ä½¿ç”¨ Admin client"

#### âŒ å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨ï¼Œæ‚¨æœƒçœ‹åˆ°ï¼š

```
ğŸ” æŸ¥è©¢ä½¿ç”¨è€…è³‡æ–™: {
  userId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  authUserId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  sessionUserId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  email: 'siriue0@gmail.com',
  hasAccessToken: true
}

ğŸ” RLS æŸ¥è©¢è¨ºæ–·: {
  userId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  returnedCount: 0,        // âŒ é€™æ˜¯ 0ï¼Œè¡¨ç¤º RLS ä»ç„¶é˜»æ“‹
  totalCount: 0,
  hasError: false,
  errorCode: undefined,
  errorMessage: undefined,
  diagnosis: 'âŒ RLS é˜»æ“‹ï¼šauth.uid() å¯èƒ½è¿”å› NULLï¼ˆJWT token æœªæ­£ç¢ºå‚³éåˆ°è³‡æ–™åº«ï¼‰'  // âŒ å•é¡Œä»ç„¶å­˜åœ¨
}

ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ RLS é™åˆ¶ï¼‰ï¼Œå˜—è©¦ä½¿ç”¨ Admin client: {
  userId: '82eb6660-cc05-44f2-aa57-61ab33511d15',
  ...
  possibleIssue: 'RLS é˜»æ“‹ï¼šauth.uid() è¿”å› NULLï¼ˆJWT token æœªæ­£ç¢ºå‚³éåˆ°è³‡æ–™åº«å±¤é¢ï¼‰'
}

ä½¿ç”¨ Admin client æˆåŠŸæŸ¥è©¢åˆ°ä½¿ç”¨è€…è³‡æ–™
```

**é—œéµæŒ‡æ¨™ï¼š**
- âŒ `returnedCount: 0` â†’ RLS ä»ç„¶é˜»æ“‹
- âŒ `diagnosis: 'âŒ RLS é˜»æ“‹...'` â†’ å•é¡Œä»ç„¶å­˜åœ¨
- âŒ **æœƒçœ‹åˆ°** "ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ RLS é™åˆ¶ï¼‰"
- âŒ **æœƒçœ‹åˆ°** "å˜—è©¦ä½¿ç”¨ Admin client"

## ğŸ” å¦‚ä½•å¿«é€Ÿæª¢æŸ¥

### æ–¹æ³• 1ï¼šæœå°‹é—œéµå­—

åœ¨çµ‚ç«¯æ©Ÿä¸­ï¼Œæœå°‹ä»¥ä¸‹é—œéµå­—ï¼š

**æˆåŠŸæŒ‡æ¨™ï¼š**
- `returnedCount: 1`
- `âœ… æŸ¥è©¢æˆåŠŸ`
- æ²’æœ‰ "ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢å¤±æ•—"

**å¤±æ•—æŒ‡æ¨™ï¼š**
- `returnedCount: 0`
- `âŒ RLS é˜»æ“‹`
- "ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ RLS é™åˆ¶ï¼‰"

### æ–¹æ³• 2ï¼šæŸ¥çœ‹ç‰¹å®šé é¢

ç•¶æ‚¨ç€è¦½ä»¥ä¸‹é é¢æ™‚ï¼Œæœƒè§¸ç™¼ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢ï¼Œæ—¥èªŒæœƒå‡ºç¾åœ¨çµ‚ç«¯æ©Ÿï¼š

- `/dashboard` - ä¸»æ§å°
- `/dashboard/admin` - ç®¡ç†é é¢
- `/dashboard/admin/users` - ä½¿ç”¨è€…ç®¡ç†
- ä»»ä½•éœ€è¦ä½¿ç”¨è€…è³‡æ–™çš„é é¢

### æ–¹æ³• 3ï¼šä½¿ç”¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·

1. é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12 æˆ– Cmd+Option+Iï¼‰
2. å‰å¾€ Network æ¨™ç±¤
3. é‡æ–°æ•´ç†é é¢
4. æŸ¥çœ‹ API è«‹æ±‚æ˜¯å¦æˆåŠŸï¼ˆç‹€æ…‹ç¢¼ 200ï¼‰

## ğŸ“ æ—¥èªŒä½ç½®

æ‰€æœ‰æ—¥èªŒéƒ½æœƒå‡ºç¾åœ¨ï¼š
- **çµ‚ç«¯æ©Ÿè¦–çª—**ï¼ˆåŸ·è¡Œ `npm run dev` çš„åœ°æ–¹ï¼‰
- åªæœ‰åœ¨é–‹ç™¼æ¨¡å¼ï¼ˆ`NODE_ENV=development`ï¼‰æ‰æœƒé¡¯ç¤ºè©³ç´°æ—¥èªŒ

## âœ… ç¢ºèªæ¸…å–®

è«‹ç¢ºèªä»¥ä¸‹é …ç›®ï¼š

- [ ] å·²é‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ï¼ˆ`npm run dev`ï¼‰
- [ ] å·²ç™»å…¥æ‡‰ç”¨ç¨‹å¼
- [ ] å·²æŸ¥çœ‹çµ‚ç«¯æ©Ÿæ—¥èªŒ
- [ ] çœ‹åˆ° `returnedCount: 1` å’Œ `âœ… æŸ¥è©¢æˆåŠŸ`
- [ ] **æ²’æœ‰çœ‹åˆ°** "ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢å¤±æ•—" çš„è­¦å‘Š

## ğŸ› å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨

å¦‚æœä¿®å¾©å¾Œå•é¡Œä»ç„¶å­˜åœ¨ï¼ˆ`returnedCount: 0`ï¼‰ï¼Œè«‹ï¼š

1. **æª¢æŸ¥ cookies**
   - åœ¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ä¸­ï¼ŒæŸ¥çœ‹ Application â†’ Cookies
   - ç¢ºèªæ˜¯å¦æœ‰ Supabase ç›¸é—œçš„ cookiesï¼ˆä¾‹å¦‚ï¼š`sb-<project-ref>-auth-token`ï¼‰

2. **æª¢æŸ¥ JWT token**
   - åœ¨æ—¥èªŒä¸­ç¢ºèª `hasAccessToken: true`
   - å¦‚æœç‚º `false`ï¼Œè¡¨ç¤º JWT token æ²’æœ‰æ­£ç¢ºè¼‰å…¥

3. **æä¾›è¨ºæ–·è³‡è¨Š**
   - è¤‡è£½å®Œæ•´çš„ `ğŸ” RLS æŸ¥è©¢è¨ºæ–·` æ—¥èªŒ
   - æä¾›çµ¦é–‹ç™¼åœ˜éšŠé€²ä¸€æ­¥è¨ºæ–·

## ğŸ“ éœ€è¦å¹«åŠ©ï¼Ÿ

å¦‚æœä¿®å¾©å¾Œå•é¡Œä»ç„¶å­˜åœ¨ï¼Œè«‹æä¾›ï¼š
1. å®Œæ•´çš„ `ğŸ” RLS æŸ¥è©¢è¨ºæ–·` æ—¥èªŒ
2. æ˜¯å¦æœ‰çœ‹åˆ° "ä½¿ç”¨è€…è³‡æ–™æŸ¥è©¢å¤±æ•—" çš„è­¦å‘Š
3. `returnedCount` çš„å€¼ï¼ˆ0 æˆ– 1ï¼‰
