# RLS å•é¡Œæ·±åº¦è¨ºæ–·å ±å‘Š

## ğŸ” å•é¡Œç¾è±¡

å³ä½¿æ‰€æœ‰ session è³‡è¨Šéƒ½æ­£ç¢ºï¼š
- âœ… `authUserId` å’Œ `userId` åŒ¹é…
- âœ… `sessionUserId` åŒ¹é…
- âœ… `sessionExists: true`
- âœ… `hasAccessToken: true`

ä½†æŸ¥è©¢ä»ç„¶å¤±æ•—ï¼Œè¿”å› **PGRST116 éŒ¯èª¤**ï¼ˆ"Cannot coerce the result to a single JSON object"ï¼‰ã€‚

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### å•é¡Œ 1: createServerClient è¨­å®šå•é¡Œï¼ˆå·²ä¿®å¾©ï¼‰

**ç™¼ç¾ï¼š** `lib/supabase/server.ts` ä¸­è¨­å®šäº† `global.headers.Authorization`ï¼Œé€™å¯èƒ½å¹²æ“¾ JWT token å¾ cookies å‚³éåˆ°è³‡æ–™åº«ã€‚

**ä¿®å¾©ï¼š** å·²ç§»é™¤ `global.headers.Authorization`ï¼Œåªä¾è³´ cookies ä¾†å‚³é JWT tokenã€‚

### å•é¡Œ 2: RLS æ”¿ç­–åŸ·è¡Œæ™‚ auth.uid() è¿”å› NULL

**æ ¸å¿ƒå•é¡Œï¼š** å³ä½¿ session å­˜åœ¨ï¼Œåœ¨è³‡æ–™åº«å±¤é¢åŸ·è¡Œ RLS æ”¿ç­–æ™‚ï¼Œ`auth.uid()` å¯èƒ½è¿”å› NULLã€‚

**åŸå› ï¼š**
- JWT token æ²’æœ‰æ­£ç¢ºå¾ cookies å‚³éåˆ°è³‡æ–™åº«
- PostgreSQL çš„ `auth.uid()` å‡½å¼ç„¡æ³•å¾è«‹æ±‚ä¸­å–å¾—ä½¿ç”¨è€… ID
- ç•¶ `auth.uid() = id` ä¸­çš„ `auth.uid()` è¿”å› NULL æ™‚ï¼Œæ¢ä»¶çµæœç‚º NULLï¼ˆä¸æ˜¯ trueï¼‰ï¼ŒRLS æœƒé˜»æ“‹æŸ¥è©¢

## âœ… å·²åŸ·è¡Œçš„ä¿®å¾©

### 1. ä¿®å¾© createServerClient è¨­å®š

**ä¿®æ”¹å‰ï¼š**
```typescript
return createServerClient(supabaseUrl, supabaseAnonKey, {
  global: {
    headers: {
      Authorization: headersStore.get('Authorization') || '',
    },
  },
  cookies: { ... }
});
```

**ä¿®æ”¹å¾Œï¼š**
```typescript
// ç§»é™¤ global.headers.Authorization
// JWT token æ‡‰è©²åªå¾ cookies å‚³é
return createServerClient(supabaseUrl, supabaseAnonKey, {
  cookies: { ... }
});
```

### 2. å»ºç«‹æ¸¬è©¦ RLS æ”¿ç­–

å»ºç«‹äº†ä¸€å€‹æ¸¬è©¦æ”¿ç­–ä¾†è¨ºæ–·å•é¡Œï¼š
- æ”¿ç­–åç¨±ï¼š`è¨ºæ–·ï¼šæ¸¬è©¦ä½¿ç”¨è€…è®€å–è‡ªå·±çš„è³‡æ–™`
- æ¢ä»¶ï¼š`auth.uid() IS NOT NULL AND auth.uid() = id`

å¦‚æœé€™å€‹æ¸¬è©¦æ”¿ç­–å¯ä»¥é‹ä½œï¼Œè¡¨ç¤ºå•é¡Œåœ¨æ–¼åŸå§‹æ”¿ç­–çš„æ¢ä»¶ã€‚

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

1. **é‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼**
   ```bash
   npm run dev
   ```

2. **æ¸¬è©¦æŸ¥è©¢**
   - ç™»å…¥ä¸¦æª¢æŸ¥æ—¥èªŒ
   - å¦‚æœæ¸¬è©¦æ”¿ç­–å¯ä»¥é‹ä½œï¼Œè¡¨ç¤ºå•é¡Œåœ¨æ–¼ JWT token å‚³é
   - å¦‚æœæ¸¬è©¦æ”¿ç­–ä»ç„¶å¤±æ•—ï¼Œè¡¨ç¤ºå•é¡Œæ›´æ·±å±¤

3. **æª¢æŸ¥çµæœ**
   - å¦‚æœä¿®å¾©æˆåŠŸï¼Œæ‡‰è©²ä¸å†å‡ºç¾ PGRST116 éŒ¯èª¤
   - å¦‚æœä»ç„¶å¤±æ•—ï¼Œéœ€è¦é€²ä¸€æ­¥è¨ºæ–·

## ğŸ“‹ å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨

### é€²ä¸€æ­¥è¨ºæ–·é¸é …

1. **æª¢æŸ¥ cookies**
   - ç¢ºèª Supabase cookies æ˜¯å¦æ­£ç¢ºè¨­å®š
   - æª¢æŸ¥ cookie åç¨±æ˜¯å¦ç‚º `sb-<project-ref>-auth-token`

2. **æª¢æŸ¥ JWT token**
   - åœ¨æŸ¥è©¢å‰è¨˜éŒ„ JWT token
   - ç¢ºèª token æ˜¯å¦æœ‰æ•ˆä¸”æœªéæœŸ

3. **æš«æ™‚æ”¾å¯¬ RLS æ”¿ç­–ï¼ˆåƒ…ç”¨æ–¼è¨ºæ–·ï¼‰**
   - å»ºç«‹ä¸€å€‹å…è¨±æ‰€æœ‰å·²èªè­‰ä½¿ç”¨è€…çš„æ”¿ç­–
   - å¦‚æœé€™å€‹æ”¿ç­–å¯ä»¥é‹ä½œï¼Œè¡¨ç¤ºå•é¡Œåœ¨æ–¼ `auth.uid()` çš„å–å¾—

## ğŸ”§ å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ç¢ºä¿ cookies æ­£ç¢ºè¨­å®šï¼ˆå·²å¯¦ä½œï¼‰

å·²ä¿®å¾© `createServerClient` çš„è¨­å®šï¼Œç§»é™¤å¯èƒ½å¹²æ“¾çš„ `global.headers.Authorization`ã€‚

### æ–¹æ¡ˆ 2: ä½¿ç”¨ Admin client ä½œç‚ºä¸»è¦æŸ¥è©¢æ–¹å¼ï¼ˆä¸æ¨è–¦ï¼‰

é›–ç„¶å¯ä»¥è§£æ±ºå•é¡Œï¼Œä½†æœƒç¹é RLSï¼Œä¸ç¬¦åˆå®‰å…¨æœ€ä½³å¯¦è¸ã€‚

### æ–¹æ¡ˆ 3: ä¿®æ”¹æŸ¥è©¢æ–¹å¼

ä¸ä½¿ç”¨ `.single()`ï¼Œè€Œæ˜¯ä½¿ç”¨ `.maybeSingle()` æˆ– `.limit(1)`ï¼Œç„¶å¾Œæ‰‹å‹•è™•ç†çµæœã€‚

## ğŸ“ ä¸‹ä¸€æ­¥

1. æ¸¬è©¦ä¿®å¾©å¾Œçš„ `createServerClient` è¨­å®š
2. å¦‚æœå•é¡ŒæŒçºŒï¼Œæª¢æŸ¥ cookies è¨­å®š
3. å¦‚æœä»ç„¶å¤±æ•—ï¼Œè€ƒæ…®æš«æ™‚æ”¾å¯¬ RLS æ”¿ç­–ä¾†è¨ºæ–·å•é¡Œ
