# 註冊審核系統實作說明

## 📋 功能概述

已實作完整的註冊審核系統，包含以下功能：

1. **簡化註冊流程**：註冊時不需要郵件驗證，直接註冊成功
2. **待審核狀態**：新註冊的使用者狀態為 `PENDING`，無法使用系統功能
3. **管理員審核**：管理員可以審核使用者並設定角色和部門
4. **自動導向**：待審核使用者會自動導向待審核頁面

## ✅ 已完成的項目

### 1. 資料庫層面
- ✅ 新增 `user_profiles.status` 欄位（PENDING, APPROVED, REJECTED）
- ✅ 建立索引以提升查詢效能
- ✅ 現有使用者自動設為 `APPROVED`

### 2. 註冊流程
- ✅ 修改註冊 API (`/api/auth/register`)
  - 設定不需要郵件驗證
  - 新使用者狀態設為 `PENDING`
  - 使用 Admin client 建立 user_profiles（避免 RLS 限制）
- ✅ 修改註冊頁面 UI
  - 顯示需要審核的訊息
  - 註冊成功後導向登入頁

### 3. 管理員審核功能
- ✅ 建立審核 API (`/api/users/approve`)
  - 支援通過/拒絕審核
  - 審核通過時可設定角色和部門
  - 權限檢查（只有管理員可以審核）
- ✅ 修改使用者管理頁面
  - 分離顯示待審核和已審核使用者
  - 待審核使用者顯示審核按鈕
  - 已審核使用者顯示編輯功能

### 4. 權限控制
- ✅ 修改 middleware
  - 待審核使用者無法存取 API（除了登出）
  - 待審核使用者無法存取管理員頁面
  - 自動導向待審核頁面
- ✅ 修改權限檢查函式
  - `getCurrentUserProfile` 包含 status
  - 新增 `isApproved()` 和 `isPending()` 輔助函式
- ✅ 建立待審核頁面 (`/dashboard/pending`)
  - 顯示審核中訊息
  - 說明審核通過後的權限
  - 提供登出功能

### 5. 登入流程
- ✅ 修改登入表單
  - 登入後檢查使用者狀態
  - 待審核使用者導向待審核頁面
  - 已審核使用者導向主頁面
- ✅ 修改 Dashboard Layout
  - 檢查使用者狀態
  - 待審核使用者自動導向待審核頁面

## 🔧 使用說明

### 註冊流程

1. 使用者前往註冊頁面 (`/register`)
2. 填寫註冊資訊（電子郵件、密碼、顯示名稱）
3. 註冊成功後，顯示需要審核的訊息
4. 導向登入頁面

### 登入流程

1. 使用者登入
2. 系統檢查使用者狀態：
   - 如果狀態為 `PENDING` → 導向 `/dashboard/pending`
   - 如果狀態為 `APPROVED` → 導向 `/dashboard`
   - 如果狀態為 `REJECTED` → 顯示拒絕訊息（可擴充）

### 管理員審核流程

1. 管理員登入後前往使用者管理頁面 (`/dashboard/admin/users`)
2. 在「待審核使用者」區塊查看待審核的使用者
3. 選擇角色和部門（如需要）
4. 點擊「通過」或「拒絕」按鈕
5. 審核通過後，使用者可以正常使用系統

## 📊 資料庫結構

### user_profiles 表新增欄位

```sql
status VARCHAR(20) DEFAULT 'PENDING'
  CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED'))
```

### 狀態說明

- **PENDING**：待審核，無法使用系統功能
- **APPROVED**：已審核通過，可以正常使用
- **REJECTED**：已拒絕，無法使用系統（可擴充功能）

## 🔐 權限控制

### API 端點權限

- 待審核使用者無法存取任何 API（除了 `/api/auth/logout`）
- 所有 API 端點會檢查使用者狀態

### 頁面權限

- 待審核使用者只能看到待審核頁面
- 所有其他頁面會自動導向待審核頁面

## 🎨 UI/UX 設計

### 註冊頁面
- 顯示藍色提示框，說明需要審核
- 註冊成功後顯示明確的審核訊息

### 待審核頁面
- 顯示時鐘圖示和「帳號審核中」標題
- 說明審核通過後的權限
- 提供登出功能

### 管理員審核頁面
- 分離顯示待審核和已審核使用者
- 待審核使用者使用黃色背景標示
- 提供通過/拒絕按鈕

## 📝 注意事項

1. **Supabase 設定**：需要在 Supabase Dashboard 中關閉郵件驗證
   - 前往 Authentication → Settings
   - 關閉 "Enable email confirmations"

2. **現有使用者**：所有現有使用者已自動設為 `APPROVED` 狀態

3. **角色設定**：
   - 只有 SUPER_ADMIN 可以設定 SUPER_ADMIN 或 DEPT_ADMIN 角色
   - DEPT_ADMIN 可以審核使用者，但只能設定 USER 或 EDITOR 角色

4. **部門設定**：
   - 如果沒有指定部門，且當前使用者是部門管理員，會自動使用當前使用者的部門

## 🚀 未來擴充

1. **郵件通知**：審核通過後發送通知郵件
2. **拒絕原因**：允許管理員輸入拒絕原因
3. **批量審核**：支援一次審核多個使用者
4. **審核歷史**：記錄審核操作到 audit_logs
