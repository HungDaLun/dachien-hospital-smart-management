# Migration æ•´åˆåˆ†æå ±å‘Š

**åˆ†ææ—¥æœŸ**ï¼š2026-01-22  
**å°ˆæ¡ˆ**ï¼šKnowledge Architects  
**åˆ†æç¯„åœ**ï¼šsupabase/migrations è³‡æ–™å¤¾å…§æ‰€æœ‰ migration æª”æ¡ˆ

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

### âœ… å·²å®Œæˆä¿®å¾©
- **åŸ·è¡Œéºæ¼çš„ migration**ï¼š`add_feedback_loop` å’Œ `enable_rls_for_feedback_loop`
- **å¾Œç«¯èˆ‡ migrations æª”æ¡ˆå·²åŒæ­¥**

### ğŸ“‹ æ•´åˆå»ºè­°

**å°ˆæ¥­åˆ¤æ–·**ï¼š**ä¸éœ€è¦å¤§å¹…æ•´åˆç¾æœ‰ migrations**

**ç†ç”±**ï¼š
1. **Supabase Migration ç³»çµ±ç‰¹æ€§**ï¼šMigrations æ˜¯é †åºåŸ·è¡Œçš„æ­·å²è¨˜éŒ„ï¼Œå·²åŸ·è¡Œçš„ migration ä¸æ‡‰åˆªé™¤æˆ–ä¿®æ”¹
2. **æ¯å€‹ Migration éƒ½æœ‰å…¶ç›®çš„**ï¼šé›–ç„¶ migrations æ•¸é‡å¤šï¼Œä½†å¤§éƒ¨åˆ†éƒ½æ˜¯å¿…è¦çš„ä¿®å¾©å’Œæ”¹é€²
3. **ä¿æŒæ­·å²å¯è¿½æº¯æ€§**ï¼šä¿ç•™æ‰€æœ‰ migrations æœ‰åŠ©æ–¼è¿½è¹¤è³‡æ–™åº«æ¼”é€²éç¨‹

---

## ğŸ” è©³ç´°åˆ†æ

### 1. Migration åˆ†é¡

#### æ ¸å¿ƒçµæ§‹ Migrationsï¼ˆä¸å¯æ•´åˆï¼‰
- `20240101000000_initial_schema.sql` - åˆå§‹è³‡æ–™åº«çµæ§‹
- `20240101000001_enable_rls.sql` - åˆå§‹ RLS è¨­å®š
- `20260106000000_add_dikw_tables.sql` - DIKW ç›¸é—œè³‡æ–™è¡¨
- `20260113000000_create_agent_templates.sql` - Agent æ¨¡æ¿
- `20260120000000_add_aggregation.sql` - çŸ¥è­˜èšåˆ
- `20260121000000_add_hnsw_search.sql` - HNSW æœå°‹
- `20260122000000_add_knowledge_push.sql` - çŸ¥è­˜æ¨é€
- `20260119000000_add_feedback_loop.sql` - å›é¥‹å¾ªç’°

#### RLS ä¿®å¾© Migrationsï¼ˆå·²æ•´åˆåˆ°æœ€çµ‚ç‹€æ…‹ï¼‰
- `20240101000002_fix_rls_recursion.sql` - ä¿®å¾© RLS éè¿´å•é¡Œ
- `20240101000003_fix_tags_rls.sql` - ä¿®å¾©æ¨™ç±¤ RLS
- `20240101000004_fix_rls_final.sql` - æœ€çµ‚ RLS ä¿®å¾©
- `20260101060000_add_missing_rls_policies.sql` - è£œé½Šç¼ºå°‘çš„ RLS æ”¿ç­–
- `20260103000000_comprehensive_fix_user_profiles_rls.sql` - å…¨é¢ä¿®å¾© user_profiles RLS
- `20260104000000_relax_file_viewing_rls.sql` - æ”¾å¯¬æª”æ¡ˆæŸ¥çœ‹æ¬Šé™

**ç‹€æ…‹**ï¼šé€™äº› migrations é›–ç„¶å¤šï¼Œä½†éƒ½æ˜¯é€æ­¥ä¿®å¾©çš„éç¨‹ï¼Œæœ€çµ‚ç‹€æ…‹æ˜¯æ­£ç¢ºçš„ã€‚

#### Schema å°é½Š Migrationsï¼ˆå·²æ•´åˆåˆ°æœ€çµ‚ç‹€æ…‹ï¼‰
- `20260108000001_align_schema.sql` - å°é½Š schema
- `20260108000002_ensure_schema_consistency.sql` - ç¢ºä¿ schema ä¸€è‡´æ€§

**ç‹€æ…‹**ï¼š`ensure_schema_consistency` å·²ç¶“åŒ…å«äº† `align_schema` çš„å…§å®¹ï¼Œä½†ä¿ç•™å…©å€‹æª”æ¡ˆæœ‰åŠ©æ–¼è¿½è¹¤æ¼”é€²éç¨‹ã€‚

#### åŠŸèƒ½å¢å¼· Migrationsï¼ˆä¸å¯æ•´åˆï¼‰
- `20260104000000_add_user_status_field.sql` - ä½¿ç”¨è€…ç‹€æ…‹æ¬„ä½
- `20260114000000_add_dikw_levels.sql` - DIKW å±¤ç´š
- `20260118000000_add_knowledge_decay.sql` - çŸ¥è­˜è¡°æ¸›
- `20260118000001_fix_function_security.sql` - ä¿®å¾©å‡½å¼å®‰å…¨

**ç‹€æ…‹**ï¼šæ¯å€‹ migration éƒ½æœ‰æ˜ç¢ºçš„åŠŸèƒ½ç›®çš„ï¼Œä¸æ‡‰æ•´åˆã€‚

#### è³‡æ–™è¡¨å»ºç«‹ + RLS å•Ÿç”¨ï¼ˆå¯å„ªåŒ–ä½†å·²åŸ·è¡Œï¼‰
- `20260120000000_add_aggregation.sql` + `20260120000001_enable_rls_for_knowledge_units.sql`
- `20260122000000_add_knowledge_push.sql` + `20260122000001_enable_rls_for_knowledge_push.sql`
- `20260119000000_add_feedback_loop.sql` + `20260122000002_enable_rls_for_feedback_loop.sql`

**å»ºè­°**ï¼šæœªä¾†çš„æ–°åŠŸèƒ½ï¼Œå¯ä»¥å°‡ã€Œå»ºç«‹è³‡æ–™è¡¨ã€å’Œã€Œå•Ÿç”¨ RLSã€åˆä½µåœ¨åŒä¸€å€‹ migration ä¸­ï¼Œä½†å·²åŸ·è¡Œçš„ migrations ä¿æŒä¸è®Šã€‚

---

## âœ… å·²å®Œæˆçš„ä¿®å¾©

### 1. åŸ·è¡Œéºæ¼çš„ Migrations

**å•é¡Œ**ï¼š`20260119000000_add_feedback_loop.sql` å°šæœªåŸ·è¡Œ

**ä¿®å¾©**ï¼š
- âœ… å·²åŸ·è¡Œ `add_feedback_loop` migration
- âœ… å·²å»ºç«‹ `enable_rls_for_feedback_loop` migration ä¸¦åŸ·è¡Œ

**çµæœ**ï¼š
- `knowledge_feedback_events` è³‡æ–™è¡¨å·²å»ºç«‹
- `files` è¡¨å·²æ–°å¢ `feedback_score`ã€`feedback_count`ã€`positive_ratio` æ¬„ä½
- RLS å·²å•Ÿç”¨ä¸¦è¨­å®šé©ç•¶æ”¿ç­–

---

## ğŸ“ æœ€ä½³å¯¦è¸å»ºè­°

### 1. æœªä¾† Migration æ’°å¯«è¦ç¯„

**å»ºè­°æ ¼å¼**ï¼š
```sql
-- ============================================
-- åŠŸèƒ½åç¨±
-- å»ºç«‹æ—¥æœŸ: YYYY-MM-DD
-- ç›®çš„: ç°¡è¦èªªæ˜
-- ============================================

-- 1. å»ºç«‹è³‡æ–™è¡¨
CREATE TABLE IF NOT EXISTS ...

-- 2. å»ºç«‹ç´¢å¼•
CREATE INDEX IF NOT EXISTS ...

-- 3. å•Ÿç”¨ RLSï¼ˆèˆ‡å»ºç«‹è³‡æ–™è¡¨åœ¨åŒä¸€å€‹ migrationï¼‰
ALTER TABLE ... ENABLE ROW LEVEL SECURITY;

-- 4. å»ºç«‹ RLS æ”¿ç­–
CREATE POLICY ... ON ... FOR SELECT ...

-- 5. å»ºç«‹è§¸ç™¼å™¨ï¼ˆå¦‚éœ€è¦ï¼‰
CREATE TRIGGER ...

-- 6. è¨»è§£èªªæ˜
COMMENT ON TABLE ... IS '...';
```

### 2. Migration å‘½åè¦ç¯„

**æ ¼å¼**ï¼š`YYYYMMDDHHMMSS_description.sql`

**ç¯„ä¾‹**ï¼š
- âœ… `20260120000000_add_aggregation.sql`
- âœ… `20260120000001_enable_rls_for_knowledge_units.sql`
- âŒ `add_aggregation.sql`ï¼ˆç¼ºå°‘æ™‚é–“æˆ³ï¼‰

### 3. åˆä½µåŸå‰‡

**å¯ä»¥åˆä½µ**ï¼š
- å»ºç«‹è³‡æ–™è¡¨ + å•Ÿç”¨ RLSï¼ˆæœªä¾†æ–°åŠŸèƒ½ï¼‰
- å»ºç«‹è³‡æ–™è¡¨ + å»ºç«‹ç´¢å¼•
- å»ºç«‹å‡½å¼ + è¨­å®šå®‰å…¨åƒæ•¸

**ä¸æ‡‰åˆä½µ**ï¼š
- ä¸åŒåŠŸèƒ½çš„ migrations
- ä¿®å¾©æ€§ migrationsï¼ˆä¿ç•™æ­·å²è¨˜éŒ„ï¼‰
- è³‡æ–™ seed migrationsï¼ˆèˆ‡çµæ§‹ migrations åˆ†é–‹ï¼‰

---

## ğŸ¯ çµè«–

### å°ˆæ¥­åˆ¤æ–·ï¼š**ä¸éœ€è¦å¤§å¹…æ•´åˆ**

**ç†ç”±**ï¼š
1. âœ… **å¾Œç«¯èˆ‡ migrations å·²åŒæ­¥**ï¼šæ‰€æœ‰å¿…è¦çš„ migrations éƒ½å·²åŸ·è¡Œ
2. âœ… **æ­·å²è¨˜éŒ„æœ‰åƒ¹å€¼**ï¼šä¿ç•™æ‰€æœ‰ migrations æœ‰åŠ©æ–¼è¿½è¹¤è³‡æ–™åº«æ¼”é€²
3. âœ… **æ¯å€‹ Migration éƒ½æœ‰ç›®çš„**ï¼šé›–ç„¶æ•¸é‡å¤šï¼Œä½†éƒ½æ˜¯å¿…è¦çš„
4. âœ… **Supabase æœ€ä½³å¯¦è¸**ï¼šä¸å»ºè­°åˆªé™¤æˆ–ä¿®æ”¹å·²åŸ·è¡Œçš„ migrations

### å»ºè­°è¡Œå‹•

1. âœ… **å·²å®Œæˆ**ï¼šåŸ·è¡Œéºæ¼çš„ migrations
2. **æœªä¾†å„ªåŒ–**ï¼šæ–°åŠŸèƒ½å°‡ã€Œå»ºç«‹è³‡æ–™è¡¨ã€å’Œã€Œå•Ÿç”¨ RLSã€åˆä½µåœ¨åŒä¸€ migration
3. **ä¿æŒç¾ç‹€**ï¼šä¿ç•™æ‰€æœ‰ç¾æœ‰çš„ migrations æª”æ¡ˆ

### æœ€çµ‚ç‹€æ…‹

- âœ… **å¾Œç«¯è³‡æ–™åº«**ï¼šçµæ§‹å®Œæ•´ï¼ŒRLS æ”¿ç­–å¥å…¨
- âœ… **Migrations æª”æ¡ˆ**ï¼šèˆ‡å¾Œç«¯ç‹€æ…‹ä¸€è‡´
- âœ… **ä¸€è‡´æ€§**ï¼šå·²é”æˆ

---

**å ±å‘Šç”Ÿæˆæ™‚é–“**ï¼š2026-01-22  
**åˆ†æå·¥å…·**ï¼šSupabase MCP + SQL æŸ¥è©¢ + æª”æ¡ˆåˆ†æ
