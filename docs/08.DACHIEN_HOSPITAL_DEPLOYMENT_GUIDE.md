# 大千醫院 EAKAP 系統導入部署指南

**文件日期**：2026-01-16  
**版本**：v1.0  
**適用對象**：大千醫院專案導入

---

## 📋 執行摘要

本指南提供將 EAKAP 系統導入大千醫院的完整技術部署方案。根據醫療資料的敏感性與企業客戶的客製化需求，**建議採用獨立部署方案**。

### 核心決策

✅ **推薦方案：獨立部署（Isolated Deployment）**
- 完全獨立的 Supabase 專案
- 獨立的 GitHub Repository
- 獨立的部署環境（Vercel / 自建伺服器）
- 獨立的 S3/MinIO 儲存空間

❌ **不推薦：多租戶架構**
- 醫療資料需要嚴格隔離
- 客製化需求較多
- 維護與更新需要獨立性

---

## 🎯 部署架構圖

```
┌─────────────────────────────────────────────────────────┐
│              大千醫院 EAKAP 獨立部署環境                    │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐      ┌──────────────┐                 │
│  │  前端部署     │      │  Supabase    │                 │
│  │  (Vercel)    │◄────►│  後端資料庫   │                 │
│  │              │      │  (獨立專案)   │                 │
│  └──────────────┘      └──────────────┘                 │
│         │                      │                         │
│         │                      │                         │
│         ▼                      ▼                         │
│  ┌──────────────┐      ┌──────────────┐                 │
│  │  S3/MinIO    │      │  Gemini API  │                 │
│  │  檔案儲存     │      │  (共用金鑰)   │                 │
│  └──────────────┘      └──────────────┘                 │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

---

## 📦 步驟一：建立專案副本

### 1.1 建立新的專案目錄

```bash
# 在您的開發環境中
cd ~/Desktop
mkdir eakap-dachien
cd eakap-dachien
```

### 1.2 複製原始專案（使用 Git）

**選項 A：從現有專案複製（推薦）**

```bash
# 複製整個專案（排除 node_modules）
rsync -av --exclude 'node_modules' \
  --exclude '.next' \
  --exclude '.env.local' \
  --exclude '.git' \
  ~/Desktop/知識架構師/ \
  ~/Desktop/eakap-dachien/
```

**選項 B：使用 Git 建立新分支**

```bash
# 在原始專案中
cd ~/Desktop/知識架構師
git checkout -b dachien-deployment
git push origin dachien-deployment

# 在新目錄中 clone
cd ~/Desktop
git clone <your-repo-url> -b dachien-deployment eakap-dachien
cd eakap-dachien
```

### 1.3 初始化新的 Git Repository

```bash
cd ~/Desktop/eakap-dachien

# 移除舊的 Git 歷史（如果有的話）
rm -rf .git

# 初始化新的 Git Repository
git init
git branch -M main

# 建立 .gitignore（如果沒有）
cat > .gitignore << 'EOF'
# Dependencies
node_modules/
.pnp
.pnp.js

# Testing
coverage/

# Next.js
.next/
out/
build/
dist/

# Environment variables
.env*.local
.env

# Debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
EOF

# 第一次 commit
git add .
git commit -m "feat: 大千醫院專案初始化"
```

---

## 🗄️ 步驟二：建立 Supabase 後端

### 2.1 建立新的 Supabase 專案

1. 前往 [Supabase Dashboard](https://supabase.com/dashboard)
2. 點擊 **New Project**（新專案）
3. 填寫專案資訊：
   - **Name**: `eakap-dachien-hospital`
   - **Database Password**: 設定強密碼（請妥善保存）
   - **Region**: 選擇 `Southeast Asia (Singapore)` 或 `Northeast Asia (Tokyo)`
   - **Pricing Plan**: 選擇適合的方案（建議 Pro 以上）

### 2.2 取得 Supabase 連線資訊

1. 進入專案後，點擊左側選單 **⚙️ Settings** → **API**
2. 複製以下資訊：
   - **Project URL**: `https://xxxxx.supabase.co`
   - **anon public key**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
   - **service_role key**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` ⚠️ 機密

### 2.3 執行資料庫 Migrations

```bash
cd ~/Desktop/eakap-dachien

# 安裝 Supabase CLI（如果還沒安裝）
brew install supabase/tap/supabase

# 連結到新的 Supabase 專案
supabase link --project-ref <your-project-ref-id>
# 專案 ID 可以在 Settings → General → Reference ID 找到

# 執行所有 migrations
supabase db push
```

**或者手動執行 SQL**：

1. 在 Supabase Dashboard 中，點擊左側選單 **SQL Editor**
2. 依序執行 `supabase/migrations/` 目錄中的所有 SQL 檔案（按時間順序）

### 2.4 驗證資料庫結構

```bash
# 檢查資料表是否建立成功
supabase db inspect
```

或在 Supabase Dashboard → **Table Editor** 中確認以下資料表已建立：
- `departments`
- `user_profiles`
- `files`
- `agents`
- `chat_sessions`
- `chat_messages`
- 等等...

---

## 🔐 步驟三：設定環境變數

### 3.1 建立環境變數檔案

```bash
cd ~/Desktop/eakap-dachien

# 建立 .env.local 檔案
cat > .env.local << 'EOF'
# ============================================
# Supabase 設定（大千醫院專用）
# ============================================
NEXT_PUBLIC_SUPABASE_URL=https://your-dachien-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here

# ============================================
# Google Gemini API
# ============================================
GEMINI_API_KEY=your_gemini_api_key_here

# ============================================
# S3/MinIO 設定（大千醫院專用儲存空間）
# ============================================
# 選項 A：使用 AWS S3
S3_ENDPOINT=https://s3.amazonaws.com
S3_ACCESS_KEY=your_aws_access_key
S3_SECRET_KEY=your_aws_secret_key
S3_BUCKET_NAME=eakap-dachien-files
S3_REGION=ap-southeast-1

# 選項 B：使用 MinIO（自建）
# S3_ENDPOINT=http://your-minio-server:9000
# S3_ACCESS_KEY=your_minio_access_key
# S3_SECRET_KEY=your_minio_secret_key
# S3_BUCKET_NAME=eakap-dachien-files
# S3_REGION=us-east-1

# ============================================
# 應用程式設定
# ============================================
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development

# ============================================
# Email 服務（可選）
# ============================================
EMAIL_PROVIDER=console
EMAIL_FROM=noreply@dachien.com.tw
EOF
```

### 3.2 填入實際值

使用文字編輯器開啟 `.env.local`，填入步驟 2.2 取得的 Supabase 連線資訊。

---

## 🗂️ 步驟四：設定 S3/MinIO 儲存空間

### 4.1 選項 A：使用 AWS S3

1. 登入 [AWS Console](https://console.aws.amazon.com/)
2. 前往 **S3** 服務
3. 建立新的 Bucket：
   - **Bucket name**: `eakap-dachien-files`
   - **Region**: `ap-southeast-1`（新加坡）或 `ap-northeast-1`（東京）
   - **Block Public Access**: 啟用（保持私有）
4. 建立 IAM 使用者並取得 Access Key：
   - 前往 **IAM** → **Users** → **Create User**
   - 建立 Policy 允許 S3 存取
   - 取得 Access Key ID 和 Secret Access Key

### 4.2 選項 B：使用 MinIO（自建）

```bash
# 使用 Docker 啟動 MinIO
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio-dachien \
  -e "MINIO_ROOT_USER=admin" \
  -e "MINIO_ROOT_PASSWORD=your_strong_password" \
  minio/minio server /data --console-address ":9001"

# 建立 Bucket
# 在瀏覽器開啟 http://localhost:9001
# 登入後建立 bucket: eakap-dachien-files
```

---

## 🚀 步驟五：建立 GitHub Repository

### 5.1 在 GitHub 建立新 Repository

1. 前往 [GitHub](https://github.com)
2. 點擊右上角 **+** → **New repository**
3. 填寫資訊：
   - **Repository name**: `eakap-dachien-hospital`
   - **Visibility**: Private（建議）
   - **不要**勾選 "Initialize with README"（因為我們已有專案）

### 5.2 連結本地專案到 GitHub

```bash
cd ~/Desktop/eakap-dachien

# 加入遠端 Repository
git remote add origin https://github.com/your-username/eakap-dachien-hospital.git

# 推送程式碼
git push -u origin main
```

---

## 🌐 步驟六：部署前端應用

### 6.1 選項 A：使用 Vercel（推薦）

1. 前往 [Vercel](https://vercel.com)
2. 點擊 **Add New Project**
3. 選擇 **Import Git Repository** → 選擇 `eakap-dachien-hospital`
4. 設定環境變數：
   - 在 **Environment Variables** 區塊，加入所有 `.env.local` 中的變數
   - ⚠️ **不要**包含 `NEXT_PUBLIC_APP_URL`（Vercel 會自動設定）
5. 點擊 **Deploy**

### 6.2 選項 B：自建伺服器部署

```bash
# 在伺服器上
cd /var/www/eakap-dachien
git clone https://github.com/your-username/eakap-dachien-hospital.git .

# 安裝依賴
npm install

# 建立 .env.local（填入生產環境變數）
nano .env.local

# 建置專案
npm run build

# 使用 PM2 管理進程
npm install -g pm2
pm2 start npm --name "eakap-dachien" -- start
pm2 save
```

---

## ✅ 步驟七：驗證與測試

### 7.1 驗證資料庫連線

```bash
# 在專案目錄中
npm install
npm run dev

# 開啟瀏覽器
# http://localhost:3000/api/health
```

應該看到：
```json
{
  "status": "healthy",
  "components": {
    "database": {
      "status": "up",
      "latencyMs": 50
    }
  }
}
```

### 7.2 建立第一個管理員帳號

1. 前往 `http://localhost:3000/register`
2. 註冊帳號
3. 在 Supabase Dashboard → **Authentication** → **Users** 中找到該使用者
4. 手動修改 `user_profiles` 資料表，將 `role` 設為 `SUPER_ADMIN`

或使用 SQL：

```sql
-- 在 Supabase SQL Editor 中執行
UPDATE user_profiles
SET role = 'SUPER_ADMIN'
WHERE email = 'admin@dachien.com.tw';
```

### 7.3 測試核心功能

- [ ] 登入/登出功能
- [ ] 檔案上傳功能
- [ ] Agent 建立功能
- [ ] 對話功能
- [ ] 知識庫搜尋功能

---

## 🎨 步驟八：客製化設定（大千醫院專用）

### 8.1 修改品牌識別

```bash
# 修改應用程式名稱
# 在 app/layout.tsx 中
```

### 8.2 建立大千醫院專用部門

在 Supabase Dashboard → **SQL Editor** 執行：

```sql
-- 建立大千醫院部門
INSERT INTO departments (name, description) VALUES
('護理部', '護理相關作業'),
('內科', '內科醫療'),
('外科', '外科醫療'),
('急診科', '急診醫療'),
('藥劑部', '藥品管理'),
('採購部', '採購與庫存管理'),
('行政部', '行政作業'),
('健檢中心', '健康檢查服務');
```

### 8.3 設定初始資料

根據大千醫院的需求，可能需要：
- 建立標準文件分類
- 建立初始 Agent 模板
- 匯入既有 SOP 文件

---

## 📊 步驟九：監控與維護

### 9.1 設定監控告警

- **Supabase**: 在 Dashboard → **Settings** → **Alerts** 設定
- **Vercel**: 在專案設定中啟用監控
- **S3**: 設定 CloudWatch 告警

### 9.2 備份策略

```bash
# 定期備份 Supabase 資料庫
supabase db dump -f backup-$(date +%Y%m%d).sql

# 備份 S3 資料（使用 AWS CLI）
aws s3 sync s3://eakap-dachien-files ./backup-files/
```

### 9.3 更新流程

```bash
# 從主專案同步更新（如果需要的話）
# 注意：需要手動 merge，避免覆蓋客製化內容

# 1. 在主專案中
cd ~/Desktop/知識架構師
git pull origin main

# 2. 在大千醫院專案中
cd ~/Desktop/eakap-dachien
git remote add upstream ~/Desktop/知識架構師  # 或使用 GitHub URL
git fetch upstream
git merge upstream/main  # 手動解決衝突
```

---

## ⚠️ 重要注意事項

### 資料隔離

✅ **已確保**：
- 獨立的 Supabase 專案 = 完全獨立的資料庫
- 獨立的 S3 Bucket = 完全獨立的檔案儲存
- 獨立的部署環境 = 完全獨立的應用程式

### 安全性

1. **環境變數管理**：
   - 絕不將 `.env.local` 提交到 Git
   - 使用 Vercel 的環境變數管理功能
   - 定期輪換 API Keys

2. **資料庫安全**：
   - 啟用 Supabase 的 RLS（Row Level Security）
   - 定期審查 RLS 政策
   - 啟用資料庫備份

3. **檔案儲存安全**：
   - S3 Bucket 設為私有
   - 使用 Signed URL 存取檔案
   - 啟用 S3 版本控制

### 成本估算

| 項目 | 月成本（估算） |
|------|---------------|
| Supabase Pro | $25 USD |
| Vercel Pro | $20 USD |
| AWS S3 (100GB) | $2-5 USD |
| Gemini API | 依使用量 |
| **合計** | **約 $50-100 USD/月** |

---

## 📋 檢查清單

### 部署前檢查

- [ ] 建立新的 Supabase 專案
- [ ] 執行所有資料庫 migrations
- [ ] 設定環境變數
- [ ] 建立 S3/MinIO Bucket
- [ ] 建立 GitHub Repository
- [ ] 推送程式碼到 GitHub

### 部署後檢查

- [ ] 驗證資料庫連線
- [ ] 建立管理員帳號
- [ ] 測試核心功能
- [ ] 設定監控告警
- [ ] 建立備份流程
- [ ] 文件化客製化內容

---

## 🆘 故障排除

### 問題 1：無法連線 Supabase

**檢查**：
```bash
# 驗證環境變數
echo $NEXT_PUBLIC_SUPABASE_URL
```

**解決**：確認 `.env.local` 中的 Supabase URL 和 Keys 正確

### 問題 2：檔案上傳失敗

**檢查**：
- S3 連線設定是否正確
- Bucket 是否存在
- IAM 權限是否足夠

**解決**：
```bash
# 測試 S3 連線
aws s3 ls s3://eakap-dachien-files/
```

### 問題 3：RLS 政策阻擋存取

**檢查**：在 Supabase Dashboard → **Authentication** → **Policies** 查看 RLS 政策

**解決**：確認使用者角色和部門設定正確

---

## 📞 支援與聯絡

如有問題，請聯絡：
- **技術支援**：[您的聯絡方式]
- **文件**：參考 `.claude/CLAUDE.md`

---

**文件結束**

**最後更新**：2026-01-16  
**版本**：v1.0
