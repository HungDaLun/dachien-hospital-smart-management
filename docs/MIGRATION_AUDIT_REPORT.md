# Supabase Migrations æª¢æŸ¥å ±å‘Š

**æª¢æŸ¥æ™‚é–“**: 2026-02-22  
**å°ˆæ¡ˆ**: Knowledge Architects (vjvmwyzpjmzzhfiaojul)

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

- **æœ¬åœ° migrations ç¸½æ•¸**: 84 å€‹
- **å·²åŸ·è¡Œçš„ migrations**: 71 å€‹
- **æœªåŸ·è¡Œçš„ migrations**: 13 å€‹
- **ç‹€æ…‹**: âš ï¸ éœ€è¦äººå·¥æª¢æŸ¥

---

## âŒ æœªåŸ·è¡Œçš„ Migrations è©³ç´°åˆ†æ

### 1. æ—©æœŸ RLS ç›¸é—œ (å¯èƒ½å·²é€šéå…¶ä»–æ–¹å¼åŸ·è¡Œ)

#### `20240101000001_enable_rls.sql`
- **ç‹€æ…‹**: âš ï¸ å¯èƒ½å·²åŸ·è¡Œ
- **åŸå› **: å·²åŸ·è¡Œçš„ migrations ä¸­æœ‰ `enable_rls_fixed`ï¼Œå¯èƒ½å·²æ¶µè“‹æ­¤å…§å®¹
- **å»ºè­°**: æª¢æŸ¥ RLS æ˜¯å¦å·²æ­£ç¢ºå•Ÿç”¨ï¼Œå¦‚å·²å•Ÿç”¨å‰‡å¯å¿½ç•¥

#### `20240101000002_fix_rls_recursion.sql`
- **ç‹€æ…‹**: âš ï¸ å¯èƒ½å·²åŸ·è¡Œ
- **åŸå› **: å·²åŸ·è¡Œçš„ migrations ä¸­æœ‰ `fix_rls_recursion_complete`
- **å»ºè­°**: æª¢æŸ¥æ˜¯å¦ä»æœ‰ RLS éè¿´å•é¡Œï¼Œå¦‚ç„¡å‰‡å¯å¿½ç•¥

#### `20240101000003_fix_tags_rls.sql`
- **ç‹€æ…‹**: â“ éœ€è¦æª¢æŸ¥
- **å»ºè­°**: æª¢æŸ¥ `file_tags` è¡¨çš„ RLS æ”¿ç­–æ˜¯å¦æ­£ç¢º

### 2. è§¸ç™¼å™¨ç›¸é—œ

#### `20260102020000_add_user_profile_trigger.sql`
- **ç‹€æ…‹**: â“ éœ€è¦æª¢æŸ¥
- **å»ºè­°**: æª¢æŸ¥ `user_profiles` è¡¨æ˜¯å¦æœ‰ç›¸é—œè§¸ç™¼å™¨

### 3. è¡¨çµæ§‹ç›¸é—œ (å¯èƒ½å·²å­˜åœ¨)

#### `20260103210000_create_audit_logs.sql`
- **ç‹€æ…‹**: âœ… è¡¨å·²å­˜åœ¨
- **æª¢æŸ¥çµæœ**: `audit_logs` è¡¨å·²å­˜åœ¨ï¼Œä¸”æœ‰ RLS æ”¿ç­–
- **å»ºè­°**: å¯å¿½ç•¥ï¼ˆå¯èƒ½å·²é€šéå…¶ä»– migration å»ºç«‹ï¼‰

#### `20260107000000_system_settings.sql`
- **ç‹€æ…‹**: âœ… è¡¨å·²å­˜åœ¨
- **æª¢æŸ¥çµæœ**: `system_settings` è¡¨å·²å­˜åœ¨ï¼Œä¸”æœ‰è³‡æ–™
- **å»ºè­°**: å¯å¿½ç•¥ï¼ˆå¯èƒ½å·²é€šéå…¶ä»– migration å»ºç«‹ï¼‰

#### `20260106000001_add_strategic_insights_cache.sql`
- **ç‹€æ…‹**: âœ… è¡¨å·²å­˜åœ¨
- **æª¢æŸ¥çµæœ**: `ai_strategic_insights` è¡¨å·²å­˜åœ¨
- **å»ºè­°**: å¯å¿½ç•¥ï¼ˆå·²é€šé `20260106070223` migration åŸ·è¡Œï¼‰

### 4. Seed è³‡æ–™ç›¸é—œ

#### `20260107120000_import_historical_audit_logs.sql`
- **ç‹€æ…‹**: â“ éœ€è¦ç¢ºèª
- **å»ºè­°**: æª¢æŸ¥æ˜¯å¦éœ€è¦åŒ¯å…¥æ­·å²è³‡æ–™ï¼Œå¦‚ä¸éœ€è¦å‰‡å¯å¿½ç•¥

#### `20260108000003_extend_knowledge_descriptions.sql`
- **ç‹€æ…‹**: â“ éœ€è¦æª¢æŸ¥
- **å»ºè­°**: æª¢æŸ¥ `knowledge_frameworks` è¡¨çš„ `description` æ¬„ä½æ˜¯å¦éœ€è¦æ›´æ–°

#### `20260109000000_seed_full_knowledge_frameworks.sql`
- **ç‹€æ…‹**: âš ï¸ å¯èƒ½å·²åŸ·è¡Œ
- **æª¢æŸ¥çµæœ**: `knowledge_frameworks` è¡¨æœ‰ 55 ç­†è³‡æ–™
- **å»ºè­°**: æª¢æŸ¥è³‡æ–™æ˜¯å¦å®Œæ•´ï¼Œå¦‚å®Œæ•´å‰‡å¯å¿½ç•¥

#### `20260115000001_seed_top_skills.sql`
- **ç‹€æ…‹**: âš ï¸ å¯èƒ½å·²åŸ·è¡Œ
- **æª¢æŸ¥çµæœ**: `skills_library` è¡¨æœ‰ 43 ç­†è³‡æ–™
- **å»ºè­°**: æª¢æŸ¥æ˜¯å¦éœ€è¦é¡å¤–çš„ seed è³‡æ–™

### 5. ç´„æŸèˆ‡é©—è­‰ç›¸é—œ

#### `20260110000000_add_framework_numbering.sql`
- **ç‹€æ…‹**: â“ éœ€è¦æª¢æŸ¥
- **å»ºè­°**: æª¢æŸ¥ `knowledge_frameworks` è¡¨æ˜¯å¦æœ‰ç·¨è™Ÿæ¬„ä½

#### `20260111000000_enforce_valid_gemini_models.sql`
- **ç‹€æ…‹**: âŒ æœªåŸ·è¡Œ
- **æª¢æŸ¥çµæœ**: `agents` è¡¨æ²’æœ‰ `model_version` çš„ç´„æŸ
- **å»ºè­°**: âš ï¸ **éœ€è¦åŸ·è¡Œ** - é€™æ˜¯ä¸€å€‹é‡è¦çš„è³‡æ–™é©—è­‰ç´„æŸ

---

## âœ… å»ºè­°åŸ·è¡Œçš„ Migrations

### é«˜å„ªå…ˆç´š

1. **`20260111000000_enforce_valid_gemini_models.sql`**
   - åŸå› : ç¼ºå°‘é‡è¦çš„è³‡æ–™é©—è­‰ç´„æŸ
   - å½±éŸ¿: å¯èƒ½å°è‡´ç„¡æ•ˆçš„æ¨¡å‹ç‰ˆæœ¬è¢«å„²å­˜

### ä¸­å„ªå…ˆç´š

2. **`20260110000000_add_framework_numbering.sql`**
   - åŸå› : å¯èƒ½å½±éŸ¿çŸ¥è­˜æ¡†æ¶çš„ç·¨è™ŸåŠŸèƒ½
   - å»ºè­°: æª¢æŸ¥æ˜¯å¦éœ€è¦æ­¤åŠŸèƒ½

3. **`20260108000003_extend_knowledge_descriptions.sql`**
   - åŸå› : å¯èƒ½æ›´æ–°çŸ¥è­˜æ¡†æ¶çš„æè¿°æ¬„ä½
   - å»ºè­°: æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´è©³ç´°çš„æè¿°

### ä½å„ªå…ˆç´šï¼ˆå¯é¸ï¼‰

4. **`20260102020000_add_user_profile_trigger.sql`**
   - åŸå› : è§¸ç™¼å™¨åŠŸèƒ½ï¼Œå¯èƒ½å·²é€šéå…¶ä»–æ–¹å¼å¯¦ä½œ
   - å»ºè­°: æª¢æŸ¥è§¸ç™¼å™¨æ˜¯å¦å·²å­˜åœ¨

5. **`20260107120000_import_historical_audit_logs.sql`**
   - åŸå› : æ­·å²è³‡æ–™åŒ¯å…¥ï¼Œå¦‚ä¸éœ€è¦å¯å¿½ç•¥
   - å»ºè­°: ç¢ºèªæ˜¯å¦éœ€è¦æ­·å²è³‡æ–™

---

## ğŸ” éœ€è¦äººå·¥æª¢æŸ¥çš„é …ç›®

1. **RLS æ”¿ç­–å®Œæ•´æ€§**
   - æª¢æŸ¥ `file_tags` è¡¨çš„ RLS æ˜¯å¦æ­£ç¢º
   - ç¢ºèªæ‰€æœ‰è¡¨çš„ RLS éƒ½å·²å•Ÿç”¨

2. **è§¸ç™¼å™¨ç‹€æ…‹**
   - æª¢æŸ¥ `user_profiles` è¡¨æ˜¯å¦æœ‰å¿…è¦çš„è§¸ç™¼å™¨

3. **è³‡æ–™å®Œæ•´æ€§**
   - ç¢ºèª `knowledge_frameworks` çš„ 55 ç­†è³‡æ–™æ˜¯å¦å®Œæ•´
   - ç¢ºèª `skills_library` çš„ 43 ç­†è³‡æ–™æ˜¯å¦éœ€è¦è£œå……

4. **ç´„æŸèˆ‡é©—è­‰**
   - ç¢ºèª `agents.model_version` æ˜¯å¦éœ€è¦ç´„æŸé©—è­‰

---

## ğŸ“ åŸ·è¡Œå»ºè­°

### æ­¥é©Ÿ 1: æª¢æŸ¥ç¾æœ‰ç‹€æ…‹
```sql
-- æª¢æŸ¥ file_tags çš„ RLS
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' AND tablename = 'file_tags';

-- æª¢æŸ¥ user_profiles çš„è§¸ç™¼å™¨
SELECT trigger_name, event_manipulation, event_object_table
FROM information_schema.triggers
WHERE event_object_table = 'user_profiles';

-- æª¢æŸ¥ agents è¡¨çš„ç´„æŸ
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conrelid = 'public.agents'::regclass;
```

### æ­¥é©Ÿ 2: åŸ·è¡Œå¿…è¦çš„ Migrations

å»ºè­°æŒ‰ä»¥ä¸‹é †åºåŸ·è¡Œï¼š

1. `20260111000000_enforce_valid_gemini_models.sql` âš ï¸ **å¿…é ˆåŸ·è¡Œ**
2. `20260110000000_add_framework_numbering.sql` (å¦‚éœ€è¦)
3. `20260108000003_extend_knowledge_descriptions.sql` (å¦‚éœ€è¦)
4. `20260102020000_add_user_profile_trigger.sql` (å¦‚éœ€è¦)

### æ­¥é©Ÿ 3: é©—è­‰åŸ·è¡Œçµæœ

åŸ·è¡Œå¾Œè«‹é©—è­‰ï¼š
- ç´„æŸæ˜¯å¦æ­£ç¢ºå»ºç«‹
- è§¸ç™¼å™¨æ˜¯å¦æ­£å¸¸é‹ä½œ
- è³‡æ–™æ˜¯å¦å®Œæ•´

---

## âš ï¸ æ³¨æ„äº‹é …

1. **åŸ·è¡Œå‰å‚™ä»½**: å»ºè­°åœ¨åŸ·è¡Œä»»ä½• migration å‰å…ˆå‚™ä»½è³‡æ–™åº«
2. **æ¸¬è©¦ç’°å¢ƒ**: å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œï¼Œç¢ºèªç„¡èª¤å¾Œå†åœ¨ç”Ÿç”¢ç’°å¢ƒåŸ·è¡Œ
3. **ä¾è³´é—œä¿‚**: æ³¨æ„ migrations ä¹‹é–“çš„ä¾è³´é—œä¿‚ï¼ŒæŒ‰æ™‚é–“é †åºåŸ·è¡Œ
4. **Rollback è¨ˆåŠƒ**: æº–å‚™å¥½ rollback è¨ˆåŠƒï¼Œä»¥é˜²åŸ·è¡Œå¤±æ•—

---

## ğŸ“ å¾ŒçºŒè¡Œå‹•

1. æª¢æŸ¥ä¸Šè¿°éœ€è¦äººå·¥ç¢ºèªçš„é …ç›®
2. åŸ·è¡Œé«˜å„ªå…ˆç´šçš„ migrations
3. é©—è­‰åŸ·è¡Œçµæœ
4. æ›´æ–°æ­¤å ±å‘Šè¨˜éŒ„åŸ·è¡Œç‹€æ…‹

---

**å ±å‘Šç”Ÿæˆæ™‚é–“**: 2026-02-22  
**æª¢æŸ¥å·¥å…·**: Supabase MCP + Python è…³æœ¬
