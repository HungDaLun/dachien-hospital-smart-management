# AI å›ç­”å“è³ªé˜²è­·æ©Ÿåˆ¶å¯¦ä½œæª¢æŸ¥å ±å‘Š

**å ±å‘Šæ—¥æœŸ**ï¼š2026-01-16ï¼ˆæ›´æ–°ç‰ˆï¼‰  
**æª¢æŸ¥ç¯„åœ**ï¼šç³»çµ±ä¸­æ‰€æœ‰ AI å›ç­”åŠŸèƒ½  
**æª¢æŸ¥æ¨™æº–**ï¼šäº”å±¤å“è³ªé˜²è­·æ©Ÿåˆ¶ï¼ˆLayer 1-5ï¼‰  
**ç‰ˆæœ¬**ï¼šv2.0 â€” åŠ å…¥é¢¨éšªåˆ†ç´šæ¡†æ¶èˆ‡æŠ€è¡“è½åœ°æ–¹æ¡ˆ

---

## åŸ·è¡Œæ‘˜è¦

### æ ¸å¿ƒç™¼ç¾

ç¶“éè©³ç´°æª¢æŸ¥ï¼Œç³»çµ±ä¸­å„ AI åŠŸèƒ½çš„å“è³ªé˜²è­·å¯¦ä½œç¨‹åº¦ä¸ä¸€ã€‚ç„¶è€Œï¼Œ**ä¸¦éæ‰€æœ‰å ´æ™¯éƒ½éœ€è¦å®Œæ•´å¯¦ä½œäº”å±¤é˜²è­·**ã€‚æœ¬å ±å‘Šæå‡º**é¢¨éšªåˆ†ç´šæ¡†æ¶**ï¼Œæ ¹æ“šå ´æ™¯ç‰¹æ€§æ±ºå®šé©ç•¶çš„é˜²è­·å±¤ç´šï¼Œä»¥é”åˆ°å“è³ªèˆ‡æ•ˆç‡çš„æœ€ä½³å¹³è¡¡ã€‚

### æ•´é«”å¯¦ä½œç‹€æ³

| åŠŸèƒ½ | é¢¨éšªç­‰ç´š | Layer 1<br/>å¼•ç”¨ä¾†æº | Layer 2<br/>ä¿¡å¿ƒåº¦ | Layer 3<br/>è¦†æ ¸æç¤º | Layer 4<br/>åé¥‹å­¸ç¿’ | Layer 5<br/>å®šæœŸå¯©è¨ˆ | å»ºè­° |
|------|:--------:|:------------------:|:----------------:|:------------------:|:------------------:|:------------------:|:----:|
| éƒ¨é–€ Agentï¼ˆç„¡å·¥å…·ï¼‰ | ğŸ”´ é«˜ | âœ… | âœ… | âœ… | âœ… | âš ï¸ | ç¶­æŒ |
| éƒ¨é–€ Agentï¼ˆå·¥å…·æ¨¡å¼ï¼‰ | ğŸ”´ é«˜ | âŒ | âŒ | âŒ | âœ… | âš ï¸ | **éœ€è£œé½Š** |
| ä¼æ¥­åƒè¬€ | ğŸ”´ é«˜ | âŒ | âŒ | âŒ | âŒ | âš ï¸ | **éœ€è£œé½Š** |
| éƒ¨é–€å°è©± | ğŸŸ¡ ä¸­ | âŒ | âŒ | âŒ | âŒ | âš ï¸ | éƒ¨åˆ†å¯¦ä½œ |
| Agent æœƒè­° | ğŸŸ¡ ä¸­ | âœ… | âŒ | âŒ | âŒ | âš ï¸ | éƒ¨åˆ†å¯¦ä½œ |
| OpenAI ç›¸å®¹ API | ğŸŸ¢ ä½ | âŒ | âŒ | âŒ | âŒ | âš ï¸ | æœ€å°åŒ– |
| ä¼æ¥­åƒè¬€ï¼ˆWar Roomï¼‰ | ğŸŸ¢ ä½ | âŒ | âŒ | âŒ | âŒ | âš ï¸ | äº‹å¾Œå¯©è¨ˆ |

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šé¢¨éšªåˆ†ç´šæ¡†æ¶

### 1.1 é¢¨éšªç­‰ç´šå®šç¾©

| é¢¨éšªç­‰ç´š | å®šç¾© | éŒ¯èª¤å½±éŸ¿ | å…¸å‹å ´æ™¯ |
|:--------:|------|----------|----------|
| ğŸ”´ **é«˜é¢¨éšª** | ç›´æ¥å½±éŸ¿æ¥­å‹™æ±ºç­–ï¼ŒéŒ¯èª¤æˆæœ¬é«˜ | è²¡å‹™æå¤±ã€æ³•å¾‹é¢¨éšªã€è²è­½æå®³ | ä¼æ¥­åƒè¬€ã€éƒ¨é–€ Agent æ±ºç­–æ”¯æ´ |
| ğŸŸ¡ **ä¸­é¢¨éšª** | å…§éƒ¨å”ä½œç”¨é€”ï¼Œå½±éŸ¿å¯æ§ | æºé€šèª¤è§£ã€æ•ˆç‡é™ä½ã€éœ€äººå·¥ä¿®æ­£ | Agent æœƒè­°ã€éƒ¨é–€å…§éƒ¨å°è©± |
| ğŸŸ¢ **ä½é¢¨éšª** | è¼”åŠ©å·¥å…·ã€ç”¨æˆ¶è‡ªè¡Œè² è²¬ | è¼•å¾®ä¸ä¾¿ã€ç”¨æˆ¶å¯è‡ªè¡Œåˆ¤æ–· | API æ•´åˆã€èƒŒæ™¯åˆ†æã€å‰µæ„ç™¼æƒ³ |

### 1.2 é˜²è­·å±¤ç´šå»ºè­°çŸ©é™£

| é¢¨éšªç­‰ç´š | Layer 1<br/>å¼•ç”¨ä¾†æº | Layer 2<br/>ä¿¡å¿ƒåº¦ | Layer 3<br/>è¦†æ ¸æç¤º | Layer 4<br/>åé¥‹å­¸ç¿’ | Layer 5<br/>å®šæœŸå¯©è¨ˆ |
|:--------:|:--------------------:|:------------------:|:--------------------:|:--------------------:|:--------------------:|
| ğŸ”´ é«˜é¢¨éšª | âœ… å¿…é ˆ | âœ… å¿…é ˆ | âœ… å¿…é ˆ | âœ… å¿…é ˆ | âœ… å¿…é ˆ |
| ğŸŸ¡ ä¸­é¢¨éšª | âœ… å¿…é ˆ | âš ï¸ å»ºè­° | â­• é¸ç”¨ | âœ… å¿…é ˆ | âœ… æŠ½æ¨£ |
| ğŸŸ¢ ä½é¢¨éšª | âš ï¸ å»ºè­° | â­• é¸ç”¨ | âŒ ä¸éœ€ | âš ï¸ ç°¡åŒ– | âœ… æŠ½æ¨£ |

### 1.3 å„å±¤ç´šé©ç”¨æ€§åˆ†æ

#### Layer 1: å¼·åˆ¶å¼•ç”¨ä¾†æº â€” å»ºè­°æ™®éå¯¦ä½œ
- **åƒ¹å€¼**ï¼šå¯ä¿¡åº¦åŸºç¤ï¼Œæˆæœ¬ä½æ•ˆç›Šé«˜
- **ä¾‹å¤–**ï¼šç´”å‰µæ„ç”Ÿæˆã€ç„¡ RAG ä¾†æºçš„å ´æ™¯

#### Layer 2: ä¿¡å¿ƒåº¦è©•åˆ† â€” é¸æ“‡æ€§å¯¦ä½œ
- **é©åˆ**ï¼šé«˜é¢¨éšªæ±ºç­–å ´æ™¯
- **ä¸é©åˆ**ï¼šå‰µæ„ç™¼æƒ³éšæ®µï¼ˆæœƒæŠ‘åˆ¶å‰µæ–°æ€ç¶­ï¼‰

#### Layer 3: äººå·¥è¦†æ ¸æç¤º â€” é¸æ“‡æ€§å¯¦ä½œ
- **é©åˆ**ï¼šæ³•è¦ã€è²¡å‹™ã€äººäº‹ç­‰æ•æ„Ÿè­°é¡Œ
- **ä¸é©åˆ**ï¼šæ—¥å¸¸æŸ¥è©¢ï¼ˆé¿å…ã€Œè­¦å ±ç–²å‹ã€ï¼‰

#### Layer 4: ä½¿ç”¨è€…åé¥‹å­¸ç¿’ â€” å»ºè­°æ™®éå¯¦ä½œ
- **åƒ¹å€¼**ï¼šæŒçºŒæ”¹å–„çš„åŸºç¤
- **ç°¡åŒ–æ–¹æ¡ˆ**ï¼šä½é¢¨éšªå ´æ™¯å¯åªè¨˜éŒ„ ğŸ‘/ğŸ‘

#### Layer 5: å®šæœŸäººå·¥å¯©è¨ˆ â€” é›†ä¸­å¯¦ä½œ
- **å»ºè­°**ï¼šçµ±ä¸€å¯©è¨ˆç³»çµ±ï¼Œå®šæœŸæŠ½æ¨£æ‰€æœ‰ AI å›æ‡‰
- **ä¸å»ºè­°**ï¼šæ¯å€‹åŠŸèƒ½ç¨ç«‹å¯¦ä½œå¯©è¨ˆé‚è¼¯

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šç¾ç‹€è©³ç´°æª¢æŸ¥

### 2.1 é«˜é¢¨éšªå ´æ™¯

#### âœ… éƒ¨é–€ Agent å°è©± - ç„¡å·¥å…·æ¨¡å¼ï¼ˆå®Œæ•´å¯¦ä½œï¼‰

**è·¯å¾‘**ï¼š`app/api/chat/route.ts`

| å±¤ç´š | ç‹€æ…‹ | å¯¦ä½œç´°ç¯€ |
|------|:----:|----------|
| Layer 1 | âœ… | System Prompt è¦æ±‚ JSON æ ¼å¼ citationsï¼Œè§£æå¾Œå„²å­˜è‡³ `chat_messages.citations` |
| Layer 2 | âœ… | å¾ JSON æå– `confidence` å’Œ `reasoning`ï¼Œå„²å­˜è‡³å°æ‡‰æ¬„ä½ |
| Layer 3 | âœ… | ä½¿ç”¨ `detectReviewTriggers()` æª¢æ¸¬é—œéµå­— |
| Layer 4 | âœ… | `chat_feedback` è¡¨ + `/api/chat/feedback` ç«¯é» |
| Layer 5 | âš ï¸ | è³‡æ–™åº«çµæ§‹å°±ç·’ï¼Œç¼ºå°‘ Cron Job |

**ç¨‹å¼ç¢¼ä½ç½®**ï¼š`app/api/chat/route.ts:404-452`

---

#### âŒ éƒ¨é–€ Agent å°è©± - å·¥å…·æ¨¡å¼ï¼ˆéœ€è£œé½Šï¼‰

**å•é¡Œæ¸…å–®**ï¼š
- ä½¿ç”¨ `chatWithTools()` æ™‚ç›´æ¥ä¸²æµï¼Œç„¡å¾Œè™•ç†
- æœªè§£æ citationsã€confidence_score
- æœªæª¢æ¸¬ review_triggers
- å„²å­˜æ™‚ç¼ºå°‘æ‰€æœ‰é˜²è­·æ¬„ä½

**ç¨‹å¼ç¢¼ä½ç½®**ï¼š`app/api/chat/route.ts:289-365`

**ä¿®å¾©å„ªå…ˆç´š**ï¼šğŸ”´ æœ€é«˜

---

#### âŒ ä¼æ¥­åƒè¬€ï¼ˆéœ€è£œé½Šï¼‰

**è·¯å¾‘**ï¼š`app/api/chat/corporate/route.ts`

**å•é¡Œæ¸…å–®**ï¼š
- åƒ…åœ¨ System Prompt è¦æ±‚ã€Œæ¨™è¨»ä¾†æºã€ï¼Œç„¡çµæ§‹åŒ–æå–
- å›æ‡‰ç›´æ¥ä¸²æµï¼Œç„¡å¾Œè™•ç†
- æœªå„²å­˜è‡³ `chat_messages` è¡¨ï¼Œç„¡æ³•è¿½è¹¤åé¥‹

**ç¨‹å¼ç¢¼ä½ç½®**ï¼š`app/api/chat/corporate/route.ts:77-100`

**ä¿®å¾©å„ªå…ˆç´š**ï¼šğŸ”´ æœ€é«˜

---

### 2.2 ä¸­é¢¨éšªå ´æ™¯

#### âš ï¸ Agent æœƒè­°ï¼ˆéƒ¨åˆ†å¯¦ä½œï¼‰

**è·¯å¾‘**ï¼š`lib/meeting/service.ts`

| å±¤ç´š | ç‹€æ…‹ | èªªæ˜ |
|------|:----:|------|
| Layer 1 | âœ… | ä½¿ç”¨ `CitationValidator` é©—è­‰å¼•ç”¨ |
| Layer 2 | âŒ | `meeting_messages` è¡¨ç¼ºå°‘ `confidence_score` æ¬„ä½ |
| Layer 3 | â­• | å¯é¸å¯¦ä½œï¼ˆæœƒè­°ç‚ºå…§éƒ¨å”ä½œç”¨é€”ï¼‰ |
| Layer 4 | âŒ | ç¼ºå°‘æœƒè­°è¨Šæ¯åé¥‹æ©Ÿåˆ¶ |
| Layer 5 | âš ï¸ | ç´å…¥çµ±ä¸€å¯©è¨ˆç³»çµ± |

**å»ºè­°**ï¼šè£œé½Š Layer 2 å’Œ Layer 4ï¼ŒLayer 3 ç‚ºé¸ç”¨

---

#### âŒ éƒ¨é–€å°è©±ï¼ˆéœ€è£œé½ŠåŸºç¤å±¤ï¼‰

**è·¯å¾‘**ï¼š`app/api/chat/department/route.ts`

**å»ºè­°å¯¦ä½œ**ï¼šLayer 1 + Layer 4
- å¼•ç”¨ä¾†æºå¿…é ˆ
- åé¥‹æ©Ÿåˆ¶å¿…é ˆ
- ä¿¡å¿ƒåº¦èˆ‡è¦†æ ¸æç¤ºç‚ºé¸ç”¨

---

### 2.3 ä½é¢¨éšªå ´æ™¯

#### âš ï¸ OpenAI ç›¸å®¹ APIï¼ˆç¶­æŒç¾ç‹€ï¼‰

**è·¯å¾‘**ï¼š`app/api/openai/v1/chat/completions/route.ts`

**è¨­è¨ˆè€ƒé‡**ï¼š
- ç‚ºç›¸å®¹ OpenAI API æ ¼å¼ï¼Œå›æ‡‰ç›´æ¥ä¸²æµ
- API ç”¨æˆ¶è‡ªè¡Œè² è²¬å“è³ªæ§ç®¡
- è‹¥éœ€é˜²è­·ï¼Œç”±å‘¼å«ç«¯å¯¦ä½œ

**å»ºè­°**ï¼šåƒ…å¯¦ä½œ Layer 1ï¼ˆå¼•ç”¨ä¾†æºï¼‰ï¼Œå…¶é¤˜ç¶­æŒç¾ç‹€

---

#### âš ï¸ War Room ä¼æ¥­åƒè¬€ï¼ˆäº‹å¾Œå¯©è¨ˆï¼‰

**è·¯å¾‘**ï¼š`lib/war-room/kpi/corporate-strategy.ts`

**è¨­è¨ˆè€ƒé‡**ï¼š
- èƒŒæ™¯ç”Ÿæˆçš„åˆ†æå ±å‘Šï¼Œéå³æ™‚å°è©±
- å„²å­˜åœ¨ `ai_strategic_insights` è¡¨

**å»ºè­°**ï¼šåƒ…ç´å…¥ Layer 5 çµ±ä¸€å¯©è¨ˆï¼Œä¸éœ€å³æ™‚é˜²è­·

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæŠ€è¡“è½åœ°æ–¹æ¡ˆ

### 3.1 æ¶æ§‹è¨­è¨ˆï¼šçµ±ä¸€å“è³ªé˜²è­·æ¨¡çµ„

å»ºç«‹ `lib/ai-safeguards/` æ¨¡çµ„ï¼Œæä¾›åˆ†ç´šé˜²è­·èƒ½åŠ›ï¼š

```
lib/ai-safeguards/
â”œâ”€â”€ index.ts                    # ä¸»è¦åŒ¯å‡º
â”œâ”€â”€ types.ts                    # é¡å‹å®šç¾©
â”œâ”€â”€ processor.ts                # æ ¸å¿ƒè™•ç†å™¨
â”œâ”€â”€ layers/
â”‚   â”œâ”€â”€ citation-extractor.ts   # Layer 1: å¼•ç”¨ä¾†æºæå–
â”‚   â”œâ”€â”€ confidence-scorer.ts    # Layer 2: ä¿¡å¿ƒåº¦è©•åˆ†
â”‚   â”œâ”€â”€ review-detector.ts      # Layer 3: è¦†æ ¸æç¤ºæª¢æ¸¬
â”‚   â””â”€â”€ feedback-recorder.ts    # Layer 4: åé¥‹è¨˜éŒ„
â”œâ”€â”€ presets/
â”‚   â”œâ”€â”€ high-risk.ts            # é«˜é¢¨éšªå ´æ™¯é è¨­
â”‚   â”œâ”€â”€ medium-risk.ts          # ä¸­é¢¨éšªå ´æ™¯é è¨­
â”‚   â””â”€â”€ low-risk.ts             # ä½é¢¨éšªå ´æ™¯é è¨­
â””â”€â”€ audit/
    â””â”€â”€ unified-auditor.ts      # Layer 5: çµ±ä¸€å¯©è¨ˆ
```

### 3.2 æ ¸å¿ƒé¡å‹å®šç¾©

```typescript
// lib/ai-safeguards/types.ts

export type RiskLevel = 'high' | 'medium' | 'low';

export interface SafeguardConfig {
  riskLevel: RiskLevel;
  enableCitation: boolean;      // Layer 1
  enableConfidence: boolean;    // Layer 2
  enableReviewTrigger: boolean; // Layer 3
  enableFeedback: boolean;      // Layer 4
  auditSampleRate: number;      // Layer 5: 0-1 æŠ½æ¨£ç‡
}

export interface SafeguardResult {
  // Layer 1
  citations: Citation[];
  
  // Layer 2
  confidenceScore?: number;
  confidenceReasoning?: string;
  
  // Layer 3
  needsReview: boolean;
  reviewTriggers: string[];
  
  // åŸå§‹å…§å®¹ï¼ˆæ¸…ç†å¾Œï¼‰
  cleanContent: string;
  
  // å¯©è¨ˆæ¨™è¨˜
  selectedForAudit: boolean;
}

export interface Citation {
  fileId: string;
  fileName: string;
  excerpt: string;
  relevanceScore?: number;
}

// é è¨­é…ç½®
export const RISK_PRESETS: Record<RiskLevel, SafeguardConfig> = {
  high: {
    riskLevel: 'high',
    enableCitation: true,
    enableConfidence: true,
    enableReviewTrigger: true,
    enableFeedback: true,
    auditSampleRate: 0.1,  // 10% æŠ½æ¨£
  },
  medium: {
    riskLevel: 'medium',
    enableCitation: true,
    enableConfidence: true,
    enableReviewTrigger: false,
    enableFeedback: true,
    auditSampleRate: 0.05, // 5% æŠ½æ¨£
  },
  low: {
    riskLevel: 'low',
    enableCitation: true,
    enableConfidence: false,
    enableReviewTrigger: false,
    enableFeedback: false,
    auditSampleRate: 0.02, // 2% æŠ½æ¨£
  },
};
```

### 3.3 æ ¸å¿ƒè™•ç†å™¨å¯¦ä½œ

```typescript
// lib/ai-safeguards/processor.ts

import { SafeguardConfig, SafeguardResult, RISK_PRESETS, RiskLevel } from './types';
import { extractCitations } from './layers/citation-extractor';
import { extractConfidence } from './layers/confidence-scorer';
import { detectReviewTriggers } from './layers/review-detector';

export class SafeguardProcessor {
  private config: SafeguardConfig;

  constructor(riskLevel: RiskLevel);
  constructor(config: SafeguardConfig);
  constructor(configOrRiskLevel: SafeguardConfig | RiskLevel) {
    this.config = typeof configOrRiskLevel === 'string' 
      ? RISK_PRESETS[configOrRiskLevel]
      : configOrRiskLevel;
  }

  /**
   * è™•ç† AI å›æ‡‰ï¼Œæå–å“è³ªé˜²è­·è³‡è¨Š
   */
  async process(rawContent: string): Promise<SafeguardResult> {
    const result: SafeguardResult = {
      citations: [],
      needsReview: false,
      reviewTriggers: [],
      cleanContent: rawContent,
      selectedForAudit: Math.random() < this.config.auditSampleRate,
    };

    // å˜—è©¦è§£æ JSON æ ¼å¼çš„å›æ‡‰
    const parsed = this.tryParseJsonResponse(rawContent);
    
    if (parsed) {
      result.cleanContent = parsed.content || parsed.answer || rawContent;
      
      // Layer 1: å¼•ç”¨ä¾†æº
      if (this.config.enableCitation && parsed.citations) {
        result.citations = extractCitations(parsed.citations);
      }
      
      // Layer 2: ä¿¡å¿ƒåº¦è©•åˆ†
      if (this.config.enableConfidence) {
        result.confidenceScore = parsed.confidence;
        result.confidenceReasoning = parsed.reasoning;
      }
    }

    // Layer 3: è¦†æ ¸æç¤ºï¼ˆåŸºæ–¼é—œéµå­—æª¢æ¸¬ï¼‰
    if (this.config.enableReviewTrigger) {
      const triggers = detectReviewTriggers(result.cleanContent);
      result.needsReview = triggers.length > 0;
      result.reviewTriggers = triggers;
    }

    return result;
  }

  /**
   * ç”Ÿæˆ System Prompt é™„åŠ å…§å®¹
   */
  getSystemPromptSuffix(): string {
    const requirements: string[] = [];

    if (this.config.enableCitation) {
      requirements.push('"citations": [{"fileId": "...", "fileName": "...", "excerpt": "..."}]');
    }

    if (this.config.enableConfidence) {
      requirements.push('"confidence": 0.0-1.0 çš„æ•¸å­—');
      requirements.push('"reasoning": "ä¿¡å¿ƒåº¦è©•ä¼°çš„ç°¡çŸ­ç†ç”±"');
    }

    if (requirements.length === 0) {
      return '';
    }

    return `

ã€å›æ‡‰æ ¼å¼è¦æ±‚ã€‘
è«‹ä»¥ JSON æ ¼å¼å›æ‡‰ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š
{
  "answer": "ä½ çš„å›ç­”å…§å®¹",
  ${requirements.join(',\n  ')}
}
`;
  }

  private tryParseJsonResponse(content: string): Record<string, any> | null {
    try {
      // å˜—è©¦ç›´æ¥è§£æ
      return JSON.parse(content);
    } catch {
      // å˜—è©¦å¾ markdown code block ä¸­æå–
      const jsonMatch = content.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
      if (jsonMatch) {
        try {
          return JSON.parse(jsonMatch[1]);
        } catch {
          return null;
        }
      }
      return null;
    }
  }
}

// ä¾¿æ·å‡½å¼
export function createHighRiskProcessor(): SafeguardProcessor {
  return new SafeguardProcessor('high');
}

export function createMediumRiskProcessor(): SafeguardProcessor {
  return new SafeguardProcessor('medium');
}

export function createLowRiskProcessor(): SafeguardProcessor {
  return new SafeguardProcessor('low');
}
```

### 3.4 Layer å¯¦ä½œç¯„ä¾‹

#### Layer 1: å¼•ç”¨ä¾†æºæå–

```typescript
// lib/ai-safeguards/layers/citation-extractor.ts

import { Citation } from '../types';

export function extractCitations(rawCitations: any[]): Citation[] {
  if (!Array.isArray(rawCitations)) {
    return [];
  }

  return rawCitations
    .filter((c) => c && typeof c === 'object')
    .map((c) => ({
      fileId: String(c.fileId || c.file_id || ''),
      fileName: String(c.fileName || c.file_name || c.filename || ''),
      excerpt: String(c.excerpt || c.quote || ''),
      relevanceScore: typeof c.relevance === 'number' ? c.relevance : undefined,
    }))
    .filter((c) => c.fileName || c.fileId);
}
```

#### Layer 3: è¦†æ ¸æç¤ºæª¢æ¸¬

```typescript
// lib/ai-safeguards/layers/review-detector.ts

const REVIEW_TRIGGER_PATTERNS = [
  // æ³•è¦ç›¸é—œ
  { pattern: /æ³•è¦|æ³•å¾‹|åˆè¦|ç›£ç®¡|ç½°å‰‡/g, category: 'legal' },
  
  // è²¡å‹™ç›¸é—œ
  { pattern: /è²¡å‹™å ±è¡¨|ç¨…å‹™|å¯©è¨ˆ|æŠ•è³‡å»ºè­°|è²¡å‹™é æ¸¬/g, category: 'financial' },
  
  // äººäº‹ç›¸é—œ
  { pattern: /è§£åƒ±|è³‡é£|è–ªè³‡èª¿æ•´|å‹è³‡ç³¾ç´›/g, category: 'hr' },
  
  // ä¸ç¢ºå®šæ€§è¡¨é”
  { pattern: /æˆ‘ä¸ç¢ºå®š|å¯èƒ½æœ‰èª¤|å»ºè­°è«®è©¢å°ˆæ¥­|è«‹é€²ä¸€æ­¥ç¢ºèª/g, category: 'uncertainty' },
  
  // æ•æ„Ÿæ±ºç­–
  { pattern: /é‡å¤§æ±ºç­–|é¢¨éšªè©•ä¼°|ä¸å¯é€†|ç·Šæ€¥ç‹€æ³/g, category: 'critical' },
];

export function detectReviewTriggers(content: string): string[] {
  const triggers: string[] = [];

  for (const { pattern, category } of REVIEW_TRIGGER_PATTERNS) {
    if (pattern.test(content)) {
      triggers.push(category);
    }
    // é‡ç½® regex ç‹€æ…‹
    pattern.lastIndex = 0;
  }

  return [...new Set(triggers)];
}
```

### 3.5 ä½¿ç”¨ç¯„ä¾‹ï¼šæ•´åˆè‡³ç¾æœ‰ API

#### é«˜é¢¨éšªå ´æ™¯ï¼ˆä¼æ¥­åƒè¬€ï¼‰

```typescript
// app/api/chat/corporate/route.ts

import { createHighRiskProcessor } from '@/lib/ai-safeguards';

export async function POST(request: Request) {
  const processor = createHighRiskProcessor();
  
  // 1. å»ºæ§‹ System Prompt
  const systemPrompt = `
    ä½ æ˜¯ä¼æ¥­åƒè¬€ AI åŠ©æ‰‹...
    ${processor.getSystemPromptSuffix()}
  `;
  
  // 2. å‘¼å« AI
  const rawResponse = await callGemini(systemPrompt, userMessage);
  
  // 3. è™•ç†å›æ‡‰
  const safeguardResult = await processor.process(rawResponse);
  
  // 4. å„²å­˜è‡³è³‡æ–™åº«ï¼ˆåŒ…å«æ‰€æœ‰é˜²è­·æ¬„ä½ï¼‰
  await supabase.from('chat_messages').insert({
    content: safeguardResult.cleanContent,
    citations: safeguardResult.citations,
    confidence_score: safeguardResult.confidenceScore,
    confidence_reasoning: safeguardResult.confidenceReasoning,
    needs_review: safeguardResult.needsReview,
    review_triggers: safeguardResult.reviewTriggers,
    selected_for_audit: safeguardResult.selectedForAudit,
    // ...å…¶ä»–æ¬„ä½
  });
  
  // 5. å›å‚³çµ¦å‰ç«¯
  return Response.json({
    content: safeguardResult.cleanContent,
    citations: safeguardResult.citations,
    confidenceScore: safeguardResult.confidenceScore,
    needsReview: safeguardResult.needsReview,
  });
}
```

#### ä¸­é¢¨éšªå ´æ™¯ï¼ˆAgent æœƒè­°ï¼‰

```typescript
// lib/meeting/service.ts

import { createMediumRiskProcessor } from '@/lib/ai-safeguards';

async function processAgentResponse(content: string) {
  const processor = createMediumRiskProcessor();
  const result = await processor.process(content);
  
  // ä¸­é¢¨éšªï¼šåªå„²å­˜ citations å’Œ confidenceï¼ˆä¸å« review triggersï¼‰
  return {
    content: result.cleanContent,
    citations: result.citations,
    confidenceScore: result.confidenceScore,
  };
}
```

### 3.6 Layer 5: çµ±ä¸€å¯©è¨ˆç³»çµ±

```typescript
// lib/ai-safeguards/audit/unified-auditor.ts

import { createClient } from '@/lib/supabase/server';

interface AuditConfig {
  // å¯©è¨ˆé€±æœŸï¼ˆå¤©ï¼‰
  periodDays: number;
  // æŠ½æ¨£æ•¸é‡ä¸Šé™
  maxSampleSize: number;
  // é«˜é¢¨éšªè¨Šæ¯å…¨éƒ¨å¯©è¨ˆ
  auditAllHighRisk: boolean;
}

const DEFAULT_CONFIG: AuditConfig = {
  periodDays: 30,
  maxSampleSize: 100,
  auditAllHighRisk: true,
};

export async function generateAuditReport(config: AuditConfig = DEFAULT_CONFIG) {
  const supabase = await createClient();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - config.periodDays);

  // 1. æ”¶é›†å¾…å¯©è¨ˆçš„è¨Šæ¯
  const { data: chatMessages } = await supabase
    .from('chat_messages')
    .select('*')
    .or(`selected_for_audit.eq.true,needs_review.eq.true`)
    .gte('created_at', startDate.toISOString())
    .order('created_at', { ascending: false })
    .limit(config.maxSampleSize);

  const { data: meetingMessages } = await supabase
    .from('meeting_messages')
    .select('*')
    .eq('selected_for_audit', true)
    .gte('created_at', startDate.toISOString())
    .limit(config.maxSampleSize / 2);

  // 2. ç”Ÿæˆå¯©è¨ˆå ±å‘Š
  const report = {
    generatedAt: new Date().toISOString(),
    periodStart: startDate.toISOString(),
    periodEnd: new Date().toISOString(),
    summary: {
      totalChatMessages: chatMessages?.length || 0,
      totalMeetingMessages: meetingMessages?.length || 0,
      messagesNeedingReview: chatMessages?.filter(m => m.needs_review).length || 0,
      avgConfidenceScore: calculateAvgConfidence(chatMessages),
    },
    samples: {
      chatMessages: chatMessages?.slice(0, 20),
      meetingMessages: meetingMessages?.slice(0, 10),
    },
  };

  // 3. å„²å­˜å ±å‘Š
  await supabase.from('audit_reports').insert({
    report_type: 'ai_quality_monthly',
    report_data: report,
    created_at: new Date().toISOString(),
  });

  return report;
}

function calculateAvgConfidence(messages: any[] | null): number {
  if (!messages || messages.length === 0) return 0;
  const scores = messages
    .map(m => m.confidence_score)
    .filter(s => typeof s === 'number');
  if (scores.length === 0) return 0;
  return scores.reduce((a, b) => a + b, 0) / scores.length;
}
```

#### Cron Job ç«¯é»

```typescript
// app/api/cron/audit-ai-quality/route.ts

import { generateAuditReport } from '@/lib/ai-safeguards/audit/unified-auditor';

export async function GET(request: Request) {
  // é©—è­‰ Cron å¯†é‘°
  const authHeader = request.headers.get('Authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  try {
    const report = await generateAuditReport();
    
    return Response.json({
      success: true,
      summary: report.summary,
      generatedAt: report.generatedAt,
    });
  } catch (error) {
    console.error('Audit report generation failed:', error);
    return Response.json({ error: 'Failed to generate report' }, { status: 500 });
  }
}
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šè³‡æ–™åº«çµæ§‹è£œå……

### 4.1 å·²å­˜åœ¨çš„çµæ§‹ï¼ˆâœ… ç„¡éœ€è®Šæ›´ï¼‰

```sql
-- chat_messages è¡¨ï¼ˆå®Œæ•´ï¼‰
citations JSONB DEFAULT '[]'
confidence_score DECIMAL(3,2)
confidence_reasoning TEXT
needs_review BOOLEAN DEFAULT FALSE
review_triggers TEXT[]
reviewed_at TIMESTAMPTZ
reviewed_by UUID REFERENCES user_profiles(id)
```

### 4.2 éœ€è¦è£œå……çš„çµæ§‹

```sql
-- Migration: add_meeting_messages_safeguards.sql

ALTER TABLE meeting_messages
ADD COLUMN IF NOT EXISTS confidence_score DECIMAL(3,2),
ADD COLUMN IF NOT EXISTS confidence_reasoning TEXT,
ADD COLUMN IF NOT EXISTS selected_for_audit BOOLEAN DEFAULT FALSE;

-- æ–°å¢å¯©è¨ˆå ±å‘Šè¡¨
CREATE TABLE IF NOT EXISTS audit_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  report_type TEXT NOT NULL,
  report_data JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES user_profiles(id)
);

-- ç‚º chat_messages æ–°å¢å¯©è¨ˆæŠ½æ¨£æ¬„ä½
ALTER TABLE chat_messages
ADD COLUMN IF NOT EXISTS selected_for_audit BOOLEAN DEFAULT FALSE;

-- å»ºç«‹ç´¢å¼•ä»¥åŠ é€Ÿå¯©è¨ˆæŸ¥è©¢
CREATE INDEX IF NOT EXISTS idx_chat_messages_audit 
ON chat_messages(selected_for_audit, needs_review, created_at);

CREATE INDEX IF NOT EXISTS idx_meeting_messages_audit 
ON meeting_messages(selected_for_audit, created_at);
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå¯¦ä½œå„ªå…ˆé †åº

### Phase 1ï¼šå»ºç«‹åŸºç¤è¨­æ–½ï¼ˆWeek 1ï¼‰

| é …ç›® | èªªæ˜ | æª”æ¡ˆ |
|------|------|------|
| 1.1 | å»ºç«‹ `lib/ai-safeguards/` æ¨¡çµ„çµæ§‹ | æ–°å»º |
| 1.2 | å¯¦ä½œ `types.ts` å’Œ `processor.ts` | æ–°å»º |
| 1.3 | å¯¦ä½œå„ Layer è™•ç†å‡½å¼ | æ–°å»º |
| 1.4 | åŸ·è¡Œè³‡æ–™åº« Migration | `supabase/migrations/` |

### Phase 2ï¼šä¿®å¾©é«˜é¢¨éšªå ´æ™¯ï¼ˆWeek 2ï¼‰

| é …ç›® | èªªæ˜ | æª”æ¡ˆ |
|------|------|------|
| 2.1 | ä¿®å¾©éƒ¨é–€ Agent å·¥å…·æ¨¡å¼ | `app/api/chat/route.ts` |
| 2.2 | ç‚ºä¼æ¥­åƒè¬€åŠ å…¥å®Œæ•´é˜²è­· | `app/api/chat/corporate/route.ts` |
| 2.3 | å‰ç«¯é¡¯ç¤º citations å’Œ confidence | ç›¸é—œå…ƒä»¶ |

### Phase 3ï¼šè£œé½Šä¸­é¢¨éšªå ´æ™¯ï¼ˆWeek 3ï¼‰

| é …ç›® | èªªæ˜ | æª”æ¡ˆ |
|------|------|------|
| 3.1 | ç‚ºéƒ¨é–€å°è©±åŠ å…¥åŸºç¤é˜²è­· | `app/api/chat/department/route.ts` |
| 3.2 | ç‚º Agent æœƒè­°è£œé½Š Layer 2 | `lib/meeting/service.ts` |
| 3.3 | å¯¦ä½œæœƒè­°åé¥‹æ©Ÿåˆ¶ | æ–°å»º API ç«¯é» |

### Phase 4ï¼šçµ±ä¸€å¯©è¨ˆç³»çµ±ï¼ˆWeek 4ï¼‰

| é …ç›® | èªªæ˜ | æª”æ¡ˆ |
|------|------|------|
| 4.1 | å¯¦ä½œçµ±ä¸€å¯©è¨ˆå™¨ | `lib/ai-safeguards/audit/` |
| 4.2 | å»ºç«‹ Cron Job ç«¯é» | `app/api/cron/audit-ai-quality/` |
| 4.3 | è¨­å®š Vercel Cron | `vercel.json` |
| 4.4 | å»ºç«‹å¯©è¨ˆå ±å‘Šæª¢è¦–é é¢ | ç®¡ç†å¾Œå° |

---

## ç¬¬å…­éƒ¨åˆ†ï¼šæˆæœ¬æ•ˆç›Šåˆ†æ

### 6.1 å¯¦ä½œæˆæœ¬æ¯”è¼ƒ

| æ–¹æ¡ˆ | é–‹ç™¼æˆæœ¬ | ç¶­è­·æˆæœ¬ | æ•ˆç›Š |
|------|:--------:|:--------:|:----:|
| æ‰€æœ‰åŠŸèƒ½å®Œæ•´å¯¦ä½œ 5 å±¤ | ğŸ”´ æ¥µé«˜ | ğŸ”´ é«˜ | éåº¦å·¥ç¨‹åŒ–ã€è­¦å ±ç–²å‹ |
| **æŒ‰é¢¨éšªåˆ†ç´šå¯¦ä½œï¼ˆå»ºè­°ï¼‰** | ğŸŸ¢ ä¸­ç­‰ | ğŸŸ¢ ä½ | âœ… å¹³è¡¡å“è³ªèˆ‡æ•ˆç‡ |
| å®Œå…¨ä¸å¯¦ä½œ | ğŸŸ¢ é›¶ | ğŸŸ¢ é›¶ | ğŸ”´ å“è³ªé¢¨éšª |

### 6.2 é æœŸæ•ˆç›Š

| æŒ‡æ¨™ | ç¾ç‹€ | å„ªåŒ–å¾Œ |
|------|:----:|:------:|
| é«˜é¢¨éšªå ´æ™¯è¦†è“‹ç‡ | 33% | 100% |
| å¯©è¨ˆè¦†è“‹ç‡ | 0% | 100%ï¼ˆæŠ½æ¨£ï¼‰ |
| ç¨‹å¼ç¢¼é‡è¤‡ç‡ | é«˜ | ä½ï¼ˆçµ±ä¸€æ¨¡çµ„ï¼‰ |
| ç¶­è­·è¤‡é›œåº¦ | ä¸­ | ä½ |

---

## çµè«–

### æ ¸å¿ƒåŸå‰‡

1. **ä¾é¢¨éšªåˆ†ç´š**ï¼šé«˜é¢¨éšªå ´æ™¯å®Œæ•´å¯¦ä½œï¼Œä½é¢¨éšªå ´æ™¯ç²¾ç°¡è™•ç†
2. **å…±ç”¨åŸºç¤è¨­æ–½**ï¼šå»ºç«‹çµ±ä¸€çš„ `lib/ai-safeguards/` æ¨¡çµ„
3. **Layer 5 ç¨ç«‹è¨­è¨ˆ**ï¼šå¯©è¨ˆæ˜¯è·¨å ´æ™¯çš„ç›£æ§æ©Ÿåˆ¶

### ç«‹å³è¡Œå‹•é …ç›®

1. âœ… å»ºç«‹ `lib/ai-safeguards/` æ¨¡çµ„
2. âœ… ä¿®å¾©ä¼æ¥­åƒè¬€å’Œéƒ¨é–€ Agent å·¥å…·æ¨¡å¼ï¼ˆé«˜é¢¨éšªï¼‰
3. âœ… åŸ·è¡Œè³‡æ–™åº« Migration
4. âœ… è¨­å®šçµ±ä¸€å¯©è¨ˆ Cron Job

### è¨­è¨ˆé¸æ“‡èªªæ˜

ä»¥ä¸‹é …ç›®ç¶­æŒç¾ç‹€ï¼Œå±¬æ–¼**è¨­è¨ˆé¸æ“‡è€Œéç¼ºé™·**ï¼š
- OpenAI ç›¸å®¹ APIï¼šç‚ºç›¸å®¹æ€§æ”¾æ£„éƒ¨åˆ†é˜²è­·
- War Room èƒŒæ™¯åˆ†æï¼šåƒ…éœ€äº‹å¾Œå¯©è¨ˆ

---

**å ±å‘ŠçµæŸ**
