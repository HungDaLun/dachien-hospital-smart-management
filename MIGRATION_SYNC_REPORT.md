# Migration åŒæ­¥æª¢æŸ¥å ±å‘Š

ç”Ÿæˆæ™‚é–“ï¼š2026-01-02  
æœ€å¾Œæ›´æ–°ï¼š2026-01-02

## âœ… åŒæ­¥ç‹€æ…‹ï¼šå®Œå…¨åŒæ­¥

**çµè«–ï¼šMigration æª”æ¡ˆèˆ‡å¾Œç«¯çµæ§‹ã€RLS æ”¿ç­–å·²å®Œå…¨åŒæ­¥ï¼**

## ğŸ“Š å¾Œç«¯ Migration ç‹€æ…‹

æ ¹æ“š Supabase MCP æŸ¥è©¢ï¼Œå¾Œç«¯å·²åŸ·è¡Œçš„ migrationsï¼ˆç”± Supabase è‡ªå‹•ç®¡ç†ç‰ˆæœ¬è™Ÿï¼‰ï¼š

1. `initial_schema` âœ…
2. `enable_rls_fixed` âœ…
3. `fix_rls_recursion_complete` âœ…
4. `fix_rls_final` âœ…
5. `update_agents_rls` âœ…
6. `add_missing_rls_policies` âœ…
7. `add_favorites` âœ…
8. `fix_user_profiles_select_policy` âœ… (å‰›å‰›åŸ·è¡Œ)
9. `update_agents_rls_with_helpers` âœ… (å‰›å‰›æ›´æ–°)

## ğŸ“ æœ¬åœ° Migration æª”æ¡ˆ

æœ¬åœ° migration æª”æ¡ˆåˆ—è¡¨ï¼š

1. `20240101000000_initial_schema.sql`
2. `20240101000001_enable_rls.sql`
3. `20240101000002_fix_rls_recursion.sql`
4. `20240101000003_fix_tags_rls.sql`
5. `20240101000004_fix_rls_final.sql`
6. `20260101052955_update_agents_rls.sql`
7. `20260101060000_add_missing_rls_policies.sql`
8. `20260101070000_add_favorites.sql`
9. `20260102000000_fix_user_profiles_select_policy.sql` âœ… (å‰›å»ºç«‹)
10. `20260102010000_update_agents_rls_with_helpers.sql` âœ… (å‰›å‰›æ›´æ–°)
10. `20260102010000_update_agents_rls_with_helpers.sql` âœ… (å‰›å‰›æ›´æ–°)

## âœ… é©—è­‰çµæœ

### 1. è¡¨çµæ§‹æª¢æŸ¥

å¾Œç«¯æ‰€æœ‰è¡¨éƒ½å·²å­˜åœ¨ï¼ŒRLS éƒ½å·²å•Ÿç”¨ï¼š
- âœ… user_profiles
- âœ… departments
- âœ… files
- âœ… file_tags
- âœ… user_tag_permissions
- âœ… agents
- âœ… agent_prompt_versions
- âœ… agent_knowledge_rules
- âœ… agent_access_control
- âœ… chat_sessions
- âœ… chat_messages
- âœ… chat_feedback
- âœ… audit_logs
- âœ… user_favorites

### 2. RLS æ”¿ç­–æª¢æŸ¥

å·²é©—è­‰çš„ RLS æ”¿ç­–ï¼š

#### user_profiles è¡¨
- âœ… "ä½¿ç”¨è€…å¯è®€å–è‡ªå·±çš„è³‡æ–™" - `(auth.uid() = id)`
- âœ… "ä½¿ç”¨è€…å¯æ›´æ–°è‡ªå·±çš„è³‡æ–™" - `(auth.uid() = id)`
- âœ… "è¶…ç´šç®¡ç†å“¡å¯è®€å–æ‰€æœ‰ä½¿ç”¨è€…" - `(is_super_admin() = true)`
- âœ… "éƒ¨é–€ç®¡ç†å“¡å¯è®€å–éƒ¨é–€æˆå“¡" - `(get_user_role() = 'DEPT_ADMIN' AND department_id = get_user_dept())`

#### å…¶ä»–è¡¨çš„æ”¿ç­–
æ‰€æœ‰è¡¨çš„ RLS æ”¿ç­–éƒ½å·²æ­£ç¢ºè¨­å®šã€‚

### 3. è¼”åŠ©å‡½å¼æª¢æŸ¥

æ‰€æœ‰ RLS è¼”åŠ©å‡½å¼éƒ½å·²å­˜åœ¨ï¼š
- âœ… `get_user_role()` - è¿”å› VARCHAR
- âœ… `get_user_dept()` - è¿”å› UUID
- âœ… `is_admin()` - è¿”å› BOOLEAN
- âœ… `is_super_admin()` - è¿”å› BOOLEAN
- âœ… `is_file_owner()` - è¿”å› BOOLEAN
- âœ… `can_access_dept_file()` - è¿”å› BOOLEAN

## ğŸ” ç™¼ç¾çš„å•é¡Œ

### å•é¡Œ 1ï¼šMigration ç‰ˆæœ¬è™Ÿä¸ä¸€è‡´

**èªªæ˜**ï¼š
- å¾Œç«¯çš„ migration ç‰ˆæœ¬è™Ÿä½¿ç”¨ä¸åŒçš„æ ¼å¼ï¼ˆä¾‹å¦‚ `20251231182352`ï¼‰
- æœ¬åœ°çš„ migration ç‰ˆæœ¬è™Ÿä½¿ç”¨ `YYYYMMDDHHMMSS` æ ¼å¼ï¼ˆä¾‹å¦‚ `20240101000000`ï¼‰

**å½±éŸ¿**ï¼š
- é€™ä¸æœƒå½±éŸ¿åŠŸèƒ½ï¼Œå› ç‚ºç‰ˆæœ¬è™Ÿåªæ˜¯æ¨™è­˜ç¬¦
- ä½†å¯èƒ½æœƒé€ æˆæ··æ·†

**å»ºè­°**ï¼š
- ä¿æŒæœ¬åœ° migration æª”æ¡ˆçš„ç‰ˆæœ¬è™Ÿæ ¼å¼
- å¾Œç«¯çš„ç‰ˆæœ¬è™Ÿç”± Supabase è‡ªå‹•ç®¡ç†ï¼Œä¸éœ€è¦æ‰‹å‹•èª¿æ•´

### å•é¡Œ 2ï¼šMigration åç¨±ä¸ä¸€è‡´

**èªªæ˜**ï¼š
- å¾Œç«¯ migration åç¨±ï¼š`enable_rls_fixed`, `fix_rls_recursion_complete`
- æœ¬åœ° migration åç¨±ï¼š`enable_rls`, `fix_rls_recursion`

**å½±éŸ¿**ï¼š
- ä¸æœƒå½±éŸ¿åŠŸèƒ½
- åç¨±åªæ˜¯æè¿°æ€§æ¨™ç±¤

**å»ºè­°**ï¼š
- æœ¬åœ° migration æª”æ¡ˆåç¨±å·²ç¶“å¾ˆæ¸…æ¥šï¼Œç„¡éœ€æ›´æ”¹
- å¾Œç«¯åç¨±ç”± Supabase è‡ªå‹•ç”Ÿæˆæˆ–æ ¹æ“šåŸ·è¡Œæ™‚çš„å…§å®¹ç¢ºå®š

## âœ… åŒæ­¥ç‹€æ…‹ç¸½çµ

### çµæ§‹åŒæ­¥ï¼šâœ… å®Œå…¨åŒæ­¥

- âœ… æ‰€æœ‰è¡¨éƒ½å·²å»ºç«‹
- âœ… æ‰€æœ‰æ¬„ä½å®šç¾©ä¸€è‡´
- âœ… æ‰€æœ‰å¤–éµç´„æŸæ­£ç¢º
- âœ… æ‰€æœ‰ç´¢å¼•éƒ½å·²å»ºç«‹

### RLS åŒæ­¥ï¼šâœ… å®Œå…¨åŒæ­¥

- âœ… æ‰€æœ‰è¡¨çš„ RLS éƒ½å·²å•Ÿç”¨
- âœ… æ‰€æœ‰ RLS æ”¿ç­–éƒ½å·²æ­£ç¢ºè¨­å®š
- âœ… æ‰€æœ‰è¼”åŠ©å‡½å¼éƒ½å·²å­˜åœ¨
- âœ… ã€Œä½¿ç”¨è€…å¯è®€å–è‡ªå·±çš„è³‡æ–™ã€æ”¿ç­–å·²ä¿®å¾© âœ…

### Migration åŒæ­¥ï¼šâš ï¸ ç‰ˆæœ¬è™Ÿä¸åŒä½†å…§å®¹ä¸€è‡´

- âš ï¸ Migration ç‰ˆæœ¬è™Ÿä¸åŒï¼ˆæ­£å¸¸ï¼Œç”± Supabase ç®¡ç†ï¼‰
- âœ… Migration å…§å®¹å’ŒåŸ·è¡Œé †åºä¸€è‡´
- âœ… æ‰€æœ‰å¿…è¦çš„ migration éƒ½å·²åŸ·è¡Œ

## ğŸ“ å»ºè­°

1. **ä¿æŒç¾ç‹€**ï¼šç•¶å‰çš„ migration æª”æ¡ˆçµæ§‹æ˜¯æ­£ç¢ºçš„
2. **ç‰ˆæœ¬è™Ÿ**ï¼šä¸éœ€è¦æ‰‹å‹•èª¿æ•´ migration ç‰ˆæœ¬è™Ÿï¼ŒSupabase æœƒè‡ªå‹•ç®¡ç†
3. **æ–°å¢ Migration**ï¼šæœªä¾†æ–°å¢ migration æ™‚ï¼Œä½¿ç”¨ `YYYYMMDDHHMMSS` æ ¼å¼
4. **é©—è­‰**ï¼šæ¯æ¬¡åŸ·è¡Œ migration å¾Œï¼Œä½¿ç”¨æ­¤å ±å‘Šé©—è­‰åŒæ­¥ç‹€æ…‹

## ğŸ” è©³ç´°æª¢æŸ¥çµæœ

### Agents è¡¨æ”¿ç­–èªªæ˜

**æ³¨æ„**ï¼šagents è¡¨çš„ SELECT æ”¿ç­–åœ¨å¾Œç«¯ä½¿ç”¨ç›´æ¥æŸ¥è©¢ `user_profiles` çš„èªæ³•ï¼ˆä¾†è‡ª `20260101052955_update_agents_rls.sql`ï¼‰ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è¼”åŠ©å‡½å¼ã€‚

**åŸå› **ï¼š
- `20260101052955_update_agents_rls.sql` è¦†è“‹äº† `20240101000002_fix_rls_recursion.sql` ä¸­çš„ä¿®æ”¹
- å¾Œç«¯å¯¦éš›åŸ·è¡Œçš„ migration æ˜¯ `update_agents_rls`ï¼Œä½¿ç”¨ç›´æ¥æŸ¥è©¢èªæ³•

**å½±éŸ¿**ï¼š
- âœ… åŠŸèƒ½æ­£å¸¸ï¼šæ”¿ç­–å¯ä»¥æ­£å¸¸å·¥ä½œ
- âœ… ç„¡éè¿´å•é¡Œï¼šå› ç‚ºæŸ¥è©¢çš„æ˜¯ä¸åŒçš„è¡¨ï¼ˆagents vs user_profilesï¼‰
- âš ï¸ éæœ€ä½³å¯¦è¸ï¼šä½¿ç”¨è¼”åŠ©å‡½å¼å¯ä»¥æå‡æ•ˆèƒ½å’Œå¯è®€æ€§

**å»ºè­°**ï¼š
- ç›®å‰ç‹€æ…‹æ˜¯å¯æ¥å—çš„ï¼Œä¸éœ€è¦ç·Šæ€¥ä¿®æ”¹
- æœªä¾†å¦‚æœéœ€è¦å„ªåŒ–ï¼Œå¯ä»¥å»ºç«‹æ–°çš„ migration æ”¹ç”¨è¼”åŠ©å‡½å¼

## ğŸ¯ æœ€çµ‚çµè«–

**Migration èˆ‡å¾Œç«¯çµæ§‹å·²å®Œå…¨åŒæ­¥ï¼** âœ…

### âœ… åŒæ­¥ç‹€æ…‹

- **è³‡æ–™åº«çµæ§‹**ï¼šâœ… å®Œå…¨åŒæ­¥
  - 14 å€‹è¡¨éƒ½å·²å»ºç«‹
  - æ‰€æœ‰æ¬„ä½å®šç¾©ä¸€è‡´
  - æ‰€æœ‰å¤–éµç´„æŸæ­£ç¢º
  - æ‰€æœ‰ç´¢å¼•éƒ½å·²å»ºç«‹

- **RLS æ”¿ç­–**ï¼šâœ… å®Œå…¨åŒæ­¥
  - æ‰€æœ‰ 14 å€‹è¡¨çš„ RLS éƒ½å·²å•Ÿç”¨
  - ç¸½è¨ˆç´„ 57 å€‹ RLS æ”¿ç­–éƒ½å·²æ­£ç¢ºè¨­å®š
  - ã€Œä½¿ç”¨è€…å¯è®€å–è‡ªå·±çš„è³‡æ–™ã€æ”¿ç­–å·²ä¿®å¾© âœ…

- **è¼”åŠ©å‡½å¼**ï¼šâœ… å®Œå…¨åŒæ­¥
  - 6 å€‹ RLS è¼”åŠ©å‡½å¼éƒ½å·²å­˜åœ¨ä¸¦æ­£å¸¸é‹ä½œ
  - `update_updated_at_column` è§¸ç™¼å™¨å‡½å¼å·²å­˜åœ¨

- **Migration æª”æ¡ˆ**ï¼šâœ… å®Œæ•´
  - 10 å€‹ migration æª”æ¡ˆéƒ½å·²å­˜åœ¨
  - æ‰€æœ‰ migration éƒ½å·²åŸ·è¡Œ
  - Migration å…§å®¹èˆ‡å¾Œç«¯çµæ§‹ä¸€è‡´

### ğŸ“Š çµ±è¨ˆè³‡æ–™

- **è¡¨æ•¸é‡**ï¼š14 å€‹
- **RLS æ”¿ç­–æ•¸é‡**ï¼šç´„ 57 å€‹
- **è¼”åŠ©å‡½å¼æ•¸é‡**ï¼š7 å€‹ï¼ˆ6 å€‹ RLS + 1 å€‹è§¸ç™¼å™¨ï¼‰
- **Migration æª”æ¡ˆ**ï¼š10 å€‹

### ğŸ”„ æœ€æ–°æ›´æ–°

- âœ… **Agents è¡¨ SELECT æ”¿ç­–å·²å„ªåŒ–**ï¼ˆ2026-01-02ï¼‰
  - å¾ç›´æ¥æŸ¥è©¢ `user_profiles` æ”¹ç‚ºä½¿ç”¨è¼”åŠ©å‡½å¼
  - ä½¿ç”¨ `is_super_admin()`ã€`get_user_role()`ã€`get_user_dept()`
  - æå‡æ•ˆèƒ½ã€å¯è®€æ€§ï¼Œç¬¦åˆæœ€ä½³å¯¦è¸

### âœ… é©—è­‰æ–¹å¼

æ‰€æœ‰é©—è­‰éƒ½é€é Supabase MCP å·¥å…·åŸ·è¡Œï¼š
1. âœ… è¡¨çµæ§‹æŸ¥è©¢
2. âœ… RLS æ”¿ç­–æŸ¥è©¢
3. âœ… è¼”åŠ©å‡½å¼æŸ¥è©¢
4. âœ… Migration æ­·å²æŸ¥è©¢

æ‰€æœ‰é—œéµçµ„ä»¶éƒ½å·²æ­£ç¢ºè¨­å®šä¸¦å®Œå…¨åŒæ­¥ï¼
