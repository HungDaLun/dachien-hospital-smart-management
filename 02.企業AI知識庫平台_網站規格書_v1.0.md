# ä¼æ¥­ AI çŸ¥è­˜åº«èˆ‡ Agent ç®¡ç†å¹³å° - ç¶²ç«™è¦æ ¼æ›¸ (System Specification) v1.1

**æ–‡ä»¶ç‰ˆæœ¬ï¼š** 1.1
**æ—¥æœŸï¼š** 2026-01-01
**å°ˆæ¡ˆåç¨±ï¼š** Enterprise AI Knowledge Agent Platform (EAKAP)
**æ ¸å¿ƒæŠ€è¡“ï¼š** 
1. **Primary Storage**: S3-compatible Object Storage (Generic Source of Truth) - AWS S3 (Cloud) or **MinIO (Local Appliance)**
2. **Runtime Engine**: Google Gemini 1.5/2.0 API (File Search & Gems Concept) with Multi-Model Adapter Design

---

## 1. å°ˆæ¡ˆæ¦‚è¿° (Project Overview)

### 1.1 ç›®æ¨™ (Vision)
æ‰“é€ ä¸€å€‹ä¼æ¥­ç´šçš„ã€ŒAI Agent å·¥å» èˆ‡çŸ¥è­˜é‹ç±Œä¸­å¿ƒã€ã€‚æœ¬å¹³å°æ—¨åœ¨è§£æ±ºä¼æ¥­å°å…¥ AI æ™‚é¢è‡¨çš„ã€ŒçŸ¥è­˜åˆ†æ•£ã€ã€ã€Œæ“ä½œæ¨™æº–ä¸ä¸€ã€èˆ‡ã€Œæ¬Šé™å¤±æ§ã€ä¸‰å¤§ç—›é»ã€‚
æœ¬å°ˆæ¡ˆæ¡ç”¨ **ã€ŒHub and Spoke (è»¸è¼»å¼)ã€** æ¶æ§‹ï¼šä»¥è‡ªå»ºå„²å­˜ç‚ºæ ¸å¿ƒ (Hub)ï¼Œå‹•æ…‹åŒæ­¥è‡³å„é¡ AI æ¨¡å‹ (Spoke)ã€‚é¦–éšæ®µå°å…¥ Gemini File Search æŠ€è¡“ä½œç‚ºä¸»è¦é‹ç®—å¼•æ“ï¼Œä½†ä¿ç•™æœªä¾†éš¨æ™‚åˆ‡æ›è‡³ OpenAI/Claude ç­‰æ¨¡å‹çš„å½ˆæ€§ï¼Œç¢ºä¿ä¼æ¥­æ“æœ‰è³‡æ–™ä¸»æ¬Šã€‚

### 1.2 æ ¸å¿ƒåƒ¹å€¼ä¸»å¼µ
1.  **é›†ä¸­åŒ–çŸ¥è­˜ç®¡ç†**ï¼šå–®ä¸€ä¾†æºï¼ˆSingle Source of Truthï¼‰ï¼Œé¿å…åŒæ¨£çš„æ–‡ä»¶åœ¨ä¸åŒ Agent é–“é‡è¤‡ä¸Šå‚³ä¸”ç‰ˆæœ¬ä¸ä¸€ã€‚
2.  **æ¨™æº–åŒ– Agent ç”¢å‡º**ï¼šé€éçµ±ä¸€çš„ System Prompt èˆ‡å¼·åˆ¶çš„çŸ¥è­˜åº«ç¶å®šï¼Œç¢ºä¿å…¨å…¬å¸ç”¢å‡ºå“è³ªä¸€è‡´ã€‚
3.  **ç²¾ç´°åŒ–æ¬Šé™æ§ç®¡**ï¼šçµåˆ Role-Based Access Control (RBAC) èˆ‡æ¨™ç±¤ç³»çµ±ï¼Œç¢ºä¿ã€Œå°çš„äººç”¨å°çš„ Agentï¼Œè®€å°çš„è³‡æ–™ã€ã€‚

---

## 2. ç³»çµ±æ¶æ§‹ (System Architecture)

### 2.1 é«˜å±¤æ¬¡æ¶æ§‹åœ– (High-Level Design - Hub & Spoke)

```mermaid
graph TD
    User[ä½¿ç”¨è€… (Web)] -->|HTTPS| Frontend[å‰ç«¯ Next.js]
    Frontend -->|API| Backend[å¾Œç«¯ API Gateway]
    
    subgraph SovereignZone[ä¼æ¥­è‡ªæœ‰è³‡ç”¢å€]
        Backend --> Auth[æ¬Šé™ç®¡ç†ç³»çµ±]
        Backend --> AgentMgr[Agent é…ç½®ç®¡ç†å™¨]
        Backend --> KMS[çŸ¥è­˜åº«æ¨™ç±¤ç³»çµ±]
        Backend --> DB[(PostgreSQL)]
        Backend --> S3[(S3 Storage)]
    end
    
    subgraph RuntimeGemini[AI é‹ç®—å±¤ - Gemini]
        Backend -.->|Sync| G_Storage[Gemini File Storage]
        Backend -->|Generate| G_Model[Gemini Models]
        G_Model <-->|Retrieval| G_Storage
    end
    
    subgraph RuntimeFuture[AI é‹ç®—å±¤ - é ç•™æ“´å±•]
        Backend -.->|Sync| O_Vector[OpenAI / Claude]
    end
```

### 2.2 æ ¸å¿ƒæµç¨‹é‚è¼¯ (Dual-Layer Workflow)
1.  **çŸ¥è­˜ä¸Šå‚³ (Hub Layer)**ï¼š
    *   æ–‡ä»¶ä¸Šå‚³è‡³å¹³å° â†’ å­˜å…¥ **Primary Storage (S3)**ã€‚
    *   è³‡æ–™åº«è¨˜éŒ„ï¼š`file_id` + `s3_path` + `ä¼æ¥­æ¨™ç±¤(Tags)` + `æ¬Šé™è¨­å®š`ã€‚
2.  **çŸ¥è­˜åŒæ­¥ (Spoke Layer)**ï¼š
    *   èƒŒæ™¯ä»»å‹™ (Worker) è§¸ç™¼ï¼šè®€å– S3 æª”æ¡ˆ â†’ å‘¼å« Gemini File API ä¸Šå‚³ã€‚
    *   å–å¾— `google_file_uri` â†’ å›å¯«å…¥è³‡æ–™åº«å°æ‡‰æ¬„ä½ã€‚
3.  **Agent å»ºæ§‹**ï¼šç®¡ç†å“¡è¨­å®š Prompt + é¸æ“‡éœ€è¦çš„ `Tags`ã€‚
4.  **å°è©±åŸ·è¡Œ (Runtime)**ï¼š
    *   ä½¿ç”¨è€…ç™¼é€è¨Šæ¯ã€‚
    *   å¹³å°æ’ˆå‡ºè©² Agent ç¶å®šæ–‡ä»¶çš„ `google_file_uri` (ä½¿ç”¨å¿«å–å±¤è·¯å¾‘)ã€‚
    *   å‘¼å« Gemini API é€²è¡Œå›ç­”ã€‚

### 2.3 å¤–éƒ¨æ•´åˆæ¶æ§‹ (Enterprise Brain Integration)
æœ¬å¹³å°ä½œç‚ºã€ŒHeadless Knowledge Serviceã€ï¼Œæä¾›æ¨™æº–ä»‹é¢ä¾›å¤–éƒ¨å·¥å…·èª¿ç”¨ã€‚

```mermaid
graph LR
    Ext[å¤–éƒ¨å·¥å…·<br/>Open WebUI / Copilot] -->|OpenAI API Protocol| API[æœ¬å¹³å° API Gateway<br/>/api/openai/v1]
    API -->|Auth & Router| Brain[ä¼æ¥­å¤§è…¦æ ¸å¿ƒ]
    Brain -->|Injection| Prompt[æ³¨å…¥ K-0 æŒ‡ä»¤]
    Brain -->|Retrieval| Knowledge[æ’ˆå– K-1~K-10 çŸ¥è­˜]
    Brain -->|Inference| Model[åº•å±¤æ¨¡å‹ Gemini]
    Brain -.->|Log| Audit[ç¨½æ ¸ç´€éŒ„]
```

*   **ç›¸å®¹æ€§**ï¼šå®Œå…¨ç›¸å®¹ OpenAI Chat Completions API æ ¼å¼ã€‚
*   **é€æ˜ä»£ç† (Transparent Proxy)**ï¼šå¤–éƒ¨å·¥å…·åªéœ€è¨­å®š Base URL æŒ‡å‘æœ¬å¹³å°ï¼Œç„¡éœ€æ„ŸçŸ¥å…§éƒ¨æ˜¯ä½¿ç”¨ Gemini æˆ–å…¶ä»–æ¨¡å‹ã€‚
*   **ä¼ºæœå™¨ç«¯æŒ‡ä»¤æ³¨å…¥ (Server-side Prompt Injection)**ï¼šSystem Prompt èˆ‡ RAG é‚è¼¯ç”±æœ¬å¹³å°å¾Œç«¯å¼·åˆ¶åŸ·è¡Œï¼Œå¤–éƒ¨å·¥å…·ç„¡æ³•ç¹éã€‚

---

## 3. ä½¿ç”¨è€…è§’è‰²èˆ‡æ¬Šé™ (User Roles & Permissions)

| è§’è‰² | ä»£è™Ÿ | æ¬Šé™æè¿° | å…¸å‹ä½¿ç”¨è€… |
| :--- | :--- | :--- | :--- |
| **è¶…ç´šç®¡ç†å“¡** | `SUPER_ADMIN` | **å…¨èƒ½æ¬Šé™**ã€‚å¯ç®¡ç†æ‰€æœ‰éƒ¨é–€ã€æ‰€æœ‰ Agentã€æ‰€æœ‰æ–‡ä»¶ã€æ‰€æœ‰äººå“¡è¨­å®šã€‚ | çŸ¥è­˜é•· (CKO)ã€IT ä¸»ç®¡ |
| **éƒ¨é–€ç®¡ç†å“¡** | `DEPT_ADMIN` | **éƒ¨é–€ç´šå…¨æ¬Š**ã€‚åƒ…èƒ½ç®¡ç†æ‰€å±¬éƒ¨é–€çš„ Agent èˆ‡æ–‡ä»¶ã€‚ç„¡æ³•çœ‹è¦‹å…¶ä»–éƒ¨é–€è³‡æ–™ã€‚ | éƒ¨é–€ä¸»ç®¡ |
| **çŸ¥è­˜ç¶­è­·è€…** | `EDITOR` | **åƒ…ç¶­è­·å…§å®¹**ã€‚å¯ä¸Šå‚³/æ›´æ–°/åˆªé™¤æ–‡ä»¶ï¼Œåœ¨èŠå¤©å®¤æ¸¬è©¦ Agentï¼Œä½†**ä¸å¯ä¿®æ”¹ Agent çš„ System Prompt**ã€‚ | è³‡æ·±å“¡å·¥ã€å°ˆæ¡ˆç¶“ç† |
| **ä¸€èˆ¬ä½¿ç”¨è€…** | `USER` | **åƒ…ä½¿ç”¨**ã€‚åªèƒ½èˆ‡è¢«æˆæ¬Šçš„ Agent å°è©±ã€‚ç„¡æ³•æ¥è§¸å¾Œå°ã€‚ | ä¸€èˆ¬å“¡å·¥ã€å¯¦ç¿’ç”Ÿ |

---

## 4. åŠŸèƒ½æ¨¡çµ„è¦æ ¼ (Functional Requirements)

### 4.1 èº«ä»½é©—è­‰èˆ‡æˆæ¬Šæ¨¡çµ„ (IAM)
*   **F-01 ç™»å…¥/ç™»å‡º**ï¼šæ”¯æ´ Email/Password ç™»å…¥ï¼Œé ç•™ SSO (Google/Microsoft Entra ID) ä»‹æ¥ç©ºé–“ã€‚
*   **F-02 è§’è‰²ç®¡ç†**ï¼šå¾Œå°å¯è¨­å®šä½¿ç”¨è€…çš„è§’è‰²ï¼ˆUser/Editor/Adminï¼‰èˆ‡æ‰€å±¬éƒ¨é–€ï¼ˆSales/Marketing/ITï¼‰ã€‚
*   **F-03 API Key ç®¡ç†**ï¼šç³»çµ±çµ±ä¸€ç®¡ç† Google Gemini API Keyï¼Œä¸è®“çµ‚ç«¯ä½¿ç”¨è€…æ¥è§¸ Keyã€‚

### 4.2 çŸ¥è­˜åº«ç®¡ç†ç³»çµ± (KMS) - "The Brain"
æ­¤æ¨¡çµ„è² è²¬ç®¡ç†åŸæœ¬æ§‹æƒ³ä¸­çš„ã€Œ15 å€‹è³‡æ–™å¤¾ã€ï¼Œä½†é€é**æ¨™ç±¤ (Tags)** è®“çµæ§‹æ›´éˆæ´»ã€‚

*   **F-04 å¤šæ ¼å¼æ–‡ä»¶ä¸Šå‚³**ï¼š
    *   æ”¯æ´æ ¼å¼ï¼šPDF, DOCX, XLSX, PPTX, CSV, MD, TXT, HTMLã€‚
    *   å–®æª”é™åˆ¶ï¼šä¾ç…§ Gemini API é™åˆ¶ (é€šå¸¸ 2GB å…§)ï¼Œå¹³å°å¯è¨­å®šè¼ƒä¿å®ˆé™åˆ¶ (å¦‚ 100MB) ä»¥å„ªåŒ–é«”é©—ã€‚
*   **F-05 æ™ºæ…§æ¨™ç±¤ç³»çµ± (Smart Tagging)**ï¼š
    *   **æ¶æ§‹**ï¼šæ¯å€‹æª”æ¡ˆå¯æ“æœ‰å¤šå€‹æ¨™ç±¤ã€‚
    *   **å¼·åˆ¶æ¨™ç±¤**ï¼šä¸Šå‚³æ™‚å¿…é ˆé¸æ“‡ã€Œéƒ¨é–€æ­¸å±¬ã€(å¦‚ï¼šè¡ŒéŠ·éƒ¨)ã€‚
    *   **è‡ªè¨‚æ¨™ç±¤**ï¼šå¯è‡ªè¨‚å°ˆæ¡ˆæ¨™ç±¤ (å¦‚ï¼š2025_Q1, ç«¶å“åˆ†æ, æ©Ÿå¯†ç­‰ç´šA)ã€‚
*   **F-06 æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶**ï¼š
    *   é‚è¼¯ï¼šåŒä¸€ä»½æ–‡ä»¶ (Filename ç›¸åŒ) å†æ¬¡ä¸Šå‚³æ™‚ï¼Œè‡ªå‹•å°å­˜èˆŠç‰ˆ `file_uri`ï¼Œç”¢ç”Ÿæ–°ç‰ˆ `file_uri`ï¼Œä¸¦æ›´æ–°æ‰€æœ‰ç¶å®šæ­¤æ–‡ä»¶çš„ Agentã€‚
*   **F-07 çŸ¥è­˜ç”Ÿå‘½é€±æœŸ**ï¼šè¨­å®šæ–‡ä»¶ã€Œæœ‰æ•ˆæœŸé™ã€ï¼ŒéæœŸè‡ªå‹•å¾ Agent çš„ Context ä¸­ç§»é™¤ï¼ˆLogical Deleteï¼‰ã€‚

### 4.3 Agent å»ºæ§‹å·¥å»  (Agent Ops) - "The Factory"
*   **F-08 Agent å‰µå»ºèˆ‡é…ç½®**ï¼š
    *   è¨­å®šåç¨±ã€é ­åƒã€æè¿°ã€‚
    *   **System Prompt ç·¨è¼¯å™¨**ï¼šæ”¯æ´ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯éš¨æ™‚å›æ»¾èˆŠç‰ˆæŒ‡ä»¤ã€‚
    *   **æ¨¡å‹åƒæ•¸**ï¼šé¸æ“‡æ¨¡å‹ç‰ˆæœ¬ (Gemini 1.5 Flash / Pro)ã€Temperature (å‰µæ„åº¦)ã€‚
*   **F-09 çŸ¥è­˜ç¶å®š (Knowledge Binding)**ï¼š
    *   **æ¨¡å¼ A (è³‡æ–™å¤¾æ¨¡å¼)**ï¼šç›´æ¥å‹¾é¸ã€Œè¡ŒéŠ·éƒ¨è³‡æ–™å¤¾ã€ï¼Œè©²è³‡æ–™å¤¾ä¸‹æ‰€æœ‰æª”æ¡ˆè‡ªå‹•æ›è¼‰ã€‚
    *   **æ¨¡å¼ B (æ¨™ç±¤æ¨¡å¼)**ï¼šè¨­å®šè¦å‰‡ `Tag == 'è¡ŒéŠ·éƒ¨' AND Tag == 'å…¬é—œç¨¿'`ï¼Œæœªä¾†åªè¦ä¸Šå‚³ç¬¦åˆæ­¤æ¨™ç±¤çš„æ–°æª”æ¡ˆï¼ŒAgent è‡ªå‹•è®€å–ï¼Œç„¡é ˆé‡æ–°è¨­å®šã€‚
*   **F-10 æ¬Šé™æŒ‡æ´¾**ï¼š
    *   è¨­å®šå“ªäº›ä½¿ç”¨è€…æˆ–éƒ¨é–€å¯ä»¥ä½¿ç”¨é€™éš» Agentã€‚

### 4.4 å‰å°å°è©±ä»‹é¢ (Chat UI) - "The Interface"
*   **F-11 Agent é¸æ“‡å¤§å»³**ï¼š
    *   æ ¹æ“šä½¿ç”¨è€…æ¬Šé™ï¼Œé¡¯ç¤ºå¯ç”¨çš„ Agent å¡ç‰‡åˆ—è¡¨ã€‚
    *   æ”¯æ´ä¾éƒ¨é–€ã€æˆ‘çš„æœ€æ„›ç¯©é¸ã€‚
*   **F-12 å°è©±è¦–çª—**ï¼š
    *   é¡ ChatGPT/Gemini ä»‹é¢ã€‚
    *   æ”¯æ´ Markdown æ¸²æŸ“ (è¡¨æ ¼ã€ç¨‹å¼ç¢¼)ã€‚
    *   æ”¯æ´ä¸²æµè¼¸å‡º (Streaming) æå‡é«”æ„Ÿé€Ÿåº¦ã€‚
*   **F-13 å¼•ç”¨ä¾†æºé¡¯ç¤º (Citations)**ï¼š
    *   **é—œéµåŠŸèƒ½**ï¼šç•¶ Agent å›ç­”å…§å®¹ä¾†è‡ªçŸ¥è­˜åº«æ™‚ï¼Œå¿…é ˆé¡¯ç¤º `[1]` å¼•ç”¨æ¨™è¨˜ã€‚
    *   é»æ“Šæ¨™è¨˜å¯å±•é–‹å´é‚Šæ¬„ï¼Œé¡¯ç¤ºåŸå§‹æ–‡ä»¶åç¨±èˆ‡ç›¸é—œæ®µè½æ‘˜è¦ï¼ˆå³ä½¿åŸå§‹æ–‡ä»¶æ˜¯ PPT åœ–è¡¨ä¹Ÿèƒ½é¡¯ç¤ºæè¿°ï¼‰ã€‚

### 4.5 ç³»çµ±ç®¡ç†èˆ‡ç¨½æ ¸ (Admin & Audit)
*   **F-14 ä½¿ç”¨é‡å„€è¡¨æ¿**ï¼šé¡¯ç¤º Token æ¶ˆè€—é‡ã€æœ€ç†±é–€çš„ Agentã€æœ€å¸¸è¢«å¼•ç”¨çš„æ–‡ä»¶ã€‚
*   **F-15 æ“ä½œç¨½æ ¸æ—¥èªŒ (Audit Log)**ï¼š
    *   è¨˜éŒ„èª° (User) åœ¨ä½•æ™‚ (Time) å°å“ªéš» Agent (Agent ID) å•äº†ä»€éº¼ (Prompt) ä»¥åŠç³»çµ±å›äº†ä»€éº¼ã€‚
    *   è¨˜éŒ„èª° (User) åœ¨ä½•æ™‚ (Time) å°å“ªéš» Agent (Agent ID) å•äº†ä»€éº¼ (Prompt) ä»¥åŠç³»çµ±å›äº†ä»€éº¼ã€‚
    *   è¨˜éŒ„å¾Œå°çš„æ‰€æœ‰ä¿®æ”¹è¡Œç‚º (æ–‡ä»¶åˆªé™¤ã€æ¬Šé™è®Šæ›´)ã€‚

### 4.6 å¤–éƒ¨æ•´åˆä»‹é¢ (OpenAI Bridge)
*   **F-16 OpenAI ç›¸å®¹ API**ï¼š
    *   æä¾› `/api/openai/v1/chat/completions` ç«¯é»ã€‚
    *   æ”¯æ´ `model` åƒæ•¸å°æ‡‰è‡³å…§éƒ¨çš„ `agent_id` æˆ– `agent_name`ã€‚
    *   æ”¯æ´ Streaming Response (SSE)ã€‚
    *   **æ¬Šé™é©—è­‰**ï¼šä½¿ç”¨å¹³å°æ ¸ç™¼çš„ API Key (Bearer Token) é€²è¡Œé©—è­‰ã€‚

---

## 5. è³‡æ–™åº«è¨­è¨ˆæ¦‚å¿µ (Schema Concept)

åƒ…åˆ—å‡ºæ ¸å¿ƒ Table çµæ§‹ï¼Œä½¿ç”¨ PostgreSQLã€‚

```sql
-- ä½¿ç”¨è€…èˆ‡çµ„ç¹”
TABLE users (id, email, password_hash, role, department_id, created_at)
TABLE departments (id, name, description)

-- çŸ¥è­˜åº« (Dual-Layer Storage Design)
TABLE files (
  id, 
  filename, 
  
  -- Layer 1: Sovereign Storage (Master Copy)
  s3_storage_path,  -- e.g., "s3://corp-bucket/marketing/2025_plan.pdf"
  s3_etag,          -- Checksum for versioning
  
  -- Layer 2: Runtime Adapters
  gemini_file_uri,  -- ç›®å‰ä½¿ç”¨ï¼š"https://generativeai.google.com/..."
  gemini_state,     -- "SYNCED", "PROCESSING", "FAILED"
  
  -- Future Proofing (é ç•™æ¬„ä½)
  openai_file_id,   -- æœªä¾†é ç•™
  claude_file_id,   -- æœªä¾†é ç•™

  mime_type, 
  size_bytes, 
  uploaded_by, 
  is_active,        -- ç‰ˆæœ¬æ§åˆ¶ç”¨
  created_at
)

-- æª”æ¡ˆæ¨™ç±¤ (å¤šå°å¤š)
TABLE file_tags (file_id, tag_key, tag_value)

-- Agent è¨­å®š
TABLE agents (
  id, 
  name, 
  system_prompt, 
  model_version, 
  department_id,    -- æ­¸å±¬éƒ¨é–€
  created_by
)

-- Agent èˆ‡çŸ¥è­˜çš„é—œè¯ (å®šç¾©é€™éš» Agent èƒ½çœ‹å“ªäº›æª”æ¡ˆ)
TABLE agent_knowledge_rules (
  agent_id, 
  rule_type,        -- "FOLDER" or "TAG"
  rule_value        -- e.g., "tag:marketing"
)

-- æ¬Šé™æŒ‡æ´¾ (å®šç¾©èª°èƒ½ç”¨é€™éš» Agent)
TABLE agent_access_control (
  agent_id,
  user_id_or_dept_id,
  can_access
)
```

---

## 6. éåŠŸèƒ½éœ€æ±‚ (Non-functional Requirements)

### 6.1 è³‡æ–™å®‰å…¨æ€§ (Data Security)
*   **å‚³è¼¸åŠ å¯†**ï¼šå…¨ç«™å¼·åˆ¶ HTTPS (TLS 1.3)ã€‚
*   **éš”é›¢æ©Ÿåˆ¶**ï¼šé€éå¾Œç«¯é‚è¼¯ç¢ºä¿ User A çµ•å°ç„¡æ³•å‘¼å«æœªæˆæ¬Š Agent çš„ API endpointã€‚
*   **æª”æ¡ˆæ¬Šé™**ï¼šGoogle File URI é›–ç„¶æ˜¯å…¬é–‹é€£çµ (éœ€é€é API Key å­˜å–)ï¼Œä½†æ‡‰ç”¨å±¤å¿…é ˆåš Proxy æˆ– Signed URL æ©Ÿåˆ¶ï¼Œä¸ç›´æ¥æš´éœ² URI çµ¦å‰ç«¯ã€‚

### 6.2 æ•ˆèƒ½è¦æ±‚ (Performance)
*   **å›æ‡‰é€Ÿåº¦**ï¼šAgent é¦–å­—å›æ‡‰æ™‚é–“ (TTFB) < 2 ç§’ (é€é Streaming)ã€‚
*   **ä½µç™¼é‡**ï¼šæ”¯æ´è‡³å°‘ 50 äººåŒæ™‚åœ¨ç·šå°è©±ã€‚

### 6.3 å¯ç¶­è­·æ€§ (Maintainability)
*   **å‰å¾Œç«¯åˆ†é›¢**ï¼šç¢ºä¿æœªä¾†å¯ç¨ç«‹æ›´æ› AI æ¨¡å‹å±¤æˆ–å‰ç«¯ä»‹é¢ã€‚
*   **å¾Œç«¯ä¸­ç«‹æ€§ (Backend Neutrality)**ï¼š
    *   å¿…é ˆä½¿ç”¨æ¨™æº– **Supabase SDK (`@supabase/supabase-js`)** æ–¼å¾Œç«¯ API å±¤é€²è¡Œè³‡æ–™å­˜å–ã€‚
    *   ç¦æ­¢ Hard-code è³‡æ–™åº«é€£ç·šå­—ä¸²ï¼Œå¿…é ˆé€éç’°å¢ƒè®Šæ•¸ (`NEXT_PUBLIC_SUPABASE_URL`) åˆ‡æ›ã€‚
    *   ç›®çš„ï¼šç¢ºä¿åŒä¸€å¥—ç¨‹å¼ç¢¼å¯ç„¡ç—›åˆ‡æ› **Supabase Cloud (SaaSæ¨¡å¼)** èˆ‡ **Self-hosted Supabase (Docker/Mac Miniæ¨¡å¼)**ã€‚
    *   **æ¶æ§‹è¦ç¯„**ï¼šæ‰€æœ‰è³‡æ–™å¯«å…¥èˆ‡æ ¸å¿ƒé‚è¼¯æŸ¥è©¢å¿…é ˆç¶“é API Gatewayï¼Œç¦æ­¢å‰ç«¯ç›´æ¥ä½¿ç”¨ Supabase Client æ“ä½œè³‡æ–™åº«ï¼Œä»¥ç¢ºä¿é€™å¥—ç³»çµ±èƒ½å®Œå…¨ç¨ç«‹é‹ä½œæ–¼å°é–‰ç’°å¢ƒã€‚
*   **Docker åŒ–**ï¼šå…¨ç³»çµ±æ”¯æ´ Docker Compose ä¸€éµéƒ¨ç½²ï¼Œæ–¹ä¾¿åœ¨ç§æœ‰é›²æˆ–åœ°ç«¯ä¼ºæœå™¨é‹è¡Œã€‚

---

## 7. é–‹ç™¼æ™‚ç¨‹é ä¼° (Roadmap)

### Phase 1: MVP (æ­¤éšæ®µç›®æ¨™ï¼šè®“æ‚¨èƒ½ç”¨) - é è¨ˆ 4 é€±
*   Week 1: ç’°å¢ƒå»ºç½® (Next.js + Supabase/Postgres)ã€Gemini API ä¸²æ¥æ¸¬è©¦ã€‚
*   Week 2: çŸ¥è­˜åº«ä¸Šå‚³åŠŸèƒ½ (File API)ã€ç°¡å–®æ¨™ç±¤ç³»çµ±ã€‚
*   Week 3: Agent è¨­å®šå¾Œå° (Prompt + ç¶å®šæ¨™ç±¤)ã€åŸºç¤ Chat ä»‹é¢ã€‚
*   Week 4: åŸºç¤æ¬Šé™ (Admin vs User)ã€æ•´åˆæ¸¬è©¦ã€ä¸Šç·šã€‚

### Phase 2: ä¼æ¥­ç´šå„ªåŒ– (æ­¤éšæ®µç›®æ¨™ï¼šå¥½ç®¡ç†) - é è¨ˆ 4-6 é€±
*   å¯¦ä½œå®Œæ•´çš„éƒ¨é–€æ¬Šé™ (RBAC)ã€‚
*   å¯¦ä½œå¼•ç”¨ä¾†æº (Citations) çš„å‰ç«¯è¦–è¦ºåŒ–ã€‚
*   å¯¦ä½œç¨½æ ¸æ—¥èªŒèˆ‡ç”¨é‡çµ±è¨ˆã€‚

---

## 8. ä¸€é«”æ©Ÿè½åœ°éƒ¨ç½²æŒ‡å— (Appliance Deployment Guide - Mac Mini Edition)

æœ¬ç« ç¯€è©³è¿°å¦‚ä½•å°‡ EAKAP å¹³å°å°è£ç‚ºç¡¬é«”ç”¢å“äº¤ä»˜ã€‚

### 8.1 ç¡¬é«”è¦æ ¼å»ºè­° (Hardware Query)
*   **æ©Ÿå‹**ï¼šApple Mac Mini (æ¨è–¦ M2 æˆ– M4 æ™¶ç‰‡ç‰ˆæœ¬)ã€‚
*   **è¨˜æ†¶é«”**ï¼šè‡³å°‘ 16GB (é‹è¡Œ Docker æµæš¢åº¦éœ€æ±‚)ã€‚
*   **å„²å­˜**ï¼šè‡³å°‘ 512GB SSD (å­˜æ”¾æœ¬åœ° MinIO æ–‡ä»¶åº«)ã€‚
*   **ç¶²è·¯**ï¼šGigabit Ethernet (ç¢ºä¿å…§ç¶²å‚³è¼¸é€Ÿåº¦)ã€‚

### 8.2 æœ¬åœ°ç«¯è»Ÿé«”å †ç–Š (Local Software Stack)
åœ¨ç¡¬é«”æ¨¡å¼ä¸‹ï¼ŒåŸæœ¬çš„é›²ç«¯ S3 å°‡è¢« **MinIO** å–ä»£ï¼Œå¯¦ç¾å®Œå…¨æœ¬åœ°åŒ–å„²å­˜ã€‚

```mermaid
graph TD
    subgraph "Mac Mini (Local Device)"
        OS[macOS Sonoma/Sequoia]
        Docker[OrbStack / Docker Desktop]
        
        subgraph "Docker Containers"
            Next[å‰ç«¯ Next.js]
            Node[å¾Œç«¯ API]
            PG[(PostgreSQL DB)]
            MinIO[(MinIO Object Storage)]
        end
    end
    
    subgraph "Cloud"
        Gemini[Google Gemini API]
    end
    
    User[å…§ç¶²ä½¿ç”¨è€…] -->|http://ai-brain.local| Next
    Node -->|Internal Network| PG
    Node -->|Internal Network| MinIO
    Node -->|Encrypted HTTPS| Gemini
```

### 8.3 å‡ºå» é è¨­æµç¨‹ (Factory Setup SOP)
**ç”±æ‚¨çš„æŠ€è¡“åœ˜éšŠåœ¨å‡ºè²¨å‰åŸ·è¡Œï¼š**

1.  **ç³»çµ±åˆå§‹åŒ–**ï¼š
    *   è¨­å®š macOS è‡ªå‹•ç™»å…¥ã€é–‹å•Ÿé ç«¯ç®¡ç† (SSH/VNC)ã€‚
    *   è¨­å®šå›ºå®š Hostname (å¦‚ `ai-brain`)ã€‚
2.  **ç’°å¢ƒå»ºç½®**ï¼š
    *   å®‰è£ **OrbStack** (æ¯” Docker Desktop æ›´è¼•é‡ã€æ•ˆèƒ½æ›´å¥½ï¼Œé©åˆ Mac)ã€‚
    *   å®‰è£ Node.js, Python ç­‰ Runtimeã€‚
3.  **éƒ¨ç½²æ‡‰ç”¨**ï¼š
    *   å°‡ EAKAP çš„ Docker Image æ‹‰å–è‡³æœ¬åœ°ã€‚
    *   è¨­å®š `docker-compose.yml` è‡ªå‹•éš¨é–‹æ©Ÿå•Ÿå‹• (Restart Policy: always)ã€‚
    *   åˆå§‹åŒ– PostgreSQL Schemaã€‚
    *   åˆå§‹åŒ– MinIO Bucketsã€‚
4.  **ç¶²è·¯å»£æ’­è¨­å®š**ï¼š
    *   å•Ÿç”¨ mDNS (Bonjour)ï¼Œç¢ºä¿å€ç¶²å…§å¯é€é `http://ai-brain.local` è¨ªå•ï¼Œç„¡éœ€æ‰“ IPã€‚

### 8.4 å®¢æˆ¶é–‹ç®±æ“ä½œæµç¨‹ (Customer Onboarding)
**å®¢æˆ¶æ”¶åˆ°æ©Ÿå™¨å¾Œçš„æ­¥é©Ÿï¼š**

1.  **ç¡¬é«”é€£æ¥**ï¼šæ¥ä¸Šé›»æºï¼Œå°‡ç¶²è·¯ç·šé€£æ¥è‡³å…¬å¸åˆ†äº«å™¨/äº¤æ›å™¨ã€‚é–‹æ©Ÿã€‚
2.  **åˆå§‹åŒ–è¨­å®š**ï¼š
    *   åœ¨å…¬å¸å…§ä»»ä¸€é›»è…¦ç€è¦½å™¨è¼¸å…¥ `http://ai-brain.local`ã€‚
    *   å‡ºç¾ã€Œç³»çµ±åˆå§‹åŒ–å¼•å°ã€ç•«é¢ã€‚
3.  **é‡‘é‘°ç¶å®š**ï¼š
    *   ç•«é¢æç¤ºè¼¸å…¥ **Gemini API Key** (æˆ–ç”±æ‚¨ä»£ç®¡è¼¸å…¥)ã€‚
    *   è¨­å®šç¬¬ä¸€çµ„ç®¡ç†å“¡å¸³è™Ÿå¯†ç¢¼ã€‚
4.  **é–‹å§‹ä½¿ç”¨**ï¼š
    *   é€²å…¥é¦–é ï¼Œé–‹å§‹ä¸Šå‚³æ–‡ä»¶å»ºç«‹çŸ¥è­˜åº«ã€‚
    *   æ‰€æœ‰æ–‡ä»¶å°‡å„²å­˜åœ¨ Mac Mini çš„ç¡¬ç¢Ÿä¸­ (MinIO)ï¼Œåƒ…åœ¨å°è©±æ™‚åŒæ­¥è‡³ Geminiã€‚

### 8.5 ç¶­è­·èˆ‡æ›´æ–°æ©Ÿåˆ¶
*   **è»Ÿé«”æ›´æ–°**ï¼šæˆ‘å€‘é–‹ç™¼ä¸€å€‹ç°¡å–®çš„ "Update Button" åœ¨å¾Œå°ï¼Œé»æ“Šå¾Œé€é Git Pull æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼ä¸¦é‡å•Ÿ Docker å®¹å™¨ã€‚
*   **é ç«¯æ’éŒ¯**ï¼šå¯é è£ **Tailscale**ï¼Œè®“æ‚¨åœ¨ç²å¾—å®¢æˆ¶æˆæ¬Šä¸‹ï¼Œé€éå…§ç¶²ç©¿é€é€²è¡Œé ç«¯ç¶­ä¿®ã€‚

---

## 9. å‰ç«¯è¨­è¨ˆè¦ç¯„ (UI/UX Design System)

æœ¬ç« ç¯€å®šç¾© EAKAP å¹³å°çš„è¦–è¦ºè¨­è¨ˆæ¨™æº–ï¼Œç¢ºä¿é–‹ç™¼åœ˜éšŠç”¢å‡ºä¸€è‡´ä¸”å°ˆæ¥­çš„ä½¿ç”¨è€…ä»‹é¢ã€‚

### 9.1 è¨­è¨ˆç†å¿µ (Design Philosophy)

| æ ¸å¿ƒåŸå‰‡ | èªªæ˜ |
| :--- | :--- |
| **Light & Airy** | ä»¥æ˜äº®ç™½è‰²ç‚ºåŸºåº•ï¼Œæ­é…æŸ”å’Œæ¼¸å±¤ï¼Œç‡Ÿé€ é–‹é—Šå°ˆæ¥­æ„Ÿ |
| **Modern Minimalism** | å»é™¤å†—é¤˜è£é£¾ï¼Œèšç„¦å…§å®¹èˆ‡åŠŸèƒ½ï¼Œé«”ç¾ç¾ä»£ç§‘æŠ€ç¾å­¸ |
| **Trust & Clarity** | é€éæ¸…æ™°çš„è³‡è¨Šå±¤ç´šèˆ‡ä¸€è‡´çš„äº’å‹•å›é¥‹ï¼Œå»ºç«‹ä½¿ç”¨è€…ä¿¡ä»» |
| **Glassmorphism Accent** | é—œéµå€å¡Šä½¿ç”¨æ¯›ç»ç’ƒæ•ˆæœ (Frosted Glass)ï¼Œå¢æ·»å±¤æ¬¡èˆ‡ç¾ä»£æ„Ÿ |

### 9.2 è‰²å½©ç³»çµ± (Color Palette)

æ¡ç”¨æ˜äº®å°ˆæ¥­çš„è‰²å½©çµ„åˆï¼Œä»¥è—ç´«è‰²èª¿ç‚ºä¸»è‰²ï¼Œå‚³é” AI ç§‘æŠ€èˆ‡ä¼æ¥­å°ˆæ¥­æ„Ÿã€‚

```css
/* ===== ä¸»è‰²èª¿ (Primary) ===== */
--color-primary-50:  hsl(230, 100%, 97%);   /* æ¥µæ·ºèƒŒæ™¯ */
--color-primary-100: hsl(230, 96%, 94%);    /* æ·ºèƒŒæ™¯ Hover */
--color-primary-200: hsl(230, 94%, 86%);    /* è¼•é‡è£é£¾ */
--color-primary-500: hsl(230, 85%, 60%);    /* ä¸»è‰² - æŒ‰éˆ•ã€é€£çµ */
--color-primary-600: hsl(230, 80%, 52%);    /* ä¸»è‰² Hover */
--color-primary-700: hsl(230, 75%, 44%);    /* ä¸»è‰² Active */

/* ===== è¼”åŠ©è‰² (Secondary - æ¼¸å±¤ç”¨) ===== */
--color-secondary-400: hsl(280, 70%, 65%);  /* ç´«è‰²æ¼¸å±¤èµ·é» */
--color-secondary-500: hsl(280, 65%, 55%);  /* ç´«è‰²ä¸»èª¿ */

/* ===== ä¸­æ€§è‰² (Neutral) ===== */
--color-white:       hsl(0, 0%, 100%);      /* ç´”ç™½ - å¡ç‰‡èƒŒæ™¯ */
--color-gray-50:     hsl(220, 20%, 98%);    /* é é¢èƒŒæ™¯ */
--color-gray-100:    hsl(220, 18%, 96%);    /* å€å¡Šåˆ†éš” */
--color-gray-200:    hsl(220, 15%, 91%);    /* é‚Šæ¡† */
--color-gray-400:    hsl(220, 10%, 62%);    /* æ¬¡è¦æ–‡å­— */
--color-gray-600:    hsl(220, 12%, 42%);    /* ä¸»è¦æ–‡å­— */
--color-gray-800:    hsl(220, 15%, 22%);    /* æ¨™é¡Œæ–‡å­— */
--color-gray-900:    hsl(220, 18%, 12%);    /* å¼·èª¿æ–‡å­— */

/* ===== èªæ„è‰² (Semantic) ===== */
--color-success-50:  hsl(145, 80%, 96%);
--color-success-500: hsl(145, 65%, 42%);    /* æˆåŠŸ - ç¶ è‰² */
--color-warning-50:  hsl(38, 95%, 95%);
--color-warning-500: hsl(38, 90%, 50%);     /* è­¦å‘Š - ç¥ç€è‰² */
--color-error-50:    hsl(0, 85%, 97%);
--color-error-500:   hsl(0, 75%, 55%);      /* éŒ¯èª¤ - ç´…è‰² */
--color-info-50:     hsl(200, 90%, 96%);
--color-info-500:    hsl(200, 85%, 50%);    /* è³‡è¨Š - å¤©è—è‰² */

/* ===== ç‰¹æ•ˆè‰² (Effects) ===== */
--gradient-hero: linear-gradient(135deg, hsl(230, 85%, 60%) 0%, hsl(280, 70%, 60%) 100%);
--gradient-card: linear-gradient(180deg, hsl(0, 0%, 100%) 0%, hsl(220, 20%, 98%) 100%);
--shadow-soft:   0 4px 20px hsla(230, 50%, 30%, 0.08);
--shadow-medium: 0 8px 32px hsla(230, 50%, 30%, 0.12);
--shadow-strong: 0 16px 48px hsla(230, 50%, 30%, 0.16);
--glass-bg:      hsla(0, 0%, 100%, 0.7);
--glass-blur:    blur(12px);
```

### 9.3 å­—é«”è¦ç¯„ (Typography)

| ç”¨é€” | å­—é«”å †ç–Š | æ¬Šé‡ | å¤§å° |
| :--- | :--- | :--- | :--- |
| **æ¨™é¡Œ (H1-H3)** | `'Inter', 'Noto Sans TC', system-ui, sans-serif` | 600-700 | 2rem / 1.5rem / 1.25rem |
| **æ­£æ–‡ (Body)** | `'Inter', 'Noto Sans TC', system-ui, sans-serif` | 400 | 1rem (16px) |
| **è¼”åŠ©èªªæ˜** | åŒä¸Š | 400 | 0.875rem (14px) |
| **ç¨‹å¼ç¢¼** | `'JetBrains Mono', 'Fira Code', monospace` | 400 | 0.875rem |

**è¡Œé«˜è¦ç¯„**ï¼š

*   æ¨™é¡Œï¼š1.3
*   æ­£æ–‡ï¼š1.6
*   ç¨‹å¼ç¢¼å€å¡Šï¼š1.5

### 9.4 é–“è·èˆ‡æ ¼ç·šç³»çµ± (Spacing & Grid)

```css
/* 8px åŸºç¤å–®ä½é–“è·ç³»çµ± */
--space-1:  0.25rem;   /* 4px */
--space-2:  0.5rem;    /* 8px */
--space-3:  0.75rem;   /* 12px */
--space-4:  1rem;      /* 16px */
--space-5:  1.5rem;    /* 24px */
--space-6:  2rem;      /* 32px */
--space-8:  3rem;      /* 48px */
--space-10: 4rem;      /* 64px */

/* åœ“è§’ç³»çµ± */
--radius-sm:   6px;
--radius-md:   10px;
--radius-lg:   16px;
--radius-xl:   24px;
--radius-full: 9999px;
```

**æ ¼ç·šç³»çµ±**ï¼š12 æ¬„æ ¼ç·šï¼Œé–“è· 24pxï¼Œæœ€å¤§å¯¬åº¦ 1280pxã€‚

### 9.5 éŸ¿æ‡‰å¼æ–·é» (Responsive Breakpoints)

| æ–·é»åç¨± | æœ€å°å¯¬åº¦ | é©ç”¨è£ç½® | æ¬„æ•¸ |
| :--- | :--- | :--- | :--- |
| `mobile` | 0px | æ‰‹æ©Ÿ | 4 æ¬„ |
| `tablet` | 640px | å¹³æ¿ç›´ç«‹ | 8 æ¬„ |
| `laptop` | 1024px | ç­†é›»/å¹³æ¿æ©«å‘ | 12 æ¬„ |
| `desktop` | 1280px | æ¡Œæ©Ÿ | 12 æ¬„ |
| `wide` | 1536px | å¤§è¢å¹• | 12 æ¬„ |

### 9.6 æ ¸å¿ƒ UI å…ƒä»¶è¦æ ¼ (Component Specifications)

#### 9.6.1 æŒ‰éˆ• (Buttons)

| è®Šé«” | æ¨£å¼èªªæ˜ | ä½¿ç”¨å ´æ™¯ |
| :--- | :--- | :--- |
| **Primary** | ä¸»è‰²æ¼¸å±¤å¡«å…… + ç™½å­— + è¼•é™°å½± | ä¸»è¦è¡Œå‹• (CTA) |
| **Secondary** | ç™½è‰²å¡«å…… + ä¸»è‰²é‚Šæ¡† + ä¸»è‰²æ–‡å­— | æ¬¡è¦è¡Œå‹• |
| **Ghost** | é€æ˜èƒŒæ™¯ + ä¸»è‰²æ–‡å­— | è¼”åŠ©æ“ä½œ |
| **Danger** | éŒ¯èª¤è‰²å¡«å…… + ç™½å­— | åˆªé™¤ã€åœç”¨ |

**æŒ‰éˆ•å°ºå¯¸**ï¼š

*   Small: `height: 32px; padding: 0 12px; font-size: 14px;`
*   Medium: `height: 40px; padding: 0 16px; font-size: 14px;`
*   Large: `height: 48px; padding: 0 24px; font-size: 16px;`

**äº’å‹•ç‹€æ…‹**ï¼š

*   Hover: `transform: translateY(-1px); box-shadow: var(--shadow-medium);`
*   Active: `transform: translateY(0); box-shadow: var(--shadow-soft);`
*   Disabled: `opacity: 0.5; cursor: not-allowed;`

#### 9.6.2 å¡ç‰‡ (Cards)

```css
.card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--color-gray-100);
    padding: var(--space-5);
    transition: all 0.2s ease;
}

.card:hover {
    box-shadow: var(--shadow-medium);
    transform: translateY(-2px);
}

/* æ¯›ç»ç’ƒå¡ç‰‡ (ç‰¹æ®Šå ´æ™¯) */
.card-glass {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
}
```

#### 9.6.3 å°è©±æ°£æ³¡ (Chat Bubbles)

| é¡å‹ | æ¨£å¼ |
| :--- | :--- |
| **ä½¿ç”¨è€…è¨Šæ¯** | ä¸»è‰²æ¼¸å±¤èƒŒæ™¯ + ç™½è‰²æ–‡å­— + å³å°é½Š |
| **Agent å›è¦†** | ç™½è‰²èƒŒæ™¯ + ç°è‰²æ–‡å­— + å·¦å°é½Š + è¼•é‚Šæ¡† |
| **ç³»çµ±æç¤º** | æ·ºè³‡è¨Šè‰²èƒŒæ™¯ + ç½®ä¸­ + å°å­— |

#### 9.6.4 è¼¸å…¥æ¡† (Input Fields)

```css
.input {
    height: 44px;
    padding: 0 var(--space-4);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-md);
    background: var(--color-white);
    font-size: 1rem;
    transition: all 0.15s ease;
}

.input:focus {
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 3px var(--color-primary-100);
    outline: none;
}

.input:invalid {
    border-color: var(--color-error-500);
}
```

### 9.7 å‹•ç•«èˆ‡å¾®äº’å‹• (Animations & Micro-interactions)

```css
/* å…¨åŸŸéå ´æ›²ç·š */
--ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
--ease-in-out:   cubic-bezier(0.4, 0, 0.2, 1);

/* é é¢è¼‰å…¥å‹•ç•« */
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* éª¨æ¶å±é–ƒçˆ */
@keyframes shimmer {
    0%   { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* AI æ€è€ƒä¸­å‹•ç•« (ä¸‰é»è·³å‹•) */
@keyframes thinking {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-4px); }
}
```

**å‹•ç•«è¦ç¯„**ï¼š

| å ´æ™¯ | æ™‚é•· | æ›²ç·š |
| :--- | :--- | :--- |
| æŒ‰éˆ• Hover | 150ms | ease |
| å¡ç‰‡ Hover | 200ms | ease-out |
| é é¢éå ´ | 300ms | ease-out-expo |
| Modal å±•é–‹ | 250ms | ease-out-expo |
| Toast æ»‘å…¥ | 200ms | ease-out |

### 9.8 åœ–ç¤ºç³»çµ± (Iconography)

*   **åœ–ç¤ºåº«**ï¼šLucide Icons (è¼•é‡ã€ä¸€è‡´æ€§é«˜)ã€‚
*   **é è¨­å°ºå¯¸**ï¼š20px Ã— 20pxã€‚
*   **ç²—ç´°**ï¼šStroke Width 1.5pxã€‚
*   **è‰²å½©**ï¼šç¹¼æ‰¿çˆ¶å…ƒç´  `currentColor`ã€‚

### 9.9 é é¢ä½ˆå±€æ¨¡æ¿ (Layout Templates)

#### 9.9.1 å¾Œå°ç®¡ç†ä»‹é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGO   â”‚  æœå°‹åˆ—                  â”‚  é€šçŸ¥  â”‚  ç”¨æˆ¶é ­åƒ     â”‚ <- Header (64px)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                    â”‚
â”‚  å´é‚Š   â”‚                                                    â”‚
â”‚  å°èˆª   â”‚              ä¸»å…§å®¹å€åŸŸ                            â”‚
â”‚  (240px)â”‚              (è‡ªé©æ‡‰å¯¬åº¦)                          â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.9.2 å°è©±ä»‹é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† è¿”å›   â”‚  Agent åç¨± + ç‹€æ…‹                 â”‚  è¨­å®š âš™ï¸   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚                      å°è©±è¨Šæ¯å€åŸŸ                            â”‚
â”‚                    (å‚ç›´æ²å‹•å€åŸŸ)                            â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“  â”‚  è¼¸å…¥è¨Šæ¯...                                â”‚  ç™¼é€ â–¶ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. å®Œæ•´æ¬Šé™å­˜å–æ§åˆ¶çŸ©é™£ (RBAC Matrix)

æœ¬ç« ç¯€è©³ç´°å®šç¾©å„è§’è‰²å°ç³»çµ±åŠŸèƒ½èˆ‡è³‡æ–™çš„å­˜å–æ¬Šé™ã€‚

### 10.1 åŠŸèƒ½æ¬Šé™çŸ©é™£ (Feature Access Matrix)

| åŠŸèƒ½æ¨¡çµ„ | æ“ä½œ | SUPER_ADMIN | DEPT_ADMIN | EDITOR | USER |
| :--- | :--- | :---: | :---: | :---: | :---: |
| **ä½¿ç”¨è€…ç®¡ç†** | æ–°å¢/åœç”¨å¸³è™Ÿ | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ | âŒ | âŒ |
| | ä¿®æ”¹è§’è‰² | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ä¸”ä¸å¯å‡ç‚º SUPER_ADMIN | âŒ | âŒ |
| | æŸ¥çœ‹æ‰€æœ‰ä½¿ç”¨è€… | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ | âŒ | âŒ |
| **éƒ¨é–€ç®¡ç†** | æ–°å¢/ç·¨è¼¯/åˆªé™¤éƒ¨é–€ | âœ… | âŒ | âŒ | âŒ |
| **çŸ¥è­˜åº«** | ä¸Šå‚³æ–‡ä»¶ | âœ… | âœ… | âœ… | âŒ |
| | åˆªé™¤æ–‡ä»¶ | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€æª”æ¡ˆ | âš ï¸ åƒ…è‡ªå·±ä¸Šå‚³ | âŒ |
| | æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶ | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ | âš ï¸ åƒ…æœ‰æ¬Šé™æ¨™ç±¤ | âŒ |
| | ç®¡ç†æ¨™ç±¤ | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€æ¨™ç±¤ | âŒ | âŒ |
| **Agent ç®¡ç†** | å»ºç«‹ Agent | âœ… | âœ… | âŒ | âŒ |
| | ç·¨è¼¯ System Prompt | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ Agent | âŒ | âŒ |
| | ç¶å®šçŸ¥è­˜åº« | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ Agent | âŒ | âŒ |
| | åˆªé™¤ Agent | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ Agent | âŒ | âŒ |
| | è¨­å®š Agent æ¬Šé™ | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ Agent | âŒ | âŒ |
| **å°è©±** | ä½¿ç”¨ Agent å°è©± | âœ… | âœ… | âœ… | âš ï¸ åƒ…æˆæ¬Š Agent |
| | æŸ¥çœ‹å°è©±æ­·å² | âœ… å…¨éƒ¨ | âš ï¸ æœ¬éƒ¨é–€ | âš ï¸ åƒ…è‡ªå·± | âš ï¸ åƒ…è‡ªå·± |
| **ç³»çµ±ç®¡ç†** | æŸ¥çœ‹ç¨½æ ¸æ—¥èªŒ | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ | âŒ | âŒ |
| | æŸ¥çœ‹ä½¿ç”¨é‡çµ±è¨ˆ | âœ… | âš ï¸ åƒ…æœ¬éƒ¨é–€ | âŒ | âŒ |
| | ç®¡ç† API Key | âœ… | âŒ | âŒ | âŒ |
| | ç³»çµ±è¨­ç½® | âœ… | âŒ | âŒ | âŒ |

> âš ï¸ è¡¨ç¤ºæœ‰æ¢ä»¶é™åˆ¶çš„æ¬Šé™

### 10.2 è³‡æ–™å±¤ç´šæ¬Šé™è¨­è¨ˆ (Data-Level Security)

#### 10.2.1 PostgreSQL Row Level Security (RLS) ç­–ç•¥

```sql
-- 1. ä½¿ç”¨è€…åªèƒ½è®€å–è‡ªå·±æ‰€å±¬éƒ¨é–€çš„æˆå“¡è³‡æ–™
CREATE POLICY "users_department_isolation" ON users
    FOR SELECT USING (
        department_id = (SELECT department_id FROM users WHERE id = auth.uid())
        OR EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role = 'SUPER_ADMIN')
    );

-- 2. æ–‡ä»¶ï¼šä¾æ“šæ¨™ç±¤èˆ‡éƒ¨é–€éš”é›¢
CREATE POLICY "files_access_by_tag" ON files
    FOR SELECT USING (
        -- SUPER_ADMIN å¯çœ‹æ‰€æœ‰
        EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role = 'SUPER_ADMIN')
        OR
        -- è©²æ–‡ä»¶å±¬æ–¼ä½¿ç”¨è€…çš„éƒ¨é–€
        EXISTS (
            SELECT 1 FROM file_tags ft
            WHERE ft.file_id = files.id
            AND ft.tag_key = 'department'
            AND ft.tag_value = (SELECT d.name FROM departments d JOIN users u ON u.department_id = d.id WHERE u.id = auth.uid())
        )
    );

-- 3. Agentï¼šåªèƒ½å­˜å–è¢«æˆæ¬Šçš„ Agent
CREATE POLICY "agents_access_control" ON agents
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role = 'SUPER_ADMIN')
        OR
        EXISTS (
            SELECT 1 FROM agent_access_control aac
            WHERE aac.agent_id = agents.id
            AND (aac.user_id_or_dept_id = auth.uid()::text
                 OR aac.user_id_or_dept_id = (SELECT department_id::text FROM users WHERE id = auth.uid()))
        )
    );
```

#### 10.2.2 æ¬Šé™ç¹¼æ‰¿æ¨¡å‹

```mermaid
graph TD
    subgraph "çµ„ç¹”å±¤ç´š"
        ORG[çµ„ç¹”] --> DEPT_A[éƒ¨é–€ A]
        ORG --> DEPT_B[éƒ¨é–€ B]
        DEPT_A --> TEAM_A1[å°çµ„ A1]
        DEPT_A --> TEAM_A2[å°çµ„ A2]
    end

    subgraph "æ¬Šé™ç¹¼æ‰¿è¦å‰‡"
        R1["çˆ¶å±¤æ¬Šé™è‡ªå‹•ç¹¼æ‰¿è‡³å­å±¤"]
        R2["å­å±¤å¯è¦†å¯«ç‚ºæ›´åš´æ ¼"]
        R3["ä¸å¯è¦†å¯«ç‚ºæ›´å¯¬é¬†"]
    end
```

### 10.3 API ç«¯é»æ¬Šé™çŸ©é™£ (API Endpoint Authorization)

| ç«¯é» | æ–¹æ³• | æœ€ä½è§’è‰²è¦æ±‚ | é™„åŠ æ¢ä»¶ |
| :--- | :--- | :--- | :--- |
| `/api/openai/v1/models` | GET | USER | åˆ—å‡ºå¯ç”¨çš„ Agent |
| `/api/openai/v1/chat/completions` | POST | USER | ç›¸å®¹ OpenAI æ ¼å¼ï¼Œéœ€å¸¶ Agent ID |
| `/api/users` | GET | DEPT_ADMIN | åƒ…è¿”å›æ‰€å±¬éƒ¨é–€æˆå“¡ |
| `/api/users` | POST | SUPER_ADMIN | - |
| `/api/users/:id` | PUT | DEPT_ADMIN | ä¸å¯ä¿®æ”¹ SUPER_ADMIN |
| `/api/files` | GET | EDITOR | ä¾æ¨™ç±¤éæ¿¾ |
| `/api/files` | POST | EDITOR | è‡ªå‹•åŠ ä¸Šå‚³è€…è³‡è¨Š |
| `/api/files/:id` | DELETE | EDITOR | åƒ…åˆªé™¤è‡ªå·±æˆ–ä¸‹å±¬ä¸Šå‚³ |
| `/api/agents` | GET | USER | åƒ…è¿”å›æœ‰æ¬Šé™è€… |
| `/api/agents` | POST | DEPT_ADMIN | - |
| `/api/agents/:id/prompt` | PUT | DEPT_ADMIN | è¨˜éŒ„ç‰ˆæœ¬æ­·å² |
| `/api/chat/:agentId` | POST | USER | é©—è­‰ Agent å­˜å–æ¬Š |
| `/api/audit-logs` | GET | DEPT_ADMIN | åƒ…è¿”å›æ‰€å±¬éƒ¨é–€è¨˜éŒ„ |
| `/api/system/config` | GET/PUT | SUPER_ADMIN | - |

### 10.4 å‹•æ…‹æ¬Šé™è¦å‰‡ (Dynamic Permission Rules)

#### 10.4.1 æ™‚é–“é™åˆ¶æ¬Šé™

```typescript
interface TemporaryAccess {
    user_id: string;
    agent_id: string;
    granted_by: string;
    expires_at: Date;       // è‡ªå‹•éæœŸæ™‚é–“
    reason: string;         // æˆæ¬ŠåŸå›  (ç¨½æ ¸ç”¨)
}
```

#### 10.4.2 IP ç™½åå–®é™åˆ¶

```typescript
interface IPRestriction {
    user_id: string;
    allowed_ips: string[];          // å…è¨±çš„ IP æˆ– CIDR
    apply_to_admin_only: boolean;   // åƒ…é™åˆ¶å¾Œå°å­˜å–
}
```

---

## 11. è³‡æ–™è½‰æ›èˆ‡å“è³ªä¿è­‰ (Data Pipeline & Quality Assurance)

### 11.1 ä¸Šå‚³è™•ç†æµç¨‹ (Ingestion Pipeline)

```mermaid
sequenceDiagram
    participant U as ä½¿ç”¨è€…
    participant FE as å‰ç«¯
    participant API as API Gateway
    participant S3 as MinIO/S3
    participant Worker as èƒŒæ™¯ Worker
    participant Gemini as Gemini API

    U->>FE: é¸æ“‡æª”æ¡ˆä¸Šå‚³
    FE->>FE: å‰ç«¯æ ¼å¼é©—è­‰
    FE->>API: ä¸Šå‚³è«‹æ±‚ (Multipart)
    API->>S3: å„²å­˜åŸå§‹æª”æ¡ˆ
    API->>API: å»ºç«‹ files è¨˜éŒ„ (state: PENDING)
    API-->>FE: å›å‚³ä¸Šå‚³æˆåŠŸ

    Note over Worker: éåŒæ­¥è™•ç†
    Worker->>S3: è®€å–åŸå§‹æª”æ¡ˆ
    Worker->>Worker: æ ¼å¼è½‰æ› (if needed)
    Worker->>Worker: å“è³ªæª¢æ¸¬
    alt å“è³ªé€šé
        Worker->>Gemini: ä¸Šå‚³è‡³ Gemini File API
        Gemini-->>Worker: å›å‚³ google_file_uri
        Worker->>API: æ›´æ–° state: SYNCED
    else å“è³ªä¸é€šé
        Worker->>API: æ›´æ–° state: NEEDS_REVIEW
        Worker->>API: è¨˜éŒ„å•é¡Œå ±å‘Š
    end
```

### 11.1.1 AI é¤¨é•·è½‰è­¯æµç¨‹ (AI Librarian ETL)
ç•¶ä¸Šå‚³æ–‡ä»¶é¡å‹ç‚ºã€Œéçµæ§‹åŒ–æ–‡ä»¶ (PDF/Doc)ã€æ™‚ï¼Œè§¸ç™¼é€²éšè½‰è­¯æµç¨‹ï¼š

1.  **è­˜åˆ¥æ¡†æ¶**ï¼šç³»çµ±ä¾æ“šæª”æ¡ˆä¾†æºæˆ–ä½¿ç”¨è€…é¸æ“‡ï¼Œæ±ºå®šå¥—ç”¨å“ªå€‹çŸ¥è­˜æ¡†æ¶ (å¦‚ SWOTã€VPCã€æœƒè­°è¨˜éŒ„)ã€‚
2.  **AI é–±è®€èˆ‡èƒå–**ï¼šå•Ÿå‹• Workerï¼Œå‘¼å« Gemini Pro é–±è®€åŸå§‹æª”ã€‚
3.  **çµæ§‹åŒ–è¼¸å‡º**ï¼š
    *   Gemini ä¾æ“šæ¡†æ¶ Prompt è¼¸å‡ºæ¨™æº– Markdown æˆ– JSONã€‚
    *   å»é™¤é çœ‰ã€é è…³ã€é ç¢¼ç­‰ç„¡æ•ˆé›œè¨Šã€‚
    *   (Option) è‡ªå‹•ç”Ÿæˆæ‘˜è¦èˆ‡é—œéµå­—æ¨™ç±¤ã€‚
4.  **é›™é‡å­˜æª”**ï¼š
    *   `Raw File`: åŸå§‹ PDF (å­˜ S3ï¼Œä¾›æŸ¥è­‰ç”¨)ã€‚
    *   `Knowledge File`: è½‰è­¯å¾Œçš„ MD/JSON (å­˜ S3 & Geminiï¼Œä¾› Agent æ€è€ƒç”¨)ã€‚
5.  **é€£çµå»ºç«‹**ï¼šåœ¨è³‡æ–™åº«å»ºç«‹å…©è€…çš„é—œè¯ï¼ŒAgent å„ªå…ˆè®€å– `Knowledge File`ï¼Œä½†å¼•ç”¨é€£çµå¯å°å‘ `Raw File`ã€‚

### 11.2 æ”¯æ´æ ¼å¼èˆ‡é©—è­‰è¦å‰‡ (Format Validation)

| æª”æ¡ˆé¡å‹ | å‰¯æª”å | æœ€å¤§å°ºå¯¸ | é©—è­‰è¦å‰‡ |
| :--- | :--- | :--- | :--- |
| **æ–‡ä»¶** | .pdf, .docx, .doc | 100 MB | é æ•¸ â‰¤ 500ã€éåŠ å¯† |
| **ç°¡å ±** | .pptx, .ppt | 100 MB | æŠ•å½±ç‰‡ â‰¤ 200 |
| **è©¦ç®—è¡¨** | .xlsx, .xls, .csv | 50 MB | åˆ—æ•¸ â‰¤ 100,000 |
| **ç´”æ–‡å­—** | .txt, .md, .html | 10 MB | UTF-8 ç·¨ç¢¼ |
| **å½±åƒ** | .png, .jpg, .webp | 20 MB | è§£æåº¦ â‰¤ 4096px |

### 11.3 è‡ªå‹•æ ¼å¼è½‰æ›è¦å‰‡ (Auto-Conversion Rules)

| åŸå§‹æ ¼å¼ | ç›®æ¨™æ ¼å¼ | è½‰æ›æ–¹å¼ | å‚™è¨» |
| :--- | :--- | :--- | :--- |
| PDF (æ–‡å­—å‹) | åŸå§‹ PDF | ç›´æ¥ä½¿ç”¨ | Gemini åŸç”Ÿæ”¯æ´ |
| PDF (æƒæå‹) | PDF + OCR | Google Vision OCR | è‡ªå‹•åµæ¸¬ä¸¦è™•ç† |
| Word (.docx) | Markdown | Pandoc è½‰æ› | ä¿ç•™æ¨™é¡Œçµæ§‹ |
| Excel (.xlsx) | JSONL | è‡ªè¨‚è…³æœ¬ | æ¯åˆ—ä¸€å€‹ JSON ç‰©ä»¶ |
| PPT (.pptx) | åŸå§‹ PPT | ç›´æ¥ä½¿ç”¨ | Gemini å¤šæ¨¡æ…‹è™•ç† |

### 11.4 å“è³ªè©•ä¼°æŒ‡æ¨™ (Quality Metrics)

```typescript
interface QualityReport {
    file_id: string;
    overall_score: number;          // 0-100 ç¶œåˆåˆ†æ•¸
    
    // ç´°é …æŒ‡æ¨™
    text_extraction_rate: number;   // æ–‡å­—æå–ç‡ (æƒæ PDF ç”¨)
    structure_integrity: number;    // çµæ§‹å®Œæ•´åº¦ (æ¨™é¡Œå±¤ç´š)
    language_consistency: number;   // èªè¨€ä¸€è‡´æ€§
    table_accuracy: number;         // è¡¨æ ¼è§£ææº–ç¢ºåº¦
    
    // å•é¡Œåˆ—è¡¨
    issues: QualityIssue[];
}

interface QualityIssue {
    severity: 'ERROR' | 'WARNING' | 'INFO';
    code: string;                   // å¦‚ 'TABLE_PARSE_FAILED'
    message: string;
    page_or_location?: string;
}
```

### 11.5 äººå·¥è¦†æ ¸å·¥ä½œæµç¨‹ (Manual Review Workflow)

| ç‹€æ…‹ | èªªæ˜ | ä¸‹ä¸€æ­¥æ“ä½œ |
| :--- | :--- | :--- |
| `PENDING` | ä¸Šå‚³ä¸­/ç­‰å¾…è™•ç† | ç³»çµ±è‡ªå‹•è™•ç† |
| `PROCESSING` | èƒŒæ™¯è™•ç†ä¸­ | ç­‰å¾…å®Œæˆ |
| `SYNCED` | å·²åŒæ­¥è‡³ Gemini | å¯ä¾› Agent ä½¿ç”¨ |
| `NEEDS_REVIEW` | å“è³ªæœªé”æ¨™æº– | ç®¡ç†å“¡è¦†æ ¸ |
| `REJECTED` | ç®¡ç†å“¡æ‹’çµ• | é€šçŸ¥ä¸Šå‚³è€…ä¿®æ­£ |
| `FAILED` | ç³»çµ±è™•ç†å¤±æ•— | è‡ªå‹•é‡è©¦ 3 æ¬¡å¾Œé€šçŸ¥ç®¡ç†å“¡ |

---

## 12. AI æ²»ç†èˆ‡ç›£æ§ (AI Governance & Monitoring)

### 12.1 AI å›ç­”å“è³ªæŒ‡æ¨™ (AI Quality Metrics)

| æŒ‡æ¨™åç¨± | è¨ˆç®—æ–¹å¼ | å¥åº·é–¾å€¼ | å‘Šè­¦æ¢ä»¶ |
| :--- | :--- | :--- | :--- |
| **å¼•ç”¨ç‡ (Citation Rate)** | æœ‰å¼•ç”¨å›ç­”æ•¸ / ç¸½å›ç­”æ•¸ | â‰¥ 80% | < 70% é€£çºŒ 1 å°æ™‚ |
| **ç©ºå›ç­”ç‡** | å›ç­”ã€Œæˆ‘ä¸çŸ¥é“ã€æ¬¡æ•¸ / ç¸½æ¬¡æ•¸ | â‰¤ 5% | > 10% é€£çºŒ 30 åˆ†é˜ |
| **å¹³å‡å›æ‡‰æ™‚é–“ (Latency)** | Î£ (é¦–å­—å›æ‡‰æ™‚é–“) / N | â‰¤ 2 ç§’ | > 4 ç§’ é€£çºŒ 5 åˆ†é˜ |
| **éŒ¯èª¤ç‡ (Error Rate)** | API éŒ¯èª¤æ¬¡æ•¸ / ç¸½è«‹æ±‚ | â‰¤ 1% | > 5% |

### 12.2 å›é¥‹æ”¶é›†æ©Ÿåˆ¶ (User Feedback / RLHF)

#### 12.2.1 å‰ç«¯å›é¥‹ UI

æ¯å€‹ Agent å›ç­”ä¸‹æ–¹æä¾›ï¼š

*   ğŸ‘ **æœ‰å¹«åŠ©**ï¼šè¨˜éŒ„æ­£å‘å›é¥‹
*   ğŸ‘ **æ²’å¹«åŠ©**ï¼šå±•é–‹å›é¥‹è¡¨å–®
    *   åŸå› é¸é …ï¼š`ç­”éæ‰€å•` / `è³‡è¨ŠéŒ¯èª¤` / `ä¾†æºéæ™‚` / `å…¶ä»–`
    *   è‡ªç”±æ–‡å­—è£œå……

#### 12.2.2 å›é¥‹è³‡æ–™è¡¨çµæ§‹

```sql
TABLE chat_feedback (
    id UUID PRIMARY KEY,
    message_id UUID REFERENCES chat_messages(id),
    user_id UUID REFERENCES users(id),
    rating SMALLINT CHECK (rating IN (-1, 1)),  -- -1: è² è©•, 1: æ­£è©•
    reason_code VARCHAR(50),                     -- é è¨­åŸå› 
    comment TEXT,                                -- è‡ªç”±æ–‡å­—
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ¯é€±ç”¢å‡ºå›é¥‹å ±å‘Š
CREATE VIEW weekly_feedback_report AS
SELECT 
    a.name AS agent_name,
    COUNT(*) FILTER (WHERE cf.rating = 1) AS positive_count,
    COUNT(*) FILTER (WHERE cf.rating = -1) AS negative_count,
    ROUND(100.0 * COUNT(*) FILTER (WHERE cf.rating = 1) / NULLIF(COUNT(*), 0), 1) AS satisfaction_rate
FROM chat_feedback cf
JOIN chat_messages cm ON cf.message_id = cm.id
JOIN agents a ON cm.agent_id = a.id
WHERE cf.created_at >= NOW() - INTERVAL '7 days'
GROUP BY a.name;
```

### 12.3 Prompt ç‰ˆæœ¬æ§åˆ¶èˆ‡ A/B æ¸¬è©¦ (Prompt Versioning & A/B Testing)

#### 12.3.1 ç‰ˆæœ¬æ§åˆ¶è³‡æ–™çµæ§‹

```sql
TABLE agent_prompt_versions (
    id UUID PRIMARY KEY,
    agent_id UUID REFERENCES agents(id),
    version_number INT NOT NULL,
    system_prompt TEXT NOT NULL,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    is_active BOOLEAN DEFAULT FALSE,
    
    -- A/B æ¸¬è©¦ç›¸é—œ
    traffic_percentage INT DEFAULT 0,  -- æµé‡åˆ†é…æ¯”ä¾‹ (0-100)
    experiment_id UUID                 -- æ‰€å±¬å¯¦é©— ID
);

TABLE prompt_experiments (
    id UUID PRIMARY KEY,
    agent_id UUID REFERENCES agents(id),
    name VARCHAR(100),
    start_at TIMESTAMPTZ,
    end_at TIMESTAMPTZ,
    status VARCHAR(20) DEFAULT 'DRAFT',  -- DRAFT, RUNNING, COMPLETED
    winner_version_id UUID
);
```

#### 12.3.2 A/B æ¸¬è©¦æµç¨‹

1.  **å»ºç«‹å¯¦é©—**ï¼šé¸æ“‡ Agentï¼Œè¨­å®šå¯¦é©—åç¨±èˆ‡æ™‚é–“ç¯„åœã€‚
2.  **è¨­å®šè®Šé«”**ï¼šæ–°å¢ Prompt ç‰ˆæœ¬ Bï¼Œè¨­å®šæµé‡åˆ†é… (å¦‚ 50/50)ã€‚
3.  **å•Ÿå‹•å¯¦é©—**ï¼šç³»çµ±ä¾æ¯”ä¾‹éš¨æ©Ÿåˆ†é…ä½¿ç”¨è€…ã€‚
4.  **æ”¶é›†æ•¸æ“š**ï¼šè¿½è¹¤å„ç‰ˆæœ¬çš„å›é¥‹è©•åˆ†ã€å¼•ç”¨ç‡ã€å›æ‡‰æ™‚é–“ã€‚
5.  **çµæŸåˆ†æ**ï¼šç”¢å‡ºæ¯”è¼ƒå ±å‘Šï¼Œé¸å‡ºå‹å‡ºç‰ˆæœ¬ã€‚

### 12.4 ä½¿ç”¨é‡å„€è¡¨æ¿ (Usage Dashboard)

**é¡¯ç¤ºæŒ‡æ¨™**ï¼š

| å€å¡Š | å…§å®¹ |
| :--- | :--- |
| **ç¸½è¦½å¡ç‰‡** | ä»Šæ—¥å°è©±æ•¸ã€æœ¬æœˆ Token æ¶ˆè€—ã€æ´»èºä½¿ç”¨è€…æ•¸ã€æ´»èº Agent æ•¸ |
| **è¶¨å‹¢åœ–** | æ¯æ—¥å°è©±é‡ (è¿‘ 30 æ—¥)ã€Token æ¶ˆè€—è¶¨å‹¢ |
| **æ’è¡Œæ¦œ** | æœ€ç†±é–€ Agent Top 5ã€æœ€å¸¸è¢«å¼•ç”¨æ–‡ä»¶ Top 10 |
| **æˆæœ¬åˆ†æ** | é ä¼° API è²»ç”¨ã€å„éƒ¨é–€ç”¨é‡ä½”æ¯” |

---

## 13. éŒ¯èª¤è™•ç†èˆ‡å®¹éŒ¯æ©Ÿåˆ¶ (Fault Tolerance & Error Handling)

### 13.1 Gemini API æ•…éšœé™ç´šç­–ç•¥ (API Fallback Strategy)

```mermaid
graph TD
    A[ç™¼é€ Gemini API è«‹æ±‚] --> B{å›æ‡‰æˆåŠŸ}
    B -->|æ˜¯| C[æ­£å¸¸è™•ç†å›æ‡‰]
    B -->|å¦| D{éŒ¯èª¤é¡å‹}
    
    D -->|429 Rate Limit| E[ç­‰å¾…å¾Œé‡è©¦]
    D -->|500/502/503| F[åˆ‡æ›å‚™æ´å€åŸŸ]
    D -->|401/403| G[é€šçŸ¥ç®¡ç†å“¡]
    D -->|Timeout| H[é‡è©¦ 2 æ¬¡]
    
    E --> I{é‡è©¦æˆåŠŸ}
    F --> I
    H --> I
    
    I -->|æ˜¯| C
    I -->|å¦| J[å•Ÿç”¨é™ç´šæ¨¡å¼]
    
    J --> K[é¡¯ç¤ºå¿™ç¢Œæç¤º]
    J --> L[è¨˜éŒ„éŒ¯èª¤æ—¥èªŒ]
    J --> M[è§¸ç™¼å‘Šè­¦]
```

### 13.2 é‡è©¦ç­–ç•¥è¨­å®š (Retry Policy)

```typescript
const retryConfig = {
    // Gemini API å‘¼å«
    geminiApi: {
        maxRetries: 3,
        initialDelayMs: 1000,
        maxDelayMs: 10000,
        backoffMultiplier: 2,
        retryableErrors: [429, 500, 502, 503, 504]
    },
    
    // S3/MinIO åŒæ­¥
    storageSync: {
        maxRetries: 5,
        initialDelayMs: 2000,
        maxDelayMs: 30000,
        backoffMultiplier: 2
    },
    
    // è³‡æ–™åº«æ“ä½œ
    database: {
        maxRetries: 3,
        initialDelayMs: 500,
        maxDelayMs: 5000,
        backoffMultiplier: 1.5
    }
};
```

### 13.3 ç”¨æˆ¶ç«¯éŒ¯èª¤æç¤ºè¦ç¯„ (User-Facing Error Messages)

| éŒ¯èª¤ä»£ç¢¼ | ä½¿ç”¨è€…çœ‹åˆ°çš„è¨Šæ¯ | å»ºè­°è¡Œå‹• |
| :--- | :--- | :--- |
| `AUTH_EXPIRED` | æ‚¨çš„ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ | é‡æ–°å°å‘ç™»å…¥é  |
| `PERMISSION_DENIED` | æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ | é¡¯ç¤ºè¯çµ¡ç®¡ç†å“¡é€£çµ |
| `FILE_TOO_LARGE` | æª”æ¡ˆéå¤§ (ä¸Šé™ 100MB)ï¼Œè«‹å£“ç¸®å¾Œé‡è©¦ | é¡¯ç¤ºä¸Šå‚³é™åˆ¶èªªæ˜ |
| `FILE_FORMAT_UNSUPPORTED` | ä¸æ”¯æ´æ­¤æª”æ¡ˆæ ¼å¼ | é¡¯ç¤ºæ”¯æ´æ ¼å¼æ¸…å–® |
| `AI_UNAVAILABLE` | AI æœå‹™æš«æ™‚å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ | é¡¯ç¤ºé ä¼°æ¢å¾©æ™‚é–“ |
| `RATE_LIMITED` | è«‹æ±‚å¤ªé »ç¹ï¼Œè«‹ç¨å¾Œ 30 ç§’å†è©¦ | é¡¯ç¤ºå€’è¨ˆæ™‚ |
| `NETWORK_ERROR` | ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯ | é¡¯ç¤ºé‡è©¦æŒ‰éˆ• |
| `UNKNOWN_ERROR` | ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼Œæˆ‘å€‘å·²æ”¶åˆ°é€šçŸ¥ | é¡¯ç¤ºéŒ¯èª¤ä»£ç¢¼ä¾›å›å ± |

### 13.4 è³‡æ–™å‚™ä»½èˆ‡æ¢å¾©ç­–ç•¥ (Backup & Recovery)

#### 13.4.1 å‚™ä»½ç­–ç•¥ (Appliance æ¨¡å¼)

| è³‡æ–™é¡å‹ | å‚™ä»½é »ç‡ | ä¿ç•™é€±æœŸ | å‚™ä»½ä½ç½® |
| :--- | :--- | :--- | :--- |
| PostgreSQL | æ¯æ—¥ 02:00 | 30 æ—¥ | æœ¬æ©Ÿ + å¤–æ¥ç¡¬ç¢Ÿ (é¸é…) |
| MinIO æª”æ¡ˆ | å³æ™‚å¢é‡ | æ°¸ä¹… | æœ¬æ©Ÿ |
| è¨­å®šæª” | æ¯æ¬¡è®Šæ›´ | 10 ç‰ˆæœ¬ | Git (æœ¬åœ°) |

#### 13.4.2 ç½é›£æ¢å¾© SOP

1.  **PostgreSQL æ¢å¾©**ï¼š`pg_restore -d eakap backup_2025xxxx.dump`
2.  **MinIO æ¢å¾©**ï¼šå¾å‚™ä»½åª’é«”è¤‡è£½ `/data/minio` ç›®éŒ„
3.  **é©—è­‰**ï¼šåŸ·è¡Œå¥åº·æª¢æŸ¥ API `/api/health`

### 13.5 ç³»çµ±å¥åº·æª¢æŸ¥ API (Health Check)

```typescript
// GET /api/health
interface HealthCheckResponse {
    status: 'healthy' | 'degraded' | 'unhealthy';
    timestamp: string;
    version: string;
    components: {
        database: ComponentHealth;
        storage: ComponentHealth;
        geminiApi: ComponentHealth;
        cache: ComponentHealth;
    };
}

interface ComponentHealth {
    status: 'up' | 'down' | 'degraded';
    latencyMs?: number;
    message?: string;
}
```

---

## 14. åœ‹éš›åŒ–èˆ‡ç„¡éšœç¤™ (i18n & Accessibility)

### 14.1 å¤šèªè¨€æ”¯æ´è¦æ ¼ (Internationalization)

#### 14.1.1 æ”¯æ´èªè¨€

| èªè¨€ | ä»£ç¢¼ | å„ªå…ˆç´š | æ”¯æ´ç‰ˆæœ¬ |
| :--- | :--- | :--- | :--- |
| ç¹é«”ä¸­æ–‡ (å°ç£) | `zh-TW` | é¦–è¦ | MVP |
| è‹±æ–‡ | `en` | æ“´å±• | Phase 2 |

#### 14.1.2 ç¿»è­¯æ¶æ§‹

```
/locales
â”œâ”€â”€ zh-TW/
â”‚   â”œâ”€â”€ common.json       # é€šç”¨è©å½™
â”‚   â”œâ”€â”€ auth.json         # ç™»å…¥ç›¸é—œ
â”‚   â”œâ”€â”€ dashboard.json    # å„€è¡¨æ¿
â”‚   â”œâ”€â”€ agents.json       # Agent ç®¡ç†
â”‚   â””â”€â”€ errors.json       # éŒ¯èª¤è¨Šæ¯
â””â”€â”€ en/
```

#### 14.1.3 èªè¨€åˆ‡æ›é‚è¼¯

1.  **å„ªå…ˆæª¢æŸ¥**ï¼šä½¿ç”¨è€…å¸³è™Ÿè¨­å®šçš„åå¥½èªè¨€ã€‚
2.  **æ¬¡è¦åµæ¸¬**ï¼šç€è¦½å™¨ `Accept-Language` æ¨™é ­ã€‚
3.  **é è¨­**ï¼šç¹é«”ä¸­æ–‡ (`zh-TW`)ã€‚

### 14.2 ç„¡éšœç¤™è¨­è¨ˆè¦ç¯„ (Accessibility / a11y)

#### 14.2.1 WCAG 2.1 AA åˆè¦ç›®æ¨™

| åŸå‰‡ | å…·é«”è¦æ±‚ | å¯¦ä½œæ–¹å¼ |
| :--- | :--- | :--- |
| **å¯æ„ŸçŸ¥** | è‰²å½©å°æ¯” â‰¥ 4.5:1 | è¨­è¨ˆç³»çµ±å·²é©—è­‰ |
| | æ‰€æœ‰åœ–ç‰‡æä¾› alt æ–‡å­— | ç¨‹å¼ç¢¼æª¢æŸ¥ |
| **å¯æ“ä½œ** | æ‰€æœ‰åŠŸèƒ½å¯ç”¨éµç›¤æ“ä½œ | Tab å°èˆªæ¸¬è©¦ |
| | ç„¡æ™‚é–“é™åˆ¶é™·é˜± | è‡ªå‹•ç™»å‡ºå‰ 5 åˆ†é˜æé†’ |
| **å¯ç†è§£** | ä¸€è‡´çš„å°èˆªæ¨¡å¼ | è¨­è¨ˆè¦ç¯„éµå¾ª |
| | éŒ¯èª¤è¨Šæ¯æ¸…æ¥šèªªæ˜ä¿®æ­£æ–¹å¼ | UX Writer å¯©æ ¸ |
| **å¥å£¯æ€§** | HTML èªæ„æ­£ç¢º | ä½¿ç”¨èªæ„æ¨™ç±¤ |
| | ç›¸å®¹è¼”åŠ©æŠ€è¡“ | è¢å¹•é–±è®€å™¨æ¸¬è©¦ |

#### 14.2.2 éµç›¤å°èˆªè¦ç¯„

| æŒ‰éµ | åŠŸèƒ½ |
| :--- | :--- |
| `Tab` | ç§»å‹•ç„¦é»è‡³ä¸‹ä¸€å€‹å¯äº’å‹•å…ƒç´  |
| `Shift + Tab` | ç§»å‹•ç„¦é»è‡³ä¸Šä¸€å€‹å…ƒç´  |
| `Enter` / `Space` | è§¸ç™¼æŒ‰éˆ• / é¸é … |
| `Escape` | é—œé–‰ Modal / å–æ¶ˆæ“ä½œ |
| `â†‘` `â†“` | åœ¨ä¸‹æ‹‰é¸å–®ä¸­ç§»å‹• |
| `/` | èšç„¦æœå°‹æ¡† (å…¨åŸŸå¿«æ·éµ) |

#### 14.2.3 ARIA æ¨™ç±¤è¦ç¯„

```html
<!-- ç¯„ä¾‹ï¼šAgent å¡ç‰‡ -->
<article 
    role="article" 
    aria-labelledby="agent-name-1"
    tabindex="0"
>
    <h3 id="agent-name-1">è¡ŒéŠ·åŠ©ç† Agent</h3>
    <p aria-describedby="agent-desc-1">å”åŠ©æ’°å¯«è¡ŒéŠ·æ–‡æ¡ˆèˆ‡åˆ†æå¸‚å ´è³‡æ–™</p>
    <span aria-label="å¯ç”¨ç‹€æ…‹" class="status online">â— é‹ä½œä¸­</span>
    <button aria-label="é–‹å§‹èˆ‡è¡ŒéŠ·åŠ©ç† Agent å°è©±">é–‹å§‹å°è©±</button>
</article>
```

#### 14.2.4 ç„¦é»ç‹€æ…‹è¦–è¦ºæŒ‡ç¤º

```css
/* æ‰€æœ‰å¯èšç„¦å…ƒç´ å¿…é ˆæœ‰æ˜é¡¯çš„ focus æ¨£å¼ */
:focus-visible {
    outline: 2px solid var(--color-primary-500);
    outline-offset: 2px;
}

/* æŒ‰éˆ•ç„¦é»ç‹€æ…‹ */
.btn:focus-visible {
    box-shadow: 0 0 0 3px var(--color-primary-200);
}
```

---

## é™„éŒ„ Aï¼šæ–‡ä»¶ç‰ˆæœ¬æ­·ç¨‹

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å…§å®¹ | ä½œè€… |
| :--- | :--- | :--- | :--- |
| 1.0 | 2025-12-31 | åˆç‰ˆç™¼è¡Œ (Ch.1-8) | - |
| 1.1 | 2026-01-01 | æ–°å¢ Ch.9-14 (è¨­è¨ˆè¦ç¯„ã€æ¬Šé™çŸ©é™£ã€AIæ²»ç†ã€å®¹éŒ¯æ©Ÿåˆ¶ã€åœ‹éš›åŒ–/ç„¡éšœç¤™) | - |
