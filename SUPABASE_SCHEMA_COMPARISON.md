# Supabase è³‡æ–™åº«çµæ§‹èˆ‡ Migration æ¯”è¼ƒå ±å‘Š

**ç”Ÿæˆæ™‚é–“ï¼š** 2026-01-04  
**å°ˆæ¡ˆ IDï¼š** vjvmwyzpjmzzhfiaojul (Knowledge Architects)

---

## ğŸ“Š ç¸½é«”ç‹€æ…‹

### âœ… ä¸€è‡´çš„é …ç›®

1. **è³‡æ–™è¡¨çµæ§‹** - æ‰€æœ‰ 15 å€‹è³‡æ–™è¡¨éƒ½å­˜åœ¨ä¸”çµæ§‹æ­£ç¢º
2. **RLS å•Ÿç”¨ç‹€æ…‹** - æ‰€æœ‰è³‡æ–™è¡¨éƒ½å·²å•Ÿç”¨ RLS
3. **RLS æ”¿ç­–æ•¸é‡** - è³‡æ–™åº«ä¸­æœ‰ 35 å€‹ RLS æ”¿ç­–ï¼Œèˆ‡ migration æª”æ¡ˆä¸€è‡´
4. **å‡½å¼** - æ‰€æœ‰ 8 å€‹è¼”åŠ©å‡½å¼éƒ½å­˜åœ¨
5. **è§¸ç™¼å™¨** - æ‰€æœ‰è§¸ç™¼å™¨éƒ½å­˜åœ¨ï¼ˆåŒ…æ‹¬ auth.users ä¸Šçš„è§¸ç™¼å™¨ï¼‰
6. **ç´¢å¼•** - æ‰€æœ‰ç´¢å¼•éƒ½å­˜åœ¨

---

## âœ… å·²ä¿®å¾©çš„å•é¡Œ

### 1. `agents.model_version` é è¨­å€¼ä¸ä¸€è‡´ âœ… å·²ä¿®å¾©

**å•é¡Œæè¿°ï¼š**
- Migration æª”æ¡ˆä¸­å®šç¾©ç‚º `'gemini-2.5-flash'`
- è³‡æ–™åº«å¯¦éš›å€¼ç‚º `'gemini-1.5-pro'`

**ä¿®å¾©ç‹€æ…‹ï¼š**
- âœ… å·²æ›´æ–° `20240101000000_initial_schema.sql` ä¸­çš„é è¨­å€¼ç‚º `'gemini-1.5-pro'`
- âœ… å·²åŸ·è¡Œ migration `20260105000000_fix_agents_model_version_default.sql`
- âœ… è³‡æ–™åº«é è¨­å€¼å·²ç¢ºèªçµ±ä¸€ç‚º `'gemini-1.5-pro'`

### 2. æ¸¬è©¦ç”¨ RLS æ”¿ç­– âœ… å·²ç§»é™¤

**å•é¡Œæè¿°ï¼š**
- å­˜åœ¨æ¸¬è©¦ç”¨çš„ RLS æ”¿ç­– "è¨ºæ–·ï¼šæ¸¬è©¦ä½¿ç”¨è€…è®€å–è‡ªå·±çš„è³‡æ–™"

**ä¿®å¾©ç‹€æ…‹ï¼š**
- âœ… å·²åŸ·è¡Œ migration `20260105000001_remove_test_rls_policy.sql`
- âœ… æ¸¬è©¦ç”¨æ”¿ç­–å·²æˆåŠŸç§»é™¤

---

## ğŸ“‹ è©³ç´°çµæ§‹æ¸…å–®

### è³‡æ–™è¡¨æ¸…å–®ï¼ˆ15 å€‹ï¼‰

1. âœ… `departments` - éƒ¨é–€è¡¨
2. âœ… `user_profiles` - ä½¿ç”¨è€…è³‡æ–™è¡¨ï¼ˆåŒ…å« `status` æ¬„ä½ï¼‰
3. âœ… `files` - æª”æ¡ˆè¡¨
4. âœ… `file_tags` - æª”æ¡ˆæ¨™ç±¤è¡¨
5. âœ… `user_tag_permissions` - ä½¿ç”¨è€…æ¨™ç±¤æ¬Šé™è¡¨
6. âœ… `agents` - Agent è¡¨
7. âœ… `agent_prompt_versions` - Agent Prompt ç‰ˆæœ¬æ­·å²
8. âœ… `agent_knowledge_rules` - Agent çŸ¥è­˜ç¶å®šè¦å‰‡
9. âœ… `agent_access_control` - Agent å­˜å–æ§åˆ¶
10. âœ… `chat_sessions` - å°è©± Session
11. âœ… `chat_messages` - å°è©±è¨Šæ¯
12. âœ… `chat_feedback` - å°è©±å›é¥‹
13. âœ… `audit_logs` - ç¨½æ ¸æ—¥èªŒ
14. âœ… `user_favorites` - ä½¿ç”¨è€…æœ€æ„›è³‡æºè¡¨

### RLS æ”¿ç­–æ¸…å–®ï¼ˆ35 å€‹ï¼‰

#### user_profiles (4 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯è®€å–è‡ªå·±çš„è³‡æ–™"
2. âœ… "ä½¿ç”¨è€…å¯æ›´æ–°è‡ªå·±çš„è³‡æ–™"
3. âœ… "è¶…ç´šç®¡ç†å“¡å¯è®€å–æ‰€æœ‰ä½¿ç”¨è€…"
4. âœ… "éƒ¨é–€ç®¡ç†å“¡å¯è®€å–éƒ¨é–€æˆå“¡"

#### files (5 å€‹æ”¿ç­–)
1. âœ… "è¶…ç´šç®¡ç†å“¡å¯çœ‹æ‰€æœ‰æª”æ¡ˆ"
2. âœ… "éƒ¨é–€ç®¡ç†å“¡å¯çœ‹éƒ¨é–€æª”æ¡ˆ"
3. âœ… "ç·¨è¼¯è€…å¯çœ‹æˆæ¬Šæª”æ¡ˆ"
4. âœ… "ä½¿ç”¨è€…å¯ä¸Šå‚³æª”æ¡ˆ"
5. âœ… "ä¸Šå‚³è€…å¯æ›´æ–°è‡ªå·±çš„æª”æ¡ˆ"
6. âœ… "ä¸Šå‚³è€…å¯åˆªé™¤è‡ªå·±çš„æª”æ¡ˆ"

#### agents (3 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯çœ‹æˆæ¬Šçš„ Agent"
2. âœ… "å»ºç«‹è€…å¯æ›´æ–°è‡ªå·±çš„ Agent"
3. âœ… "ç®¡ç†å“¡å¯å»ºç«‹ Agent"

#### file_tags (3 å€‹æ”¿ç­–)
1. âœ… "ç®¡ç†å“¡å¯ç®¡ç†æ¨™ç±¤"
2. âœ… "ä¸Šå‚³è€…å¯ç®¡ç†æ¨™ç±¤"
3. âœ… "ä½¿ç”¨è€…å¯è®€å–æ¨™ç±¤"

#### agent_knowledge_rules (2 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯è®€å– Agent è¦å‰‡"
2. âœ… "ç®¡ç†å“¡å¯ç®¡ç† Agent è¦å‰‡"

#### agent_access_control (1 å€‹æ”¿ç­–)
1. âœ… "ç®¡ç†å“¡å¯ç®¡ç†å­˜å–æ§åˆ¶"

#### agent_prompt_versions (2 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯è®€å–æˆæ¬Š Agent çš„ç‰ˆæœ¬æ­·å²"
2. âœ… "ç®¡ç†å“¡å¯å»ºç«‹ç‰ˆæœ¬æ­·å²"

#### chat_sessions (4 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯çœ‹è‡ªå·±çš„å°è©±"
2. âœ… "ä½¿ç”¨è€…å¯å»ºç«‹è‡ªå·±çš„å°è©±"
3. âœ… "ä½¿ç”¨è€…å¯æ›´æ–°è‡ªå·±çš„å°è©±"
4. âœ… "ä½¿ç”¨è€…å¯åˆªé™¤è‡ªå·±çš„å°è©±"

#### chat_messages (2 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯çœ‹è‡ªå·±å°è©±çš„è¨Šæ¯"
2. âœ… "ä½¿ç”¨è€…å¯å»ºç«‹è¨Šæ¯"

#### chat_feedback (4 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯è®€å–è‡ªå·±çš„å›é¥‹"
2. âœ… "ä½¿ç”¨è€…å¯å»ºç«‹è‡ªå·±çš„å›é¥‹"
3. âœ… "ä½¿ç”¨è€…å¯æ›´æ–°è‡ªå·±çš„å›é¥‹"
4. âœ… "ç®¡ç†å“¡å¯è®€å–æ‰€æœ‰å›é¥‹"

#### departments (2 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯è®€å–éƒ¨é–€"
2. âœ… "è¶…ç´šç®¡ç†å“¡å¯ç®¡ç†éƒ¨é–€"

#### user_tag_permissions (3 å€‹æ”¿ç­–)
1. âœ… "ä½¿ç”¨è€…å¯è®€å–è‡ªå·±çš„æ¨™ç±¤æ¬Šé™"
2. âœ… "ç®¡ç†å“¡å¯è®€å–æ‰€æœ‰æ¨™ç±¤æ¬Šé™"
3. âœ… "ç®¡ç†å“¡å¯ç®¡ç†æ¨™ç±¤æ¬Šé™"

#### audit_logs (1 å€‹æ”¿ç­–)
1. âœ… "ç®¡ç†å“¡å¯çœ‹ç¨½æ ¸æ—¥èªŒ"

#### user_favorites (3 å€‹æ”¿ç­–)
1. âœ… "Users can view own favorites"
2. âœ… "Users can add own favorites"
3. âœ… "Users can remove own favorites"

### å‡½å¼æ¸…å–®ï¼ˆ8 å€‹ï¼‰

1. âœ… `can_access_dept_file(UUID)` - æª¢æŸ¥éƒ¨é–€æª”æ¡ˆå­˜å–æ¬Šé™
2. âœ… `get_user_dept()` - å–å¾—ç•¶å‰ä½¿ç”¨è€…çš„éƒ¨é–€ ID
3. âœ… `get_user_role()` - å–å¾—ç•¶å‰ä½¿ç”¨è€…çš„è§’è‰²
4. âœ… `handle_new_user()` - è™•ç†æ–°ä½¿ç”¨è€…è¨»å†Šï¼ˆè§¸ç™¼å™¨å‡½å¼ï¼‰
5. âœ… `is_admin()` - æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
6. âœ… `is_file_owner(UUID)` - æª¢æŸ¥æ˜¯å¦ç‚ºæª”æ¡ˆæ“æœ‰è€…
7. âœ… `is_super_admin()` - æª¢æŸ¥æ˜¯å¦ç‚ºè¶…ç´šç®¡ç†å“¡
8. âœ… `update_updated_at_column()` - è‡ªå‹•æ›´æ–° updated_at æ¬„ä½

### è§¸ç™¼å™¨æ¸…å–®ï¼ˆ6 å€‹ï¼‰

#### Public Schema (5 å€‹)
1. âœ… `update_departments_updated_at` - è‡ªå‹•æ›´æ–° departments.updated_at
2. âœ… `update_user_profiles_updated_at` - è‡ªå‹•æ›´æ–° user_profiles.updated_at
3. âœ… `update_files_updated_at` - è‡ªå‹•æ›´æ–° files.updated_at
4. âœ… `update_agents_updated_at` - è‡ªå‹•æ›´æ–° agents.updated_at
5. âœ… `update_chat_sessions_updated_at` - è‡ªå‹•æ›´æ–° chat_sessions.updated_at

#### Auth Schema (1 å€‹)
1. âœ… `on_auth_user_created` - è‡ªå‹•å»ºç«‹ user_profiles è¨˜éŒ„

---

## ğŸ” Migration æª”æ¡ˆæª¢æŸ¥

### å·²åŸ·è¡Œçš„ Migration æª”æ¡ˆï¼ˆ14 å€‹ï¼‰

1. âœ… `20240101000000_initial_schema.sql` - åˆå§‹è³‡æ–™è¡¨çµæ§‹
2. âœ… `20240101000001_enable_rls.sql` - å•Ÿç”¨ RLS ä¸¦å»ºç«‹åŸºç¤æ”¿ç­–
3. âœ… `20240101000002_fix_rls_recursion.sql` - ä¿®å¾© RLS éè¿´å•é¡Œ
4. âœ… `20240101000003_fix_tags_rls.sql` - ä¿®å¾©æ¨™ç±¤ RLS æ”¿ç­–
5. âœ… `20240101000004_fix_rls_final.sql` - æœ€çµ‚ RLS ä¿®å¾©
6. âœ… `20260101052955_update_agents_rls.sql` - æ›´æ–° Agent RLS
7. âœ… `20260101060000_add_missing_rls_policies.sql` - è£œé½Šç¼ºå°‘çš„ RLS æ”¿ç­–
8. âœ… `20260101070000_add_favorites.sql` - æ–°å¢ä½¿ç”¨è€…æœ€æ„›åŠŸèƒ½
9. âœ… `20260102000000_fix_user_profiles_select_policy.sql` - ä¿®å¾© user_profiles SELECT æ”¿ç­–
10. âœ… `20260102010000_update_agents_rls_with_helpers.sql` - ä½¿ç”¨è¼”åŠ©å‡½å¼å„ªåŒ– Agent RLS
11. âœ… `20260102020000_add_user_profile_trigger.sql` - æ–°å¢ä½¿ç”¨è€…è¨»å†Šè§¸ç™¼å™¨
12. âœ… `20260102030000_fix_rls_security_definer_functions.sql` - ä¿®å¾© SECURITY DEFINER å‡½å¼
13. âœ… `20260103000000_comprehensive_fix_user_profiles_rls.sql` - å…¨é¢ä¿®å¾© user_profiles RLS
14. âœ… `20260104000000_add_user_status_field.sql` - æ–°å¢ä½¿ç”¨è€…ç‹€æ…‹æ¬„ä½
15. âœ… `20260105000000_fix_agents_model_version_default.sql` - ä¿®å¾© agents.model_version é è¨­å€¼
16. âœ… `20260105000001_remove_test_rls_policy.sql` - ç§»é™¤æ¸¬è©¦ç”¨ RLS æ”¿ç­–

---

## ğŸ“ å·²å®Œæˆçš„ä¿®å¾©

### âœ… 1. ä¿®å¾© model_version é è¨­å€¼ä¸ä¸€è‡´

**åŸ·è¡Œå…§å®¹ï¼š**
- âœ… æ›´æ–° `20240101000000_initial_schema.sql` ä¸­çš„é è¨­å€¼ç‚º `'gemini-1.5-pro'`
- âœ… å»ºç«‹ä¸¦åŸ·è¡Œ migration `20260105000000_fix_agents_model_version_default.sql`
- âœ… é©—è­‰è³‡æ–™åº«é è¨­å€¼å·²çµ±ä¸€

### âœ… 2. æ¸…ç†æ¸¬è©¦ç”¨ RLS æ”¿ç­–

**åŸ·è¡Œå…§å®¹ï¼š**
- âœ… å»ºç«‹ä¸¦åŸ·è¡Œ migration `20260105000001_remove_test_rls_policy.sql`
- âœ… æˆåŠŸç§»é™¤ "è¨ºæ–·ï¼šæ¸¬è©¦ä½¿ç”¨è€…è®€å–è‡ªå·±çš„è³‡æ–™" æ”¿ç­–
- âœ… é©—è­‰æ”¿ç­–å·²å®Œå…¨ç§»é™¤

### 3. Migration åŸ·è¡Œç‹€æ…‹

æ‰€æœ‰ migration å·²æŒ‰é †åºåŸ·è¡Œï¼ŒåŒ…æ‹¬æ–°å»ºç«‹çš„å…©å€‹ä¿®å¾© migrationã€‚

---

## âœ… çµè«–

æ•´é«”è€Œè¨€ï¼Œè³‡æ–™åº«çµæ§‹èˆ‡ migration æª”æ¡ˆ**å®Œå…¨ä¸€è‡´**ï¼

**ä¿®å¾©ç‹€æ…‹ï¼š**
- âœ… `agents.model_version` é è¨­å€¼å·²çµ±ä¸€ç‚º `'gemini-1.5-pro'`
- âœ… æ¸¬è©¦ç”¨ RLS æ”¿ç­–å·²ç§»é™¤
- âœ… æ‰€æœ‰ migration æª”æ¡ˆå·²åŒæ­¥æ›´æ–°

**ç•¶å‰ç‹€æ…‹ï¼š**
- æ‰€æœ‰è³‡æ–™è¡¨çµæ§‹æ­£ç¢º
- æ‰€æœ‰ RLS æ”¿ç­–å®Œæ•´ä¸”æ­£ç¢º
- æ‰€æœ‰å‡½å¼å’Œè§¸ç™¼å™¨æ­£å¸¸é‹ä½œ
- Migration æª”æ¡ˆèˆ‡è³‡æ–™åº«å®Œå…¨åŒæ­¥

**æœ€å¾Œæ›´æ–°ï¼š** 2026-01-05

---

**å ±å‘Šç”Ÿæˆå·¥å…·ï¼š** Supabase MCP + æ‰‹å‹•åˆ†æ  
**ä¸‹æ¬¡æª¢æŸ¥å»ºè­°ï¼š** æ¯æ¬¡åŸ·è¡Œæ–°çš„ migration å¾Œé‡æ–°æª¢æŸ¥
