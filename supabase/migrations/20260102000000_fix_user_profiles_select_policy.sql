-- 修復 user_profiles 表的 SELECT 政策
-- 問題：在 20240101000002_fix_rls_recursion.sql 中，刪除了舊政策但沒有重新建立「使用者可讀取自己的資料」
-- 這導致使用者無法查詢自己的 user_profiles 記錄

-- ============================================
-- 1. 檢查並刪除可能存在的重複政策
-- ============================================
DROP POLICY IF EXISTS "使用者可讀取自己的資料" ON user_profiles;

-- ============================================
-- 2. 重新建立「使用者可讀取自己的資料」政策
-- ============================================
-- 這是基礎政策，必須存在，讓使用者可以讀取自己的資料
-- 使用 auth.uid() = id，不需要輔助函式，因為這是最簡單的檢查
CREATE POLICY "使用者可讀取自己的資料" ON user_profiles
  FOR SELECT
  USING (auth.uid() = id);

-- ============================================
-- 3. 確認政策順序（PostgreSQL 會按順序檢查所有匹配的政策）
-- ============================================
-- 現有政策：
-- 1. "使用者可讀取自己的資料" - USING (auth.uid() = id)
-- 2. "超級管理員可讀取所有使用者" - USING (is_super_admin() = true)
-- 3. "部門管理員可讀取部門成員" - USING (get_user_role() = 'DEPT_ADMIN' AND department_id = get_user_dept())
--
-- 政策執行順序：
-- - 如果 auth.uid() = id，第一個政策會匹配（使用者讀取自己的資料）
-- - 如果是 SUPER_ADMIN，第二個政策會匹配（可以讀取所有使用者）
-- - 如果是 DEPT_ADMIN，第三個政策會匹配（可以讀取部門成員）
-- 
-- 這些政策是互斥的（使用 OR 邏輯），所以不會衝突
